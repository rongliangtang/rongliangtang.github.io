<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="è¿™æ˜¯RongLiangçš„åšå®¢,ç”¨æ¥åˆ†äº«æŠ€æœ¯çŸ¥è¯†å’Œä¸€äº›æ„Ÿæ‚Ÿã€‚"><title>åŠ¨æ‰‹ç»ƒä¹  K8s | Tom's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">åŠ¨æ‰‹ç»ƒä¹  K8s</h1><a id="logo" href="/.">Tom's Blog</a><p class="description">é‡è›®ç”Ÿé•¿</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> æ–‡ç« </i></a><a href="/archives/"><i class="fa undefined"> æ€»è§ˆ</i></a><a href="/about/"><i class="fa undefined"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">åŠ¨æ‰‹ç»ƒä¹  K8s</h1><div class="post-meta">2024-08-19</div><div class="post-content"><p>åœ¨ä¸Šç¯‡æ–‡ç« ä¸­ï¼Œç®€å•ä»‹ç»äº† K8s çš„åŸç†ã€‚å•å•é€šè¿‡æ–‡å­—ï¼Œä¸è¶³ä»¥å¸®åŠ©æˆ‘ä»¬å­¦ä¹  K8sã€‚æ‰€ä»¥æœ¬æ–‡é€šè¿‡å®é™…çš„ä¾‹å­ï¼Œç”±æµ…åˆ°æ·±å¸¦å¤§å®¶åœ¨æœ¬åœ°åŠ¨æ‰‹èµ°ä¸€é K8s çš„æ“ä½œæµç¨‹ï¼Œæ—¨åœ¨åŠ æ·±å¯¹ K8s çš„ç†è§£ã€‚</p>
<p>æˆ‘ä»¬å°†ä»æœ€åŸºç¡€çš„ container å®¹å™¨çš„å®šä¹‰å‡ºå‘ï¼ŒåŠ¨æ‰‹å»è·‘ podã€deploymentã€serviceã€ingressã€namespaceã€configmapã€secretã€job ç­‰æ“ä½œçš„æ•™ç¨‹ã€‚<strong>ä¸‹é¢çš„å†…å®¹å¾ˆå¹²ï¼Œè·Ÿç€æ•™ç¨‹èµ°ä¸€éï¼Œç›¸ä¿¡ä½ ä¼šå¤§å¹…å¢åŠ ä½ å¯¹ K8s çš„äº†è§£ã€‚</strong>åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œä¸æ‡‚çš„åŠæ—¶é—® GPT æˆ–è€…æŸ¥å®˜æ–¹æ–‡æ¡£ï¼Œè¿™ä¼šäº‹åŠåŠŸå€ğŸ’ªï¼</p>
<span id="more"></span>

<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p>åœ¨å¼€å§‹åŠ¨æ‰‹ç»ƒä¹ ä¹‹å‰ï¼Œè¯·ç¡®ä¿åœ¨æœ¬åœ°é…ç½®å¥½å¿…è¦çš„ç¯å¢ƒã€‚æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œè®¾ç½®ï¼š</p>
<h3 id="1-å®‰è£…-Docker-Desktop"><a href="#1-å®‰è£…-Docker-Desktop" class="headerlink" title="1. å®‰è£… Docker Desktop"></a>1. å®‰è£… Docker Desktop</h3><p>é¦–å…ˆï¼Œç‚¹å‡»è¿™ä¸ª <a target="_blank" rel="noopener" href="https://www.docker.com/products/docker-desktop">é“¾æ¥</a> ä¸‹è½½ Docker Desktopã€‚å®‰è£…å®Œæˆåï¼Œå¯ä»¥é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éªŒè¯æ˜¯å¦æˆåŠŸå®‰è£…ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>

<h3 id="2-æ­å»ºæœ¬åœ°-K8s-é›†ç¾¤"><a href="#2-æ­å»ºæœ¬åœ°-K8s-é›†ç¾¤" class="headerlink" title="2. æ­å»ºæœ¬åœ° K8s é›†ç¾¤"></a>2. æ­å»ºæœ¬åœ° K8s é›†ç¾¤</h3><p>å»ºè®®ä½¿ç”¨ Minikube æ­å»ºæœ¬åœ° Kubernetes é›†ç¾¤ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹© Kindã€Docker è‡ªå¸¦çš„ K8s ç­‰å·¥å…·ã€‚å¯¹äº macOS ç”¨æˆ·ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿå®‰è£… Minikubeï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install minikube</span><br></pre></td></tr></table></figure>

<p>å¯¹äº Linux å’Œ Windows ç”¨æˆ·ï¼Œè¯·å‚è€ƒ <a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/start">å®˜æ–¹æ•™ç¨‹</a> è¿›è¡Œå®‰è£…ã€‚</p>
<h3 id="3-å¯åŠ¨æœ¬åœ°-K8s-é›†ç¾¤"><a href="#3-å¯åŠ¨æœ¬åœ°-K8s-é›†ç¾¤" class="headerlink" title="3. å¯åŠ¨æœ¬åœ° K8s é›†ç¾¤"></a>3. å¯åŠ¨æœ¬åœ° K8s é›†ç¾¤</h3><p>å®‰è£…å®Œæˆåï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Minikubeï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube start --vm-driver docker --container-runtime=docker</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹æ˜¯ Minikube çš„ä¸€äº›å¸¸ç”¨å‘½ä»¤ï¼š</p>
<ul>
<li><code>minikube stop</code>ï¼šåœæ­¢ VM å’Œ K8s é›†ç¾¤ï¼Œä½†ä¸ä¼šåˆ é™¤ä»»ä½•æ•°æ®ã€‚</li>
<li><code>minikube delete</code>ï¼šåˆ é™¤æ‰€æœ‰ Minikube å¯åŠ¨åçš„æ•°æ®ã€‚</li>
<li><code>minikube ip</code>ï¼šæŸ¥çœ‹é›†ç¾¤å’Œ Docker Engine è¿è¡Œçš„ IP åœ°å€ã€‚</li>
<li><code>minikube pause</code>ï¼šæš‚åœå½“å‰çš„èµ„æºå’Œ K8s é›†ç¾¤ã€‚</li>
<li><code>minikube status</code>ï¼šæŸ¥çœ‹å½“å‰é›†ç¾¤çŠ¶æ€ã€‚</li>
</ul>
<h3 id="4-å®‰è£…-kubectl"><a href="#4-å®‰è£…-kubectl" class="headerlink" title="4. å®‰è£… kubectl"></a>4. å®‰è£… kubectl</h3><p><code>kubectl</code> æ˜¯ç”¨äºæ“ä½œ Kubernetes é›†ç¾¤çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤åœ¨ macOS ä¸Šå¿«é€Ÿå®‰è£… <code>kubectl</code>ï¼Œå…¶ä»–æ“ä½œç³»ç»Ÿçš„ç”¨æˆ·è¯·å‚è€ƒ <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/tools/">å®˜æ–¹æ–‡æ¡£</a> è¿›è¡Œå®‰è£…ã€‚</p>
<h3 id="5-æ³¨å†Œ-Docker-Hub-è´¦å·å¹¶ç™»å½•"><a href="#5-æ³¨å†Œ-Docker-Hub-è´¦å·å¹¶ç™»å½•" class="headerlink" title="5. æ³¨å†Œ Docker Hub è´¦å·å¹¶ç™»å½•"></a>5. æ³¨å†Œ Docker Hub è´¦å·å¹¶ç™»å½•</h3><p>ä¸ºäº†ä¾¿äºå‘å¸ƒ Docker é•œåƒä¾›ä»–äººä¸‹è½½ä½¿ç”¨ï¼Œå¹¶æ”¯æŒ Minikube åç»­ä¸‹è½½é•œåƒï¼Œä½ éœ€è¦åœ¨ <a target="_blank" rel="noopener" href="https://hub.docker.com/">Docker Hub</a> æ³¨å†Œä¸€ä¸ªè´¦å·ã€‚æ³¨å†Œå®Œæˆåï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤ç™»å½•ä½ çš„ Docker Hub è´¦å·ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure>

<p>å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œä½ çš„æœ¬åœ°ç¯å¢ƒå°±é…ç½®å¥½äº†ï¼Œæ¥ä¸‹æ¥å¯ä»¥å¼€å§‹å®è·µ Kubernetes çš„å„ç§æ“ä½œäº†ï¼</p>
<h2 id="åŠ¨æ‰‹ç»ƒä¹ "><a href="#åŠ¨æ‰‹ç»ƒä¹ " class="headerlink" title="åŠ¨æ‰‹ç»ƒä¹ "></a>åŠ¨æ‰‹ç»ƒä¹ </h2><h3 id="ä½¿ç”¨-Docker-æ„å»ºé•œåƒ"><a href="#ä½¿ç”¨-Docker-æ„å»ºé•œåƒ" class="headerlink" title="ä½¿ç”¨ Docker æ„å»ºé•œåƒ"></a>ä½¿ç”¨ Docker æ„å»ºé•œåƒ</h3><h4 id="åˆ›å»ºå¹¶å‘å¸ƒ-Docker-é•œåƒ"><a href="#åˆ›å»ºå¹¶å‘å¸ƒ-Docker-é•œåƒ" class="headerlink" title="åˆ›å»ºå¹¶å‘å¸ƒ Docker é•œåƒ"></a>åˆ›å»ºå¹¶å‘å¸ƒ Docker é•œåƒ</h4><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åŠ¨æ‰‹åˆ›å»ºä¸€ä¸ªç®€å•çš„ Java åº”ç”¨é•œåƒï¼Œå¹¶å°†å…¶å‘å¸ƒåˆ° DockerHub ä»“åº“ï¼Œä»¥ä¾¿åç»­åœ¨ Minikube ä¸­ä¸‹è½½å’Œä½¿ç”¨ã€‚</p>
<p>é¦–å…ˆï¼Œæ–°å»ºä¸€ä¸ªåä¸º <code>HelloKubernetes.java</code> çš„æ–‡ä»¶ï¼Œå¹¶å°†ä»¥ä¸‹ä»£ç å¤åˆ¶åˆ°æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpServer;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloKubernetes</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª HttpServer å®ä¾‹ï¼Œç›‘å¬ç«¯å£ 3000</span></span><br><span class="line">        <span class="type">HttpServer</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">3000</span>), <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼Œå½“è®¿é—®æ ¹è·¯å¾„æ—¶è¿”å›å“åº”</span></span><br><span class="line">        server.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;[v1] Hello, Kubernetes!&quot;</span>;</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">200</span>, response.getBytes().length);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">        server.setExecutor(<span class="literal">null</span>); <span class="comment">// ä½¿ç”¨é»˜è®¤çš„æ‰§è¡Œå™¨</span></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µ Java ä»£ç çš„åŠŸèƒ½éå¸¸ç®€å•ï¼šå¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œç›‘å¬ <code>3000</code> ç«¯å£ï¼Œå¹¶åœ¨è®¿é—®æ ¹è·¯å¾„ <code>/</code> æ—¶è¿”å›å­—ç¬¦ä¸² <code>[v1] Hello, Kubernetes!</code>ã€‚</p>
<p>åœ¨ä¼ ç»Ÿç¯å¢ƒä¸‹ï¼Œè¿è¡Œè¿™æ®µä»£ç éœ€è¦å…ˆå®‰è£… JDKï¼Œç„¶åç¼–è¯‘å¹¶è¿è¡Œã€‚è€Œé€šè¿‡å®¹å™¨æŠ€æœ¯ï¼Œä½ åªéœ€å‡†å¤‡å¥½è¿™æ®µä»£ç å’Œå¯¹åº”çš„ Dockerfileï¼Œå³ä½¿ä½ å¯¹ Java ä¸ç†Ÿæ‚‰ï¼Œä¹Ÿèƒ½é¡ºåˆ©è¿è¡Œè¿™æ®µä»£ç ã€‚</p>
<blockquote>
<p>å®¹å™¨æ˜¯ä¸€ç§åŸºäº Linux æŠ€æœ¯ï¼ˆå¦‚ Namespaceã€Cgroupsã€chroot ç­‰ï¼‰çš„æ²™ç›’ç¯å¢ƒã€‚å¦‚æœä½ æƒ³æ·±å…¥äº†è§£ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ª <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=8fi7uSYlOdc">è§†é¢‘</a>ã€‚</p>
</blockquote>
<h4 id="å‡†å¤‡-Dockerfile"><a href="#å‡†å¤‡-Dockerfile" class="headerlink" title="å‡†å¤‡ Dockerfile"></a>å‡†å¤‡ Dockerfile</h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºä¸Šè¿° Java ä»£ç å‡†å¤‡å¯¹åº”çš„ <code>Dockerfile</code> æ–‡ä»¶ã€‚è¿™ä¸ª <code>Dockerfile</code> ä½¿ç”¨äº†å¤šé˜¶æ®µæ„å»ºçš„æ–¹å¼ã€‚ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯ä½¿ç”¨è½»é‡çº§çš„ <code>openjdk:8-jdk-alpine</code> é•œåƒæ¥ç¼–è¯‘ Java ä»£ç ã€‚ç¬¬äºŒä¸ªé˜¶æ®µåˆ™ä½¿ç”¨ <code>distroless</code> é•œåƒæ¥æé«˜å®‰å…¨æ€§å’Œå‡å°é•œåƒå¤§å°ã€‚å³ä½¿ä½ ä¸ç†è§£ Dockerfile çš„å†…å®¹ï¼Œä¹Ÿä¸ä¼šå½±å“åç»­çš„æ“ä½œã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ OpenJDK 8 çš„ Alpine ä½œä¸ºæ„å»ºé˜¶æ®µçš„åŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå·¥ä½œç›®å½• /src</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨çš„ /src ç›®å½•ä¸­</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ Java æºä»£ç </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> javac HelloKubernetes.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ distroless ä½œä¸ºè¿è¡Œé˜¶æ®µçš„åŸºç¡€é•œåƒï¼Œä»¥æé«˜å®‰å…¨æ€§å’Œå‡å°é•œåƒå¤§å°</span></span><br><span class="line"><span class="keyword">FROM</span> gcr.io/distroless/java-debian10</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å·¥ä½œç›®å½•ä¸ºæ ¹ç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ‰€æœ‰ç¼–è¯‘å¥½çš„å­—èŠ‚ç æ–‡ä»¶åˆ°è¿è¡Œé˜¶æ®µé•œåƒä¸­</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /src/ /app/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç±»è·¯å¾„ï¼Œå¹¶è¿è¡Œåº”ç”¨ç¨‹åº</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-cp&quot;</span>, <span class="string">&quot;/app&quot;</span>, <span class="string">&quot;HelloKubernetes&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²åº”ç”¨ç¨‹åºç›‘å¬çš„ç«¯å£</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>

<p>å°† <code>Dockerfile</code> å’Œ <code>HelloKubernetes.java</code> æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œç„¶åé€šè¿‡ä»¥ä¸‹å‘½ä»¤æ„å»ºé•œåƒã€‚<strong>è¯·æ³¨æ„ï¼Œå°†å…¶ä¸­çš„ <code>tangrl177</code> æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ DockerHub è´¦å·å</strong>ï¼Œä»¥ä¾¿åç»­å°†é•œåƒæ¨é€åˆ°ä½ çš„ DockerHub ä»“åº“ä¸­ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build . -t tangrl177/hellok8s:v1</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥ä½¿ç”¨ <code>docker images</code> å‘½ä»¤æŸ¥çœ‹é•œåƒæ˜¯å¦æ„å»ºæˆåŠŸã€‚ç„¶åï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯åŠ¨å®¹å™¨ï¼Œå…¶ä¸­ <code>-p</code> æŒ‡å®šå°†å®¹å™¨çš„ <code>3000</code> ç«¯å£æ˜ å°„åˆ°ä¸»æœºï¼Œ<code>-d</code> è¡¨ç¤ºåœ¨åå°è¿è¡Œå®¹å™¨ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3000:3000 --name hellok8s -d tangrl177/hellok8s:v1</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Mac çš„ ARM ç³»ç»Ÿï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŒ‡å®š <code>amd64</code> å¹³å°æ¥è¿è¡Œå®¹å™¨ï¼Œä»¥é¿å…æ¶æ„ä¸åŒ¹é…çš„é—®é¢˜ï¼š</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --platform linux/amd64 -p 3000:3000 --name hellok8s -d tangrl177/hellok8s:v1</span><br></pre></td></tr></table></figure>

<p>å®¹å™¨å¯åŠ¨æˆåŠŸåï¼Œä½ å¯ä»¥é€šè¿‡æµè§ˆå™¨æˆ– <code>curl</code> å‘½ä»¤è®¿é—® <code>http://127.0.0.1:3000</code>ï¼ŒéªŒè¯æ˜¯å¦æˆåŠŸè¿”å›å­—ç¬¦ä¸² <code>[v1] Hello, Kubernetes!</code>ã€‚</p>
<p>æœ€åï¼Œä½¿ç”¨ <code>docker push</code> å‘½ä»¤å°†é•œåƒä¸Šä¼ åˆ° DockerHubï¼Œè¿™æ ·ä½ å’Œå…¶ä»–äººéƒ½å¯ä»¥æ–¹ä¾¿åœ°ä¸‹è½½å’Œä½¿ç”¨è¯¥é•œåƒã€‚<strong>å†æ¬¡æé†’ï¼Œå°† <code>tangrl177</code> æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ DockerHub è´¦å·åï¼š</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push tangrl177/hellok8s:v1</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å·²ç»æˆåŠŸåˆ›å»ºå¹¶å‘å¸ƒäº†ä¸€ä¸ª Docker é•œåƒï¼Œä¸ºåç»­åœ¨ Kubernetes ä¸­ä½¿ç”¨åšå¥½äº†å‡†å¤‡ã€‚</p>
<h3 id="ä½¿ç”¨-Pod-éƒ¨ç½²åº”ç”¨"><a href="#ä½¿ç”¨-Pod-éƒ¨ç½²åº”ç”¨" class="headerlink" title="ä½¿ç”¨ Pod éƒ¨ç½²åº”ç”¨"></a>ä½¿ç”¨ Pod éƒ¨ç½²åº”ç”¨</h3><h4 id="Pod-å’Œ-Container-çš„åŒºåˆ«"><a href="#Pod-å’Œ-Container-çš„åŒºåˆ«" class="headerlink" title="Pod å’Œ Container çš„åŒºåˆ«"></a>Pod å’Œ Container çš„åŒºåˆ«</h4><p><code>Pod</code> æ˜¯ Kubernetes ä¸­åˆ›å»ºå’Œç®¡ç†çš„æœ€å°å¯éƒ¨ç½²å•å…ƒï¼Œå®ƒä¸ <code>Container</code> æœ‰ç€å…³é”®çš„åŒºåˆ«ã€‚<code>Pod</code> å¯ä»¥è¿è¡Œå¤šä¸ª <code>Container</code>ï¼Œè€Œ <code>Container</code> çš„æœ¬è´¨æ˜¯è¿›ç¨‹ï¼Œ<code>Pod</code> åˆ™æ˜¯ç”¨äºç®¡ç†è¿™äº›è¿›ç¨‹åŠå…¶èµ„æºçš„å•ä½ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œä¾‹å¦‚æœåŠ¡ä¹‹é—´éœ€è¦è¿›è¡Œæ–‡ä»¶äº¤æ¢ï¼ˆå¦‚æ—¥å¿—æ”¶é›†ï¼‰ï¼Œæˆ–è€…éœ€è¦è¿›è¡Œæœ¬åœ°ç½‘ç»œé€šä¿¡ï¼ˆé€šè¿‡ localhost æˆ– Socket æ–‡ä»¶è¿›è¡Œæœ¬åœ°é€šä¿¡ï¼‰ï¼Œ<code>Pod</code> çš„è¿™ç§å¤šå®¹å™¨ç®¡ç†æ–¹å¼éå¸¸æœ‰ç”¨ã€‚</p>
<h4 id="Pod-ç›¸å…³ç»ƒä¹ -1"><a href="#Pod-ç›¸å…³ç»ƒä¹ -1" class="headerlink" title="Pod ç›¸å…³ç»ƒä¹  1"></a>Pod ç›¸å…³ç»ƒä¹  1</h4><p>é€šè¿‡ä»¥ä¸‹ç»ƒä¹ ï¼Œæˆ‘ä»¬å°†è¿›ä¸€æ­¥ç†è§£ <code>Pod</code> çš„æ¦‚å¿µã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º <code>nginx.yaml</code> çš„æ–‡ä»¶ï¼Œç¼–å†™ç”¨äºè¿è¡Œ <code>nginx</code> å®¹å™¨çš„ <code>Pod</code> å®šä¹‰æ–‡ä»¶ã€‚æ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­ <code>kind</code> è¡¨ç¤ºæˆ‘ä»¬è¦åˆ›å»ºçš„èµ„æºç±»å‹ä¸º <code>Pod</code>ï¼Œ<code>metadata.name</code> ç”¨äºæŒ‡å®š <code>Pod</code> çš„åç§°ï¼Œè¿™ä¸ªåç§°åœ¨é›†ç¾¤ä¸­éœ€è¦å”¯ä¸€ã€‚<code>spec.containers</code> ç”¨äºå®šä¹‰è¿è¡Œçš„å®¹å™¨åç§°åŠå…¶ä½¿ç”¨çš„é•œåƒã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œé•œåƒæ¥æºäº DockerHubã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»º <code>nginx</code> Podï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º nginx Pod</span></span><br><span class="line">kubectl apply -f nginx.yaml</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>kubectl get pods</code> å‘½ä»¤æŸ¥çœ‹ Pod æ˜¯å¦æˆåŠŸå¯åŠ¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ pod æ˜¯å¦æ­£å¸¸å¯åŠ¨</span></span><br><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°† <code>nginx</code> å®¹å™¨çš„é»˜è®¤ <code>80</code> ç«¯å£æ˜ å°„åˆ°æœ¬æœºçš„ <code>4000</code> ç«¯å£ï¼Œæ‰“å¼€æµè§ˆå™¨æˆ–ä½¿ç”¨ <code>curl</code> å‘½ä»¤è®¿é—® <code>http://127.0.0.1:4000</code>ï¼ŒéªŒè¯æ˜¯å¦æˆåŠŸè®¿é—®åˆ° <code>nginx</code> çš„é»˜è®¤é¡µé¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°† nginx é»˜è®¤çš„ 80 ç«¯å£æ˜ å°„åˆ°æœ¬æœºçš„ 4000 ç«¯å£</span></span><br><span class="line">kubectl port-forward nginx-pod 4000:80</span><br></pre></td></tr></table></figure>

<p>ä½ è¿˜å¯ä»¥ä½¿ç”¨ <code>kubectl exec -it</code> å‘½ä»¤è¿›å…¥ Pod å†…éƒ¨çš„å®¹å™¨ Shellï¼Œå¹¶ä¿®æ”¹ <code>nginx</code> çš„é¦–é¡µå†…å®¹ã€‚é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ“ä½œï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿›å…¥ Pod å®¹å™¨çš„ Shell</span></span><br><span class="line">kubectl exec -it nginx-pod /bin/bash</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿›å…¥ Pod å®¹å™¨çš„ Shell åæ‰§è¡Œï¼Œä¿®æ”¹ `nginx` çš„é¦–é¡µå†…å®¹</span></span><br><span class="line">echo &quot;hello kubernetes by nginx!&quot; &gt; /usr/share/nginx/html/index.html</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é€€å‡º Pod å®¹å™¨çš„ Shell å¹¶é‡æ–°æ˜ å°„ç«¯å£</span></span><br><span class="line">exit</span><br><span class="line">kubectl port-forward nginx-pod 4000:80</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†æ¬¡è®¿é—® <code>http://127.0.0.1:4000</code>ï¼Œç¡®ä¿ <code>nginx</code> æˆåŠŸå¯åŠ¨å¹¶è¿”å›è‡ªå®šä¹‰çš„å­—ç¬¦ä¸² <code>hello kubernetes by nginx!</code>ã€‚</p>
<h4 id="Pod-ç›¸å…³ç»ƒä¹ -2"><a href="#Pod-ç›¸å…³ç»ƒä¹ -2" class="headerlink" title="Pod ç›¸å…³ç»ƒä¹  2"></a>Pod ç›¸å…³ç»ƒä¹  2</h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¹‹å‰åœ¨ <code>Container</code> å°èŠ‚ä¸­æ„å»ºçš„ <code>hellok8s:v1</code> é•œåƒï¼Œå‚è€ƒ <code>nginx</code> Pod çš„èµ„æºå®šä¹‰æ–‡ä»¶ï¼Œç¼–å†™ <code>hellok8s:v1</code> Pod çš„èµ„æºå®šä¹‰æ–‡ä»¶ã€‚é€šè¿‡ <code>port-forward</code> å°† Pod çš„ç«¯å£è½¬å‘åˆ°æœ¬åœ° <code>3000</code> ç«¯å£ï¼Œæœ€ç»ˆä½ å°†ä¼šçœ‹åˆ° <code>[v1] Hello, Kubernetes!</code> çš„è¾“å‡ºã€‚</p>
<p>ä»¥ä¸‹æ˜¯ <code>hellok8s:v1 Pod</code> çš„èµ„æºå®šä¹‰æ–‡ä»¶å’Œç›¸åº”çš„å‘½ä»¤ã€‚è¯·æ³¨æ„ï¼Œ<code>tangrl177</code> åº”è¯¥æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ DockerHub è´¦å·åï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:v1</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨å’Œè®¿é—® <code>hellok8s</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hellok8s.yaml</span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl port-forward hellok8s 3000:3000</span><br></pre></td></tr></table></figure>

<h4 id="è§£å†³-Pod-å¯åŠ¨å¤±è´¥"><a href="#è§£å†³-Pod-å¯åŠ¨å¤±è´¥" class="headerlink" title="è§£å†³ Pod å¯åŠ¨å¤±è´¥"></a>è§£å†³ Pod å¯åŠ¨å¤±è´¥</h4><p>å¦‚æœ Pod çš„çŠ¶æ€æ˜¾ç¤ºä¸º <code>ErrImagePull</code> æˆ– <code>ImagePullBackOff</code>ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç½‘ç»œé—®é¢˜å¯¼è‡´æ— æ³•ä» DockerHub æ‹‰å–é•œåƒã€‚æ­¤æ—¶ï¼Œä½ å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è§£å†³é—®é¢˜ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval $(minikube docker-env)</span><br></pre></td></tr></table></figure>

<p>ç„¶åé‡æ–°æ„å»ºé•œåƒï¼Œè€Œæ— éœ€å°†å…¶æ¨é€åˆ° DockerHubã€‚è¿™æ ·ï¼Œæ„å»ºçš„é•œåƒå¯ä»¥ç›´æ¥è¢« Minikube è·å–ï¼Œé¿å…äº† DockerHub æ‹‰å–é•œåƒçš„å»¶è¿Ÿæˆ–å¤±è´¥ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/handbook/pushing/">ä¸Šè¿°è§£å†³æ–¹æ³•æ¥æºäºå®˜æ–¹æ–‡æ¡£</a></p>
<h4 id="Pod-ç›¸å…³å‘½ä»¤"><a href="#Pod-ç›¸å…³å‘½ä»¤" class="headerlink" title="Pod ç›¸å…³å‘½ä»¤"></a>Pod ç›¸å…³å‘½ä»¤</h4><p>ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ <code>kubectl</code> å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ pod æ—¥å¿—</span></span><br><span class="line">kubectl logs --follow nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿›å…¥ pod å†…éƒ¨å®¹å™¨çš„ Shell æˆ–æ‰§è¡Œå®¹å™¨å‘½ä»¤</span>                              </span><br><span class="line">kubectl exec nginx -- ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤ pod èµ„æº</span></span><br><span class="line">kubectl delete pod nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤ pod çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line">kubectl delete -f nginx.yaml</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">å®˜æ–¹æ–‡æ¡£</a> è·å– <code>kubectl</code> æ”¯æŒçš„æ‰€æœ‰å‘½ä»¤ã€‚</p>
<h3 id="ä½¿ç”¨-Deployment-ç®¡ç†åº”ç”¨éƒ¨ç½²"><a href="#ä½¿ç”¨-Deployment-ç®¡ç†åº”ç”¨éƒ¨ç½²" class="headerlink" title="ä½¿ç”¨ Deployment ç®¡ç†åº”ç”¨éƒ¨ç½²"></a>ä½¿ç”¨ Deployment ç®¡ç†åº”ç”¨éƒ¨ç½²</h3><p>åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šç›´æ¥ç®¡ç† Podï¼Œè€Œæ˜¯ä½¿ç”¨ Kubernetes çš„ <code>Deployment</code> èµ„æºæ¥å¸®åŠ©ç®¡ç† Podã€‚<code>Deployment</code> å¯ä»¥æ‰§è¡Œè‡ªåŠ¨æ‰©å®¹ã€è‡ªåŠ¨å‡çº§ç­‰æ“ä½œã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å·²ç»éƒ¨ç½²äº† 10 ä¸ª <code>hellok8s:v1</code> çš„ Podï¼Œéœ€è¦æ‰©å®¹åˆ° 20 ä¸ªï¼Œæˆ–è€…éœ€è¦å°†å®ƒä»¬å‡çº§ä¸º <code>hellok8s:v2</code> ç‰ˆæœ¬ï¼Œé‚£ä¹ˆ <code>Deployment</code> å°†æ˜¯æœ€ä½³é€‰æ‹©ã€‚</p>
<h4 id="è‡ªåŠ¨æ‰©å®¹"><a href="#è‡ªåŠ¨æ‰©å®¹" class="headerlink" title="è‡ªåŠ¨æ‰©å®¹"></a>è‡ªåŠ¨æ‰©å®¹</h4><p><strong>åœ¨è¿›è¡Œä»¥ä¸‹ç»ƒä¹ ä¹‹å‰ï¼Œå»ºè®®é€šè¿‡ <code>kubectl get pods</code> æŸ¥çœ‹å¹¶åˆ é™¤ä¸Šä¸€èŠ‚åˆ›å»ºçš„ Podã€‚å¦‚æœ Pod æ˜¯é€šè¿‡ Deployment åˆ›å»ºçš„ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>kubectl delete deployments xxx</code> åˆ é™¤ç›¸åº”çš„ Deployment èµ„æºã€‚</strong></p>
<p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª <code>deployment.yaml</code> æ–‡ä»¶ï¼Œç”¨æ¥ç®¡ç† <code>hellok8s</code> Podã€‚å…¶ä¸­ï¼Œ<code>kind</code> è¡¨ç¤ºèµ„æºç±»å‹ä¸º <code>Deployment</code>ï¼Œ<code>metadata.name</code> å®šä¹‰äº† Deployment çš„åç§°ï¼Œè¿™ä¸ªåç§°å¿…é¡»<strong>å”¯ä¸€</strong>ã€‚</p>
<p>åœ¨ <code>spec</code> ä¸­ï¼Œ<code>replicas</code> æŒ‡å®š Pod çš„å‰¯æœ¬æ•°é‡ï¼Œ<code>selector</code> å®šä¹‰äº† Deployment å¦‚ä½•å…³è” Podã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>Deployment</code> ä¼šç®¡ç†æ‰€æœ‰ <code>labels=hellok8s</code> çš„ Podã€‚</p>
<p><code>template</code> ç”¨æ¥å®šä¹‰ Pod èµ„æºçš„ç»“æ„ã€‚ä½ ä¼šå‘ç°å®ƒä¸å‰é¢ Hellok8s Pod èµ„æºçš„å®šä¹‰éå¸¸ç›¸ä¼¼ã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œæˆ‘ä»¬åœ¨ <code>template</code> ä¸­æ·»åŠ äº† <code>metadata.labels</code> æ¥ä¸ <code>selector.matchLabels</code> å¯¹åº”ï¼Œæ ‡æ˜ Pod æ˜¯ç”±è¿™ä¸ª Deployment ç®¡ç†çš„ã€‚Deployment ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆ Pod çš„å”¯ä¸€ <code>name</code>ï¼Œæ‰€ä»¥åœ¨ <code>template</code> ä¸­æ— éœ€æ‰‹åŠ¨å®šä¹‰ <code>metadata.name</code>ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">guangzhengli/hellok8s:v1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»º Deployment èµ„æºã€‚ä½ å¯ä»¥é€šè¿‡ <code>get</code> å’Œ <code>delete pod</code> å‘½ä»¤æ¥ä½“éªŒ Deployment çš„åŠŸèƒ½ã€‚<strong>è¯·æ³¨æ„ï¼Œæ¯æ¬¡åˆ›å»ºçš„ Pod åç§°éƒ½ä¼šå˜åŒ–ï¼Œå› æ­¤æŸäº›å‘½ä»¤éœ€è¦æ›¿æ¢ä¸ºä½ å½“å‰ Pod çš„åç§°ã€‚</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º deployment</span></span><br><span class="line">kubectl apply -f deployment.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢ deployment</span></span><br><span class="line">kubectl get deployments</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢ pod çš„ä¿¡æ¯</span></span><br><span class="line">kubectl get pods             </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤æŸä¸ª pod</span></span><br><span class="line">kubectl delete pod hellok8s-deployment-xxx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–æ–°çš„ podï¼Œä½ ä¼šå‘ç°åˆ é™¤ä¸€ä¸ª pod åï¼Œdeployment ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°çš„ pod</span></span><br><span class="line">kubectl get pods                                       </span><br></pre></td></tr></table></figure>

<p>ä½ ä¼šå‘ç°ï¼Œå½“ä½ æ‰‹åŠ¨åˆ é™¤ä¸€ä¸ª <code>Pod</code> èµ„æºåï¼ŒDeployment ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Pod</code>ã€‚è¿™ä¸æˆ‘ä»¬ä¹‹å‰æ‰‹åŠ¨åˆ›å»º Pod èµ„æºçš„æ–¹å¼æœ‰å¾ˆå¤§çš„åŒºåˆ«ğŸ¤¯ï¼è¿™æ„å‘³ç€åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç®¡ç†æˆåƒä¸Šä¸‡ä¸ª Pod æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦é€ä¸ªç®¡ç†ï¼Œåªéœ€ç»´æŠ¤å¥½ <code>deployment.yaml</code> æ–‡ä»¶çš„èµ„æºå®šä¹‰å³å¯ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œé€šè¿‡è‡ªåŠ¨æ‰©å®¹æ¥è¿›ä¸€æ­¥ç†è§£ Deployment çš„ä¼˜åŠ¿ã€‚å½“æˆ‘ä»¬éœ€è¦å°† <code>hellok8s:v1</code> çš„å‰¯æœ¬æ•°é‡æ‰©å®¹åˆ° 3 ä¸ªæ—¶ï¼Œåªéœ€å°† <code>replicas</code> çš„å€¼è®¾ç½®ä¸º 3ï¼Œç„¶åé‡æ–°æ‰§è¡Œ <code>kubectl apply -f deployment.yaml</code>ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">guangzhengli/hellok8s:v1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥åœ¨æ‰§è¡Œ <code>kubectl apply</code> ä¹‹å‰ï¼Œæ–°å»ºä¸€ä¸ªå‘½ä»¤è¡Œçª—å£å¹¶æ‰§è¡Œ <code>kubectl get pods --watch</code>ï¼Œå®æ—¶è§‚å¯Ÿ Pod å¯åŠ¨å’Œåˆ é™¤çš„è¿‡ç¨‹ã€‚å‡å°‘å‰¯æœ¬æ•°çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€å°† <code>replicas</code> çš„å€¼å‡å°‘å³å¯ã€‚</p>
<h4 id="å‡çº§ç‰ˆæœ¬"><a href="#å‡çº§ç‰ˆæœ¬" class="headerlink" title="å‡çº§ç‰ˆæœ¬"></a>å‡çº§ç‰ˆæœ¬</h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰ <code>v1</code> ç‰ˆæœ¬çš„ <code>Pod</code> å‡çº§åˆ° <code>v2</code> ç‰ˆæœ¬ã€‚é¦–å…ˆï¼Œéœ€è¦æ„å»º <code>hellok8s:v2</code> çš„é•œåƒï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å°†å“åº”å­—ç¬¦ä¸²æ›¿æ¢ä¸º <code>[v2] Hello, Kubernetes!</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpServer;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloKubernetes</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª HttpServer å®ä¾‹ï¼Œç›‘å¬ç«¯å£ 3000</span></span><br><span class="line">        <span class="type">HttpServer</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">3000</span>), <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼Œå½“è®¿é—®æ ¹è·¯å¾„æ—¶è¿”å›å“åº”</span></span><br><span class="line">        server.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;[v2] Hello, Kubernetes!&quot;</span>;</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">200</span>, response.getBytes().length);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">        server.setExecutor(<span class="literal">null</span>); <span class="comment">// ä½¿ç”¨é»˜è®¤çš„æ‰§è¡Œå™¨</span></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼ŒæŒ‰ç…§ä¹‹å‰çš„æ­¥éª¤æ„å»ºé•œåƒå¹¶å°†å…¶æ¨é€åˆ° DockerHub ä»“åº“ä¸­ã€‚<strong>è®°å¾—å°† <code>tangrl177</code> æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ DockerHub è´¦å·åã€‚</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ„å»ºé•œåƒ</span></span><br><span class="line">docker build . -t tangrl177/hellok8s:v2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†é•œåƒæ¨é€åˆ° DockerHub ä»“åº“</span></span><br><span class="line">docker push tangrl177/hellok8s:v2</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ï¼Œæ›´æ–° <code>deployment.yaml</code> æ–‡ä»¶ï¼Œä»¥ä½¿ç”¨ <code>v2</code> ç‰ˆæœ¬çš„é•œåƒã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:v2</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ›´æ–°é…ç½®ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ <code>http://localhost:3000</code>ï¼ŒæŸ¥çœ‹è¾“å‡ºæ˜¯å¦å·²æ›´æ–°ä¸º <code>v2</code>ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ›´æ–°é…ç½®</span></span><br><span class="line">kubectl apply -f deployment.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢ pod è¯¦æƒ…</span></span><br><span class="line">kubectl get pods </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ˜ å°„æŸä¸ª pod çš„ç«¯å£ï¼Œæ³¨æ„æ›´æ¢ pod åç§°</span></span><br><span class="line">kubectl port-forward hellok8s-deployment-xxx 3000:3000</span><br></pre></td></tr></table></figure>

<h4 id="æ»šåŠ¨æ›´æ–°"><a href="#æ»šåŠ¨æ›´æ–°" class="headerlink" title="æ»šåŠ¨æ›´æ–°"></a>æ»šåŠ¨æ›´æ–°</h4><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœä½ éœ€è¦ç®¡ç†å¤šä¸ª <code>hellok8s:v1</code> å‰¯æœ¬å¹¶å°†å…¶å‡çº§åˆ° <code>v2</code> ç‰ˆæœ¬ï¼Œç›´æ¥æ›¿æ¢æ‰€æœ‰ Pod çš„æ–¹å¼å¯èƒ½ä¼šå¸¦æ¥é—®é¢˜ã€‚å› ä¸ºè¿™ä¼šå¯¼è‡´æœåŠ¡åœ¨å‡çº§è¿‡ç¨‹ä¸­ä¸å¯ç”¨â€”â€”æ—§ç‰ˆæœ¬çš„ Pod ä¼šè¢«åˆ é™¤ï¼Œè€Œæ–°ç‰ˆæœ¬çš„ Pod å°šæœªå®Œå…¨å°±ç»ªã€‚</p>
<p>è¿™æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨æ»šåŠ¨æ›´æ–°ï¼ˆRolling Updateï¼‰æ¥é€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬çš„ Podï¼Œè€Œä¸å½±å“æœåŠ¡çš„å¯ç”¨æ€§ã€‚åœ¨ <code>Deployment</code> èµ„æºå®šä¹‰ä¸­ï¼Œ<code>spec.strategy.type</code> æœ‰ä¸¤ç§é€‰æ‹©ï¼š</p>
<ul>
<li><strong>RollingUpdate:</strong> é€æ­¥å¢åŠ æ–°ç‰ˆæœ¬çš„ Podï¼ŒåŒæ—¶é€æ­¥å‡å°‘æ—§ç‰ˆæœ¬çš„ Podã€‚</li>
<li><strong>Recreate:</strong> åœ¨å¢åŠ æ–°ç‰ˆæœ¬çš„ Pod ä¹‹å‰ï¼Œå…ˆåˆ é™¤æ‰€æœ‰æ—§ç‰ˆæœ¬çš„ Podã€‚</li>
</ul>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©æ»šåŠ¨æ›´æ–°ï¼ˆRollingUpdateï¼‰ã€‚æ»šåŠ¨æ›´æ–°å¯ä»¥é€šè¿‡ <code>maxSurge</code> å’Œ <code>maxUnavailable</code> å­—æ®µæ¥æ§åˆ¶å‡çº§ Pod çš„é€Ÿç‡ï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<ul>
<li><strong>maxSurge:</strong> æœ€å¤§å³°å€¼ï¼Œç”¨æ¥æŒ‡å®šå¯ä»¥åˆ›å»ºçš„è¶…å‡ºæœŸæœ› Pod ä¸ªæ•°çš„ Pod æ•°é‡ã€‚</li>
<li><strong>maxUnavailable:</strong> æœ€å¤§ä¸å¯ç”¨æ•°é‡ï¼Œç”¨æ¥æŒ‡å®šæ›´æ–°è¿‡ç¨‹ä¸­ä¸å¯ç”¨çš„ Pod çš„ä¸Šé™ã€‚</li>
</ul>
<p>ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å›æ»š Deploymentã€‚é€šè¿‡ç«¯å£æ˜ å°„æµ‹è¯•ï¼ŒéªŒè¯å›æ»šæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å›æ»š deployment</span></span><br><span class="line">kubectl rollout undo deployment hellok8s-deployment</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢ pod è¯¦æƒ…</span></span><br><span class="line">kubectl get pods                                    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢æŸä¸ª pod çš„ä¿¡æ¯ï¼Œæ³¨æ„æ›¿æ¢ pod åç§°</span></span><br><span class="line">kubectl describe pod hellok8s-deployment-xxx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¾“å‡ºåº”åŒ…å« Image: tangrl177/hellok8s:v1</span></span><br></pre></td></tr></table></figure>

<p>é™¤äº†ä¸Šè¿°å‘½ä»¤ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code>history</code> æŸ¥çœ‹å†å²ç‰ˆæœ¬ï¼Œå¹¶é€šè¿‡ <code>--to-revision=2</code> å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout history deployment hellok8s-deployment</span><br><span class="line">kubectl rollout undo deployment/hellok8s-deployment --to-revision=2</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œåœ¨ <code>deployment.yaml</code> æ–‡ä»¶ä¸­è®¾ç½® <code>strategy=rollingUpdate</code>ï¼Œ<code>maxSurge=1</code>ï¼Œ<code>maxUnavailable=1</code>ï¼Œå¹¶å°† <code>replicas</code> è®¾ç½®ä¸º 3ã€‚è¿™æ„å‘³ç€æœ€å¤§å¯èƒ½ä¼šåˆ›å»º 4 ä¸ª <code>hellok8s</code> Podï¼ˆ<code>replicas + maxSurge</code>ï¼‰ï¼Œæœ€å°‘ä¼šæœ‰ 2 ä¸ª &#96;hell</p>
<p>ok8s<code> Pod å­˜æ´»ï¼ˆ</code>replicas - maxUnavailable&#96;ï¼‰ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">     <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:v2</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br></pre></td></tr></table></figure>

<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/rollingupdate-20240820110828004.png" alt="æ»šåŠ¨æ›´æ–°ç¤ºæ„å›¾ï¼ˆå›¾ç‰‡æ¥è‡ªKubernetesç»ƒä¹ æ‰‹å†Œï¼‰" style="zoom:60%;" />

<h4 id="å­˜æ´»æ¢é’ˆ"><a href="#å­˜æ´»æ¢é’ˆ" class="headerlink" title="å­˜æ´»æ¢é’ˆ"></a>å­˜æ´»æ¢é’ˆ</h4><p>å­˜æ´»æ¢é’ˆï¼ˆLiveness Probeï¼‰ç”¨äºæ£€æµ‹å®¹å™¨æ˜¯å¦éœ€è¦é‡å¯ã€‚ä¾‹å¦‚ï¼Œæ¢é’ˆå¯ä»¥æ¢æµ‹åˆ°åº”ç”¨çš„æ­»é”æƒ…å†µï¼ˆåº”ç”¨ç¨‹åºåœ¨è¿è¡Œï¼Œä½†æ— æ³•ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤ï¼‰ã€‚é‡å¯æ­¤ç±»å®¹å™¨æœ‰åŠ©äºæé«˜åº”ç”¨çš„å¯ç”¨æ€§ï¼Œå°½ç®¡å…¶ä¸­å¯èƒ½å­˜åœ¨ç¼ºé™·ã€‚</p>
<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒæŸäº› Bug å¯èƒ½å¯¼è‡´åº”ç”¨æ­»é”æˆ–çº¿ç¨‹è€—å°½ï¼Œæœ€ç»ˆä½¿åº”ç”¨æ— æ³•ç»§ç»­æä¾›æœåŠ¡ã€‚å¦‚æœæ²¡æœ‰æ‰‹æ®µè‡ªåŠ¨ç›‘æ§å’Œå¤„ç†è¿™ç§æƒ…å†µï¼Œé—®é¢˜å¯èƒ½ä¼šæŒç»­å¾ˆé•¿æ—¶é—´è€Œä¸è¢«å‘ç°ã€‚Kubelet ä½¿ç”¨å­˜æ´»æ¢é’ˆæ¥ç¡®å®šä½•æ—¶é‡å¯å®¹å™¨ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ª <code>/health</code> æ¥å£æ¥è¯´æ˜å­˜æ´»æ¢é’ˆçš„å·¥ä½œåŸç†ã€‚è¿™ä¸ªæ¥å£ä¼šåœ¨æœåŠ¡å™¨å¯åŠ¨åçš„ 15 ç§’å†…æ­£å¸¸è¿”å› 200 çŠ¶æ€ç ï¼Œä½†åœ¨ 15 ç§’åå°†ä¸€ç›´è¿”å› 500 çŠ¶æ€ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpServer;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloKubernetes</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// è®°å½•æœåŠ¡å™¨å¯åŠ¨æ—¶é—´</span></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">started</span> <span class="operator">=</span> Instant.now();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª HttpServer å®ä¾‹ï¼Œç›‘å¬ç«¯å£ 3000</span></span><br><span class="line">        <span class="type">HttpServer</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">3000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼Œå½“è®¿é—®æ ¹è·¯å¾„æ—¶è¿”å›å“åº”</span></span><br><span class="line">        server.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;[v2] Hello, Kubernetes!&quot;</span>;</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">200</span>, response.getBytes().length);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼Œå½“è®¿é—® /health æ—¶è¿”å›å¥åº·æ£€æŸ¥ç»“æœ</span></span><br><span class="line">        server.createContext(<span class="string">&quot;/health&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">Duration</span> <span class="variable">duration</span> <span class="operator">=</span> Duration.between(started, Instant.now());</span><br><span class="line">                String response;</span><br><span class="line">                <span class="keyword">if</span> (duration.getSeconds() &gt; <span class="number">15</span>) &#123;</span><br><span class="line">                    response = <span class="string">&quot;error: &quot;</span> + duration.getSeconds();</span><br><span class="line">                    exchange.sendResponseHeaders(<span class="number">500</span>, response.getBytes().length);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    response = <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">                    exchange.sendResponseHeaders(<span class="number">200</span>, response.getBytes().length);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">        server.setExecutor(<span class="literal">null</span>); <span class="comment">// ä½¿ç”¨é»˜è®¤çš„æ‰§è¡Œå™¨</span></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dockerfile å†…å®¹ä¿æŒä¸å˜ã€‚æ„å»ºé•œåƒæ—¶ï¼Œå°† Tag è®¾ç½®ä¸º <code>liveness</code>ï¼Œå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚å¦‚æœé•œåƒæ‹‰å–å¤±è´¥ï¼Œè¯·å‚è€ƒ Pod å°èŠ‚ä¸­çš„ â€œè§£å†³ Pod å¯åŠ¨å¤±è´¥â€ éƒ¨åˆ†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ„å»ºé•œåƒ</span></span><br><span class="line">docker build . -t tangrl177/hellok8s:liveness</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†é•œåƒæ¨é€åˆ° DockerHub</span></span><br><span class="line">docker push tangrl177/hellok8s:liveness</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œç¼–å†™ Deployment çš„å®šä¹‰æ–‡ä»¶ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ HTTP GET è¯·æ±‚æ–¹å¼çš„å­˜æ´»æ¢é’ˆï¼Œæ¢æµ‹åˆšæ‰å®šä¹‰çš„ <code>/health</code> æ¥å£ã€‚<code>periodSeconds</code> å­—æ®µæŒ‡å®š Kubelet æ¯éš” 3 ç§’æ‰§è¡Œä¸€æ¬¡å­˜æ´»æ¢æµ‹ã€‚<code>initialDelaySeconds</code> å­—æ®µå‘Šè¯‰ Kubelet åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰åº”è¯¥ç­‰å¾… 3 ç§’ã€‚å¦‚æœ <code>/health</code> è·¯å¾„è¿”å›æˆåŠŸä»£ç ï¼Œåˆ™ Kubelet è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ã€‚å¦‚æœè¿”å›å¤±è´¥ä»£ç ï¼ŒKubelet ä¼šé‡å¯å®¹å™¨ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">     <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:liveness</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>get</code> æˆ– <code>describe</code> å‘½ä»¤å¯ä»¥å‘ç° Pod ä¸€ç›´å¤„äºé‡å¯çŠ¶æ€ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å›æ»š deployment</span></span><br><span class="line">kubectl rollout undo deployment hellok8s-deployment</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢ pod è¯¦æƒ…</span></span><br><span class="line">kubectl get pods                                    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢æŸä¸ª pod çš„ä¿¡æ¯ï¼Œæ³¨æ„æ›¿æ¢ pod åç§°</span></span><br><span class="line">kubectl describe pod hellok8s-deployment-xxx</span><br></pre></td></tr></table></figure>

<h4 id="å°±ç»ªæ¢é’ˆ"><a href="#å°±ç»ªæ¢é’ˆ" class="headerlink" title="å°±ç»ªæ¢é’ˆ"></a>å°±ç»ªæ¢é’ˆ</h4><p>å°±ç»ªæ¢é’ˆï¼ˆReadiness Probeï¼‰ç”¨äºæ£€æµ‹å®¹å™¨ä½•æ—¶å‡†å¤‡å¥½æ¥æ”¶è¯·æ±‚æµé‡ã€‚<strong>åªæœ‰å½“ä¸€ä¸ª Pod å†…çš„æ‰€æœ‰å®¹å™¨éƒ½å°±ç»ªæ—¶ï¼ŒPod æ‰ä¼šè¢«è§†ä¸ºå°±ç»ª</strong>ã€‚è¿™ç§ä¿¡å·çš„ä¸€ä¸ªç”¨é€”æ˜¯æ§åˆ¶å“ªäº› Pod ä½œä¸º Service çš„åç«¯ã€‚å¦‚æœ Pod å°šæœªå°±ç»ªï¼Œå®ƒå°†ä» Service çš„è´Ÿè½½å‡è¡¡å™¨ä¸­å‰”é™¤ã€‚</p>
<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå‡çº§æœåŠ¡ç‰ˆæœ¬æ˜¯æ—¥å¸¸éœ€æ±‚ã€‚å¦‚æœå‘å¸ƒçš„ç‰ˆæœ¬å­˜åœ¨é—®é¢˜ï¼Œå°±ä¸åº”è¯¥è®©å®ƒå‡çº§æˆåŠŸã€‚Kubelet ä½¿ç”¨å°±ç»ªæ¢é’ˆæ¥æ£€æµ‹å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥å—è¯·æ±‚æµé‡ã€‚å¦‚æœ Pod å‡çº§åä¸èƒ½å°±ç»ªï¼Œåˆ™ä¸åº”è®©æµé‡è¿›å…¥è¯¥ Podï¼Œå¹¶ä¸”é…åˆ <code>rollingUpdate</code> åŠŸèƒ½ï¼Œé˜²æ­¢ä¸ç¨³å®šç‰ˆæœ¬çš„ Pod å‡çº§ã€‚</p>
<p>åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† <code>/health</code> æ¥å£è®¾ç½®ä¸ºå§‹ç»ˆè¿”å› 500 çŠ¶æ€ç ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªæœ‰é—®é¢˜çš„ç‰ˆæœ¬ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpServer;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloKubernetes</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// è®°å½•æœåŠ¡å™¨å¯åŠ¨æ—¶é—´</span></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">started</span> <span class="operator">=</span> Instant.now();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª HttpServer å®ä¾‹ï¼Œç›‘å¬ç«¯å£ 3000</span></span><br><span class="line">        <span class="type">HttpServer</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">3000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼Œå½“è®¿é—®æ ¹è·¯å¾„æ—¶è¿”å›å“åº”</span></span><br><span class="line">        server.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;[v2] Hello, Kubernetes!&quot;</span>;</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">200</span>, response.getBytes().length);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼Œå½“è®¿é—® /health æ—¶è¿”å›å¥åº·æ£€æŸ¥ç»“æœ</span></span><br><span class="line">        server.createContext(<span class="string">&quot;/health&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">500</span>, response.getBytes().length);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">        server.setExecutor(<span class="literal">null</span>); <span class="comment">// ä½¿ç”¨é»˜è®¤çš„æ‰§è¡Œå™¨</span></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dockerfile å†…å®¹ä¿æŒä¸å˜ã€‚æ„å»ºé•œåƒæ—¶ï¼Œå°† Tag è®¾ç½®ä¸º <code>bad</code>ï¼Œå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚å¦‚æœé•œåƒæ‹‰å–å¤±è´¥ï¼Œè¯·å‚è€ƒ Pod å°èŠ‚ä¸­çš„ â€œè§£å†³ Pod å¯åŠ¨å¤±è´¥â€ éƒ¨åˆ†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ„å»ºé•œåƒ</span></span><br><span class="line">docker build . -t tangrl177/hellok8s:bad</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†é•œåƒæ¨é€åˆ° DockerHub</span></span><br><span class="line">docker push tangrl177/hellok8s:bad</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ç¼–å†™ Deployment èµ„æºæ–‡ä»¶ã€‚<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#probe-v1-core">Probe</a> æä¾›äº†è®¸å¤šé…ç½®å­—æ®µï¼Œå¯ä»¥ç”¨æ¥ç²¾ç¡®æ§åˆ¶å°±ç»ªæ¢é’ˆçš„è¡Œä¸ºï¼š</p>
<ul>
<li><code>initialDelaySeconds</code>: å®¹å™¨å¯åŠ¨åç­‰å¾…å¤šå°‘ç§’åæ‰å¯åŠ¨å­˜æ´»å’Œå°±ç»ªæ¢é’ˆï¼Œé»˜è®¤å€¼ä¸º 0 ç§’ï¼Œæœ€å°å€¼ä¸º 0ã€‚</li>
<li><code>periodSeconds</code>: æ¢æµ‹çš„æ—¶é—´é—´éš”ï¼ˆå•ä½ä¸ºç§’ï¼‰ï¼Œé»˜è®¤å€¼ä¸º 10 ç§’ï¼Œæœ€å°å€¼ä¸º 1ã€‚</li>
<li><code>timeoutSeconds</code>: æ¢æµ‹è¶…æ—¶æ—¶çš„ç­‰å¾…æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º 1 ç§’ï¼Œæœ€å°å€¼ä¸º 1ã€‚</li>
<li><code>successThreshold</code>: æ¢æµ‹å¤±è´¥åï¼Œè§†ä¸ºæˆåŠŸçš„æœ€å°è¿ç»­æˆåŠŸæ•°ï¼Œé»˜è®¤å€¼ä¸º 1ã€‚å¯¹äºå­˜æ´»å’Œå¯åŠ¨æ¢é’ˆï¼Œè¿™ä¸ªå€¼å¿…é¡»ä¸º 1ï¼Œæœ€å°</li>
</ul>
<p>å€¼ä¸º 1ã€‚</p>
<ul>
<li><code>failureThreshold</code>: æ¢æµ‹å¤±è´¥æ—¶ Kubernetes çš„é‡è¯•æ¬¡æ•°ã€‚å¯¹äºå­˜æ´»æ¢é’ˆï¼Œæ”¾å¼ƒæ¢æµ‹æ„å‘³ç€é‡æ–°å¯åŠ¨å®¹å™¨ï¼›å¯¹äºå°±ç»ªæ¢é’ˆï¼Œæ”¾å¼ƒæ¢æµ‹æ„å‘³ç€ Pod ä¼šè¢«æ ‡è®°ä¸ºæœªå°±ç»ªã€‚é»˜è®¤å€¼ä¸º 3ï¼Œæœ€å°å€¼ä¸º 1ã€‚</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">     <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:bad</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>get</code> å‘½ä»¤å¯ä»¥å‘ç°ä¸¤ä¸ª Pod ä¸€ç›´å¤„äºæœªå°±ç»ªçŠ¶æ€ã€‚ä½¿ç”¨ <code>describe</code> å‘½ä»¤å¯ä»¥çœ‹åˆ°å¤±è´¥åŸå› æ˜¯ <code>Readiness probe failed: HTTP probe failed with status code: 500</code>ã€‚ç”±äºè®¾ç½®äº† <code>maxUnavailable=1</code>ï¼Œç¡®ä¿å‰©ä½™ä¸¤ä¸ª <code>v2</code> ç‰ˆæœ¬çš„ <code>hellok8s</code> Pod ä»èƒ½ç»§ç»­æä¾›æœåŠ¡ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å›æ»š deployment</span></span><br><span class="line">kubectl rollout undo deployment hellok8s-deployment</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢ pod è¯¦æƒ…</span></span><br><span class="line">kubectl get pods                                    </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥è¯¢æŸä¸ª pod çš„ä¿¡æ¯ï¼Œæ³¨æ„æ›¿æ¢ pod åç§°</span></span><br><span class="line">kubectl describe pod hellok8s-deployment-xxx</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨-Service-ç®¡ç†åº”ç”¨è®¿é—®å’Œè´Ÿè½½å‡è¡¡"><a href="#ä½¿ç”¨-Service-ç®¡ç†åº”ç”¨è®¿é—®å’Œè´Ÿè½½å‡è¡¡" class="headerlink" title="ä½¿ç”¨ Service ç®¡ç†åº”ç”¨è®¿é—®å’Œè´Ÿè½½å‡è¡¡"></a>ä½¿ç”¨ Service ç®¡ç†åº”ç”¨è®¿é—®å’Œè´Ÿè½½å‡è¡¡</h3><p>ç»è¿‡å‰é¢çš„ç»ƒä¹ ï¼Œä½ å¯èƒ½ä¼šæœ‰ä»¥ä¸‹ç–‘é—®ï¼š</p>
<ul>
<li>å½“ Pod æœªå°±ç»ªï¼ˆReadyï¼‰æ—¶ï¼Œ<code>Kubernetes</code> ä¸ºä»€ä¹ˆä¸ä¼šå°†æµé‡é‡å®šå‘åˆ°è¯¥ Podï¼Ÿè¿™æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li>
<li>ä¹‹å‰é€šè¿‡ <code>port-forward</code> å°† Pod çš„ç«¯å£æš´éœ²åˆ°æœ¬åœ°ï¼Œæ—¢éœ€è¦å‡†ç¡®å¡«å†™ Pod çš„åç§°ï¼Œè¿˜è¦é¢å¯¹ Deployment é‡æ–°åˆ›å»ºæ–° Pod æ—¶ï¼ŒPod åç§°å’Œ IP åœ°å€ä¼šéšä¹‹å˜åŒ–çš„é—®é¢˜ã€‚å¦‚ä½•ä¿è¯è®¿é—®åœ°å€çš„ç¨³å®šæ€§ï¼Ÿ</li>
<li>å¦‚æœä½¿ç”¨ Deployment éƒ¨ç½²äº†å¤šä¸ª Pod å‰¯æœ¬ï¼Œå¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ï¼Ÿ</li>
</ul>
<p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œ<code>Kubernetes</code> æä¾›äº†ä¸€ç§åä¸º <code>Service</code> çš„èµ„æºã€‚<code>Service</code> ä¸º Pod æä¾›äº†ä¸€ä¸ªç¨³å®šçš„è®¿é—®ç«¯ç‚¹ï¼ˆEndpointï¼‰ã€‚å®ƒä½äº Pod çš„å‰é¢ï¼Œè´Ÿè´£æ¥æ”¶è¯·æ±‚å¹¶å°†å®ƒä»¬ä¼ é€’ç»™åé¢çš„æ‰€æœ‰ Podã€‚ä¸€æ—¦æœåŠ¡ä¸­çš„ Pod é›†åˆå‘ç”Ÿå˜åŒ–ï¼ŒEndpoints ä¹Ÿä¼šéšä¹‹æ›´æ–°ï¼Œç¡®ä¿è¯·æ±‚æ€»æ˜¯èƒ½å¤Ÿé‡å®šå‘åˆ°æœ€æ–°çš„ Podã€‚</p>
<h4 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h4><p><code>Service</code> é»˜è®¤ä½¿ç”¨ <code>ClusterIP</code> ç±»å‹ã€‚åœ¨è¿›ä¸€æ­¥ç»ƒä¹ ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ä¹‹å‰çš„ <code>hellok8s:v2</code> å‡çº§ä¸º <code>v3</code> ç‰ˆæœ¬ï¼Œå¹¶æ·»åŠ è¿”å›å½“å‰æœåŠ¡æ‰€åœ¨ä¸»æœºåçš„åŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpServer;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloKubernetes</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String hostname;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸»æœºå</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            hostname = InetAddress.getLocalHost().getHostName();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            hostname = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª HttpServer å®ä¾‹ï¼Œç›‘å¬ç«¯å£ 3000</span></span><br><span class="line">        <span class="type">HttpServer</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">3000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼Œå½“è®¿é—®æ ¹è·¯å¾„æ—¶è¿”å›å“åº”</span></span><br><span class="line">        server.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> String.format(<span class="string">&quot;[v3] Hello, Kubernetes!, From host: %s&quot;</span>, hostname);</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">200</span>, response.getBytes().length);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">        server.setExecutor(<span class="literal">null</span>); <span class="comment">// ä½¿ç”¨é»˜è®¤çš„æ‰§è¡Œå™¨</span></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿æŒ Dockerfile ä¸å˜ï¼Œåœ¨æ„å»ºé•œåƒæ—¶å°† Tag è®¾ç½®ä¸º <code>v3</code>ï¼Œå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚å¦‚æœé‡åˆ°é•œåƒæ‹‰å–é—®é¢˜ï¼Œè¯·å‚è€ƒ Pod å°èŠ‚ä¸­çš„â€œè§£å†³ Pod å¯åŠ¨å¤±è´¥â€éƒ¨åˆ†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ„å»ºé•œåƒ</span></span><br><span class="line">docker build . -t tangrl177/hellok8s:v3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">push é•œåƒåˆ° DockerHub</span></span><br><span class="line">docker push tangrl177/hellok8s:v3</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ Deploymentï¼Œå°† <code>hellok8s</code> å‡çº§ä¸º <code>v3</code> ç‰ˆæœ¬ã€‚æ‰§è¡Œ <code>kubectl apply -f deployment.yaml</code> æ›´æ–° Deploymentã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:v3</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br></pre></td></tr></table></figure>

<p>æ¥ç€ï¼Œå®šä¹‰ <code>Service</code> èµ„æºï¼Œä½¿ç”¨ <code>ClusterIP</code> ç±»å‹ã€‚<code>ClusterIP</code> é€šè¿‡é›†ç¾¤å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼Œå½“æˆ‘ä»¬åªéœ€è¦è®©é›†ç¾¤ä¸­è¿è¡Œçš„å…¶ä»–åº”ç”¨ç¨‹åºè®¿é—® Pod æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§ç±»å‹çš„ Serviceã€‚é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª <code>service-hellok8s-clusterip.yaml</code> æ–‡ä»¶ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service-hellok8s-clusterip.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-hellok8s-clusterip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ Endpoints ä¿¡æ¯ã€‚<code>Selector</code> é€‰ä¸­çš„ Pod ç§°ä¸º Service çš„ Endpointsï¼Œå®ƒç»´æŠ¤ç€ Pod çš„ IP åœ°å€ã€‚åªè¦æœåŠ¡ä¸­çš„ Pod é›†åˆå‘ç”Ÿå˜åŒ–ï¼ŒEndpoints å°±ä¼šè¢«æ›´æ–°ã€‚ä½¿ç”¨ <code>kubectl get pod -o wide</code> å¯ä»¥çœ‹åˆ° 3 ä¸ª Pod çš„ IP åœ°å€ä¸ Endpoints ä¸­çš„ä¿¡æ¯ä¿æŒä¸€è‡´ã€‚ä½ å¯ä»¥å°è¯•å¢åŠ æˆ–å‡å°‘ Deployment ä¸­ Pod çš„å‰¯æœ¬æ•°ï¼Œè§‚å¯Ÿ Endpoints æ˜¯å¦éšä¹‹å˜åŒ–ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ›´æ–°é…ç½®</span></span><br><span class="line">kubectl apply -f service-hellok8s-clusterip.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ Endpoints</span></span><br><span class="line">kubectl get endpoints</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ Pod æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ° 3 ä¸ª Pod çš„ IP åœ°å€ä¸ Endpoints ä¿æŒä¸€è‡´</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ Service ä¿¡æ¯</span></span><br><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>é›†ç¾¤å†…çš„å…¶ä»–åº”ç”¨ç¨‹åº</strong>è®¿é—® <code>service-hellok8s-clusterip</code> çš„ IP åœ°å€ï¼Œä»è€Œè®¿é—® <code>hellok8s:v3</code> æœåŠ¡ã€‚</p>
<p>ä½ å¯ä»¥é€šè¿‡æ‰§è¡Œ <code>kubectl apply -f deployment-nginx.yaml</code> åœ¨é›†ç¾¤å†…åˆ›å»ºä¸€ä¸ª <code>nginx</code> æ¥è®¿é—® <code>hellok8s</code> æœåŠ¡ã€‚ç„¶åé€šè¿‡æ‰§è¡Œ <code>kubectl exec -it nginx-pod /bin/bash</code> è¿›å…¥ <code>nginx</code> å®¹å™¨ï¼Œå¹¶ä½¿ç”¨ <code>curl</code> å‘½ä»¤è®¿é—® <code>service-hellok8s-clusterip</code>ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment-nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p>åœ¨å®¹å™¨å†…å¤šæ¬¡æ‰§è¡Œ <code>curl</code>ï¼Œä½ ä¼šå‘ç°è¿”å›çš„ <code>hellok8s:v3</code> hostname ä¸åŒï¼Œè¿™è¡¨æ˜ Service å¯ä»¥æ¥æ”¶è¯·æ±‚å¹¶å°†å®ƒä»¬ä¼ é€’ç»™åé¢çš„æ‰€æœ‰ Podï¼ŒåŒæ—¶è‡ªåŠ¨å®ç°è´Ÿè½½å‡è¡¡ã€‚è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/service-clusterip-fix-name-20240820111257192.png" alt="Service ClusterIP è´Ÿè½½å‡è¡¡ç¤ºæ„å›¾ï¼ˆå›¾ç‰‡æ¥è‡ªKubernetesç»ƒä¹ æ‰‹å†Œï¼‰" style="zoom:60%;" />

<p>Kubernetes <code>ServiceTypes</code> å…è®¸æŒ‡å®š Service ç±»å‹ï¼Œé»˜è®¤æ˜¯ <code>ClusterIP</code>ã€‚å…¶ä»–å¯ç”¨çš„ <code>Type</code> åŒ…æ‹¬ï¼š</p>
<ul>
<li>ClusterIPï¼šé€šè¿‡é›†ç¾¤çš„å†…éƒ¨ IP æš´éœ²æœåŠ¡ï¼Œä»…èƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚è¿™æ˜¯é»˜è®¤çš„ <code>ServiceType</code>ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport">NodePort</a>ï¼šé€šè¿‡æ¯ä¸ªèŠ‚ç‚¹çš„ IP å’Œé™æ€ç«¯å£ï¼ˆ<code>NodePort</code>ï¼‰æš´éœ²æœåŠ¡ã€‚<code>NodePort</code> æœåŠ¡ä¼šè·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ <code>ClusterIP</code> æœåŠ¡ã€‚é€šè¿‡è¯·æ±‚ <code>&lt;èŠ‚ç‚¹ IP&gt;:&lt;èŠ‚ç‚¹ç«¯å£&gt;</code>ï¼Œä½ å¯ä»¥ä»é›†ç¾¤å¤–éƒ¨è®¿é—® <code>NodePort</code> æœåŠ¡ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer">LoadBalancer</a>ï¼šä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ <code>NodePort</code> å’Œ <code>ClusterIP</code> æœåŠ¡ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/#externalname">ExternalName</a>ï¼šé€šè¿‡è¿”å› <code>CNAME</code> å’Œå¯¹åº”å€¼ï¼Œå°†æœåŠ¡æ˜ å°„åˆ° <code>externalName</code> å­—æ®µçš„å†…å®¹ï¼ˆä¾‹å¦‚ <code>foo.bar.example.com</code>ï¼‰ã€‚æ— éœ€åˆ›å»ºä»»ä½•ç±»å‹çš„ä»£ç†ã€‚</li>
</ul>
<h4 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h4><p>æˆ‘ä»¬çŸ¥é“ <code>Kubernetes</code> é›†ç¾¤å¹¶ä¸æ˜¯å•æœºè¿è¡Œï¼Œå®ƒç®¡ç†ç€å¤šå°èŠ‚ç‚¹ï¼ˆ<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/architecture/nodes/">Node</a>ï¼‰ã€‚<code>NodePort</code> ç±»å‹çš„ Service é€šè¿‡æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ IP å’Œé™æ€ç«¯å£ï¼ˆ<code>NodePort</code>ï¼‰æš´éœ²æœåŠ¡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœé›†ç¾¤ä¸­æœ‰ä¸¤å° Node è¿è¡Œç€ <code>hellok8s:v3</code>ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>NodePort</code> ç±»å‹çš„ Serviceï¼Œå°† <code>hellok8s:v3</code> çš„ <code>3000</code> ç«¯å£æ˜ å°„åˆ° Node æœºå™¨çš„ <code>30000</code> ç«¯å£ï¼ˆç«¯å£èŒƒå›´ä¸º 30000-32767ï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¿é—® <code>http://node1-ip:30000</code> æˆ– <code>http://node2-ip:30000</code> æ¥è®¿é—®æœåŠ¡ã€‚</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/service-nodeport-fix-name-20240820111257495.png" alt="NodePort æœåŠ¡æ¶æ„å›¾ï¼ˆå›¾ç‰‡æ¥è‡ªKubernetesç»ƒä¹ æ‰‹å†Œï¼‰" style="zoom:60%;" />

<p>ä»¥ <code>minikube</code> ä¸ºä¾‹ï¼Œä½ å¯ä»¥é€šè¿‡ <code>minikube ip</code> å‘½ä»¤è·å– k8s é›†ç¾¤èŠ‚ç‚¹çš„ IP åœ°å€ã€‚ä¸‹é¢çš„æ•™ç¨‹ä»¥æˆ‘çš„æœ¬æœº IP <code>192.168.49.2</code> ä¸ºä¾‹ï¼Œè¯·æ›¿æ¢æˆä½ è‡ªå·±çš„ IP åœ°å€ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">minikube ip</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">192.168.49.2</span></span><br></pre></td></tr></table></figure>

<p>æ¥ç€ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª NodePort ç±»å‹çš„ Service æ¥æ¥ç®¡ Pod æµé‡ã€‚é€šè¿‡ <code>minikube</code> èŠ‚ç‚¹ä¸Šçš„ IP <code>192.168.49.2</code> æš´éœ²æœåŠ¡ã€‚<code>NodePort</code> æœåŠ¡ä¼šè·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ <code>ClusterIP</code> æœåŠ¡ã€‚é€šè¿‡è¯·æ±‚ <code>&lt;èŠ‚ç‚¹IP&gt;:&lt;èŠ‚ç‚¹ç«¯å£&gt;</code>â€”â€”<code>192.168.49.2:6000</code>ï¼Œä½ å¯ä»¥ä»é›†ç¾¤å¤–éƒ¨è®¿é—® <code>NodePort</code> æœåŠ¡ï¼Œæœ€ç»ˆå°†è¯·æ±‚é‡å®šå‘åˆ° <code>hellok8s:v3</code> çš„ <code>3000</code> ç«¯å£ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service-hellok8s-nodeport.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-hellok8s-nodeport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">6000</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»º <code>service-hellok8s-nodeport</code> Service åï¼Œä½¿ç”¨ <code>curl</code> å‘½ä»¤æˆ–æµè§ˆå™¨è®¿é—® <code>http://192.168.49.2:6000</code> å¯ä»¥å¾—åˆ°ç»“æœã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f service-hellok8s-nodeport.yaml</span><br><span class="line">kubectl get service</span><br><span class="line">kubectl get pods</span><br><span class="line">curl http://192.168.49.2:6000</span><br><span class="line">curl http://192.168.49.2:6000</span><br><span class="line">curl http://192.168.49.2:6000</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Docker Desktopï¼ˆ<code>minikube start --driver=docker</code>ï¼‰ï¼Œå¯èƒ½æ— æ³•é€šè¿‡ <code>minikube ip</code> è·å–çš„ IP åœ°å€è®¿é—®æœåŠ¡ï¼Œå› ä¸º Docker çš„ç½‘ç»œé™åˆ¶å¯¼è‡´æ— æ³•ç›´æ¥è¿æ¥ Docker å®¹å™¨ã€‚è¿™æ„å‘³ç€ NodePort ç±»å‹çš„ Service å’Œ Ingress ç»„ä»¶éƒ½æ— æ³•é€šè¿‡ <code>minikube ip</code> æä¾›çš„ IP åœ°å€è®¿é—®ã€‚æ­¤æ—¶ï¼Œå¯ä»¥é€šè¿‡ <code>minikube service service-hellok8s-nodeport --url</code> æ¥å…¬å¼€æœåŠ¡ï¼Œç„¶åä½¿ç”¨ <code>curl</code> æˆ–æµè§ˆå™¨è®¿é—®ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">minikube service service-hellok8s-nodeport --url</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¾“å‡º http://127.0.0.1:54724</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å› ä¸ºä½ åœ¨ Windows ä¸Šä½¿ç”¨ Docker driverï¼Œç»ˆç«¯éœ€è¦ä¿æŒæ‰“å¼€çŠ¶æ€ã€‚</span></span><br><span class="line">curl http://127.0.0.1:54724</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[v3] Hello, Kubernetes!, From host: hellok8s-deployment-559cfdd58c-zp2pc</span></span><br><span class="line">curl http://127.0.0.1:54724</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[v3] Hello, Kubernetes!, From host: hellok8s-deployment-559cfdd58c-2j2x2</span></span><br></pre></td></tr></table></figure>

<h4 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h4><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer"><code>LoadBalancer</code></a> ç±»å‹çš„ Service ä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å‡è¡¡å™¨å‘å¤–éƒ¨æš´éœ²æœåŠ¡ã€‚å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å°†æµé‡è·¯ç”±åˆ°è‡ªåŠ¨åˆ›å»ºçš„ <code>NodePort</code> å’Œ <code>ClusterIP</code> æœåŠ¡ã€‚å¦‚æœä½ åœ¨ <a target="_blank" rel="noopener" href="https://aws.amazon.com/">AWS</a> çš„ <a target="_blank" rel="noopener" href="https://aws.amazon.com/eks/">EKS</a> é›†ç¾¤ä¸Šåˆ›å»ºä¸€ä¸ª <code>LoadBalancer</code> ç±»å‹çš„ Serviceï¼ŒKubernetes ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª ELBï¼ˆ<a target="_blank" rel="noopener" href="https://aws.amazon.com/elasticloadbalancing">Elastic Load Balancer</a>ï¼‰ï¼Œå¹¶ä»é…ç½®çš„ IP æ± ä¸­åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„ IP åœ°å€ä¾›å¤–éƒ¨è®¿é—®ã€‚</p>
<p>ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>minikube</code>ï¼Œå¯ä»¥é€šè¿‡ <code>minikube tunnel</code> æ¥æ¨¡æ‹Ÿåˆ›å»º LoadBalancer çš„ <code>EXTERNAL_IP</code>ã€‚å…·ä½“æ•™ç¨‹å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/handbook/accessing/#loadbalancer-access">å®˜ç½‘æ–‡æ¡£</a>ã€‚ä¸è¿‡ï¼Œminikube æ¨¡æ‹Ÿçš„ LoadBalancer ä¸å®é™…äº‘æä¾›å•†æä¾›çš„ LoadBalancer æœ‰æœ¬è´¨åŒºåˆ«ã€‚å¦‚æœä½ æœ‰æ¡ä»¶ï¼Œå¯ä»¥åœ¨ <a target="_blank" rel="noopener" href="https://aws.amazon.com/">AWS</a> çš„ <a target="_blank" rel="noopener" href="https://aws.amazon.com/eks/">EKS</a> é›†ç¾¤ä¸Šåˆ›å»ºä¸€ä¸ª ELB è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>ä¸‹å›¾æ˜¾ç¤ºäº† LoadBalancer çš„ Service æ¶æ„ã€‚</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/service-loadbalancer-fix-name-20240820111257643.png" alt="LoadBalancer æœåŠ¡æ¶æ„å›¾ï¼ˆå›¾ç‰‡æ¥è‡ªKubernetesç»ƒä¹ æ‰‹å†Œï¼‰" style="zoom:60%;" />

<h3 id="ä½¿ç”¨-Ingress-ç®¡ç†å¤–éƒ¨æµé‡è·¯ç”±"><a href="#ä½¿ç”¨-Ingress-ç®¡ç†å¤–éƒ¨æµé‡è·¯ç”±" class="headerlink" title="ä½¿ç”¨ Ingress ç®¡ç†å¤–éƒ¨æµé‡è·¯ç”±"></a>ä½¿ç”¨ Ingress ç®¡ç†å¤–éƒ¨æµé‡è·¯ç”±</h3><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#ingress-v1beta1-networking-k8s-io">Ingress</a> èµ„æºç”¨äºå…¬å¼€ä»é›†ç¾¤å¤–éƒ¨åˆ°é›†ç¾¤å†…éƒ¨ <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a> çš„ HTTP å’Œ HTTPS è·¯ç”±ã€‚æµé‡çš„è·¯ç”±ç”± Ingress èµ„æºä¸Šå®šä¹‰çš„è§„åˆ™æ§åˆ¶ã€‚é€šè¿‡ Ingressï¼Œå¯ä»¥ä¸º Service æä¾›å¤–éƒ¨å¯è®¿é—®çš„ URLã€è´Ÿè½½å‡è¡¡æµé‡ã€SSL&#x2F;TLS æ”¯æŒä»¥åŠåŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºã€‚ä¸è¿‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ å¿…é¡»æ‹¥æœ‰ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers">Ingress æ§åˆ¶å™¨</a> æ‰èƒ½ä½¿ Ingress ç”Ÿæ•ˆã€‚ä»…åˆ›å»º Ingress èµ„æºæœ¬èº«ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœã€‚Ingress æ§åˆ¶å™¨é€šå¸¸è´Ÿè´£é€šè¿‡è´Ÿè½½å‡è¡¡å™¨å®ç° Ingressï¼Œä¾‹å¦‚ <code>minikube</code> é»˜è®¤ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/tutorials/nginx_tcp_udp_ingress/">nginx-ingress</a>ï¼Œæ­¤å¤– <code>minikube</code> è¿˜æ”¯æŒ <a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/handbook/addons/kong-ingress/">Kong-Ingress</a>ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼ŒIngress å¯ä»¥è¢«è§†ä¸ºæœåŠ¡çš„ç½‘å…³ï¼ˆGatewayï¼‰ï¼Œå®ƒæ˜¯é›†ç¾¤ä¸­æ‰€æœ‰æµé‡çš„å…¥å£ï¼Œå¹¶æ ¹æ®é…ç½®çš„è·¯ç”±è§„åˆ™ï¼Œå°†æµé‡é‡å®šå‘åˆ°åç«¯çš„æœåŠ¡ã€‚</p>
<p>åœ¨ <code>minikube</code> ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ç”¨ Ingress æ§åˆ¶å™¨åŠŸèƒ½ï¼Œé»˜è®¤ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/tutorials/nginx_tcp_udp_ingress/">nginx-ingress</a>ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube addons enable ingress</span><br></pre></td></tr></table></figure>

<p><strong>æ¥ä¸‹æ¥åˆ é™¤ä¹‹å‰åˆ›å»ºçš„æ‰€æœ‰ <code>Pod</code>ã€<code>Deployment</code> å’Œ <code>Service</code> èµ„æºã€‚</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployment,service --all</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼ŒæŒ‰ç…§ä¹‹å‰çš„æ•™ç¨‹ï¼Œé‡æ–°åˆ›å»º <code>hellok8s:v3</code> å’Œ <code>nginx</code> çš„ <code>Deployment</code> å’Œ <code>Service</code> èµ„æºï¼ŒService çš„ç±»å‹è®¾ä¸º <code>ClusterIP</code>ã€‚</p>
<p><code>hellok8s:v3</code> çš„ç«¯å£æ˜ å°„ä¸º <code>3000:3000</code>ï¼Œ<code>nginx</code> çš„ç«¯å£æ˜ å°„ä¸º <code>4000:80</code>ï¼Œè¿™äº›ç«¯å£æ˜ å°„å°†åœ¨åç»­ç¼–å†™ Ingress è·¯ç”±è§„åˆ™æ—¶ä½¿ç”¨ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-hellok8s-clusterip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">guangzhengli/hellok8s:v3</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-nginx-clusterip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">4000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-container</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hellok8s.yaml </span><br><span class="line">kubectl apply -f nginx.yaml </span><br><span class="line">kubectl get pods   </span><br><span class="line">kubectl get service</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œé›†ç¾¤ä¸­æœ‰ 3 ä¸ª <code>hellok8s:v3</code> çš„ Pod å’Œ 2 ä¸ª <code>nginx</code> çš„ Podã€‚<code>hellok8s:v3</code> çš„ç«¯å£æ˜ å°„ä¸º <code>3000:3000</code>ï¼Œ<code>nginx</code> çš„ç«¯å£æ˜ å°„ä¸º <code>4000:80</code>ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†ç¼–å†™ Ingress èµ„æºå®šä¹‰ï¼Œå…¶ä¸­ <code>nginx.ingress.kubernetes.io/ssl-redirect: &quot;false&quot;</code> è¡¨ç¤ºå…³é—­ HTTPS è¿æ¥ï¼Œä»…ä½¿ç”¨ HTTP è¿æ¥ã€‚</p>
<p>æˆ‘ä»¬å°†åŒ¹é…å‰ç¼€ä¸º <code>/hello</code> çš„è·¯ç”±è§„åˆ™ï¼Œé‡å®šå‘åˆ° <code>hellok8s:v3</code> æœåŠ¡ï¼›åŒ¹é…å‰ç¼€ä¸º <code>/</code> çš„æ ¹è·¯å¾„ï¼Œå°†æµé‡é‡å®šå‘åˆ° <code>nginx</code> æœåŠ¡ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># è¯¥æ³¨è§£ç”¨äºæš‚æ—¶å…³é—­ nginx çš„ https é‡å®šå‘</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/hello</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">service-hellok8s-clusterip</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">3000</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">service-nginx-clusterip</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">4000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingress.yaml</span><br><span class="line">kubectl get ingress          </span><br><span class="line">curl http://192.168.49.2/hello</span><br><span class="line">curl http://192.168.49.2/</span><br></pre></td></tr></table></figure>

<p>å’Œ <code>Service</code> ç±»ä¼¼ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Docker Desktopï¼ˆ<code>minikube start --driver=docker</code>ï¼‰ï¼Œå¯èƒ½æ— æ³•é€šè¿‡ <code>minikube ip</code> è·å–çš„ IP åœ°å€è®¿é—®æœåŠ¡ã€‚ä½ å¯ä»¥å…ˆé€šè¿‡ <code>minikube service list</code> æŸ¥çœ‹æœåŠ¡åˆ—è¡¨ï¼Œç„¶åä½¿ç”¨ <code>minikube service ingress-nginx-controller -n ingress-nginx --url</code> æ¥å…¬å¼€æœåŠ¡ï¼Œå†é€šè¿‡ <code>curl</code> æˆ–æµè§ˆå™¨è®¿é—®ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">minikube service list</span><br><span class="line">minikube service ingress-nginx-controller -n ingress-nginx --url</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¾“å‡ºå¦‚ä¸‹</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://127.0.0.1:55201	http</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://127.0.0.1:55202	https</span></span><br><span class="line">curl http://127.0.0.1:55201/hello</span><br><span class="line">curl http://127.0.0.1:55201/</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰æµé‡å‘é€åˆ° Ingress ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/ingress-20240820111904568.png" alt="Ingress æµé‡ç¤ºæ„å›¾ï¼ˆå›¾ç‰‡æ¥è‡ªKubernetesç»ƒä¹ æ‰‹å†Œï¼‰" style="zoom:60%;" />

<h3 id="ä½¿ç”¨-Namespace-éš”ç¦»ä¸åŒç¯å¢ƒçš„èµ„æº"><a href="#ä½¿ç”¨-Namespace-éš”ç¦»ä¸åŒç¯å¢ƒçš„èµ„æº" class="headerlink" title="ä½¿ç”¨ Namespace éš”ç¦»ä¸åŒç¯å¢ƒçš„èµ„æº"></a>ä½¿ç”¨ Namespace éš”ç¦»ä¸åŒç¯å¢ƒçš„èµ„æº</h3><p>åœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä¸ºä¸åŒçš„ç¯å¢ƒè®¾ç½®ç‹¬ç«‹çš„èµ„æºé…ç½®ï¼Œä¾‹å¦‚ <code>dev</code> ç¯å¢ƒä¾›å¼€å‘ä½¿ç”¨ï¼Œ<code>test</code> ç¯å¢ƒä¾› QA ä½¿ç”¨ã€‚è¿™æ ·å¯ä»¥ä¿è¯å„ä¸ªç¯å¢ƒçš„èµ„æºäº’ç›¸éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°ã€‚é‚£ä¹ˆï¼ŒKubernetes æ˜¯å¦å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ä¸åŒç¯å¢ƒï¼ˆå¦‚ <code>dev</code>ã€<code>test</code>ã€<code>uat</code>ã€<code>prod</code>ï¼‰ä¸­åŒºåˆ†èµ„æºï¼Œä½¿å¾—å®ƒä»¬ç‹¬ç«‹å­˜åœ¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼ŒKubernetes æä¾›äº†ä¸€ç§åä¸º Namespace çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°èµ„æºéš”ç¦»ã€‚</p>
<p>åœ¨ Kubernetes ä¸­ï¼Œ<strong>å‘½åç©ºé—´ï¼ˆNamespaceï¼‰</strong> æ˜¯ä¸€ç§å°†åŒä¸€é›†ç¾¤ä¸­çš„èµ„æºåˆ’åˆ†ä¸ºç›¸äº’éš”ç¦»çš„ç»„çš„æœºåˆ¶ã€‚åŒä¸€ä¸ªå‘½åç©ºé—´å†…çš„èµ„æºåç§°å¿…é¡»å”¯ä¸€ï¼Œä½†è·¨å‘½åç©ºé—´æ—¶åˆ™æ²¡æœ‰è¿™ä¸ªé™åˆ¶ã€‚å‘½åç©ºé—´ä¸»è¦ä½œç”¨äºå¸¦æœ‰å‘½åç©ºé—´å±æ€§çš„å¯¹è±¡ï¼Œä¾‹å¦‚ Deploymentã€Service ç­‰ã€‚</p>
<p>åœ¨ä¹‹å‰çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬é»˜è®¤ä½¿ç”¨çš„æ˜¯ <code>default</code> å‘½åç©ºé—´ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•åˆ›å»ºæ–°çš„å‘½åç©ºé—´ï¼Œä»¥åŠå¦‚ä½•åœ¨è¿™äº›å‘½åç©ºé—´ä¸‹ç®¡ç†èµ„æºã€‚</p>
<p>é¦–å…ˆï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªå®šä¹‰äº†ä¸¤ä¸ªä¸åŒå‘½åç©ºé—´ï¼ˆ<code>dev</code> å’Œ <code>test</code>ï¼‰çš„ <code>namespace.yaml</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># namespaces.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºè¿™ä¸¤ä¸ªæ–°çš„å‘½åç©ºé—´ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f namespaces.yaml  </span><br><span class="line">kubectl get namespaces </span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬å°±æœ‰äº† <code>dev</code> å’Œ <code>test</code> ä¸¤ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ã€‚é‚£ä¹ˆå¦‚ä½•åœ¨è¿™äº›å‘½åç©ºé—´ä¸‹åˆ›å»ºèµ„æºå¹¶è·å–èµ„æºå‘¢ï¼Ÿåªéœ€è¦åœ¨å‘½ä»¤åé¢åŠ ä¸Š <code>-n &lt;namespace&gt;</code> å‚æ•°å³å¯ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>dev</code> å‘½åç©ºé—´ä¸‹åˆ›å»º <code>hellok8s:v3</code> çš„ Deployment èµ„æºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deployment.yaml -n dev</span><br><span class="line">kubectl get pods -n dev</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒKubernetes çš„ Namespace èƒ½å¤Ÿæœ‰æ•ˆåœ°å¸®åŠ©æˆ‘ä»¬åœ¨ä¸åŒç¯å¢ƒä¸­éš”ç¦»èµ„æºï¼Œä½¿å¾— <code>dev</code>ã€<code>test</code>ã€<code>uat</code>ã€<code>prod</code> ç­‰ç¯å¢ƒçš„èµ„æºèƒ½å¤Ÿç‹¬ç«‹ç®¡ç†ï¼Œäº’ä¸å½±å“ã€‚</p>
<h3 id="ä½¿ç”¨-ConfigMap-ç®¡ç†ç¯å¢ƒé…ç½®"><a href="#ä½¿ç”¨-ConfigMap-ç®¡ç†ç¯å¢ƒé…ç½®" class="headerlink" title="ä½¿ç”¨ ConfigMap ç®¡ç†ç¯å¢ƒé…ç½®"></a>ä½¿ç”¨ ConfigMap ç®¡ç†ç¯å¢ƒé…ç½®</h3><p>åœ¨å‰é¢çš„å†…å®¹ä¸­æˆ‘ä»¬æåˆ°è¿‡ï¼Œåœ¨ä¸åŒçš„ç¯å¢ƒï¼ˆå¦‚ <code>dev</code>ã€<code>test</code>ã€<code>uat</code>ã€<code>prod</code>ï¼‰ä¸­åŒºåˆ†èµ„æºï¼Œå¯ä»¥ä½¿å„ç¯å¢ƒçš„èµ„æºç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ã€‚ç„¶è€Œï¼Œè¿™ä¹Ÿå¸¦æ¥äº†ä¸€äº›æ–°çš„æŒ‘æˆ˜ã€‚ä¾‹å¦‚ï¼Œä¸åŒç¯å¢ƒçš„æ•°æ®åº“åœ°å€é€šå¸¸æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¦‚æœåœ¨ä»£ç ä¸­å†™æ­»åŒä¸€ä¸ªæ•°æ®åº“åœ°å€ï¼Œå°±ä¼šå¯¼è‡´é—®é¢˜ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒKubernetes æä¾›äº† ConfigMapï¼Œå°†é…ç½®ä¿¡æ¯ä¸åº”ç”¨ç¨‹åºä»£ç åˆ†ç¦»ã€‚ConfigMap ç”¨äºä¿å­˜éæœºå¯†æ€§çš„é”®å€¼å¯¹æ•°æ®ï¼Œæ–¹ä¾¿åœ¨ä¸åŒç¯å¢ƒä¸­çµæ´»é…ç½®ã€‚ä¾‹å¦‚ï¼Œä¸åŒç¯å¢ƒçš„æ•°æ®åº“åœ°å€å¯ä»¥é€šè¿‡ ConfigMap æ¥ç®¡ç†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒConfigMap è®¾è®¡ä¸Šä¸æ˜¯ç”¨æ¥ä¿å­˜å¤§é‡æ•°æ®çš„ï¼Œå®ƒä¿å­˜çš„æ•°æ®ä¸èƒ½è¶…è¿‡ 1 MiBã€‚å¦‚æœéœ€è¦ä¿å­˜æ›´å¤§çš„æ•°æ®é‡ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å­˜å‚¨å·ï¼ˆVolumeï¼‰ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ ConfigMap å‡è®¾ä¸åŒç¯å¢ƒçš„æ•°æ®åº“åœ°å€ä¸åŒã€‚æˆ‘ä»¬å°†ä¿®æ”¹ä¹‹å‰çš„ä»£ç ï¼Œè®©å®ƒä»ç¯å¢ƒå˜é‡ä¸­è·å– <code>DB_URL</code> å¹¶è¿”å›è¯¥å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpServer;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloKubernetes</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String hostname;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String dbURL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸»æœºå</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            hostname = InetAddress.getLocalHost().getHostName();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            hostname = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ç¯å¢ƒå˜é‡ä¸­çš„æ•°æ®åº“è¿æ¥ URL</span></span><br><span class="line">        dbURL = System.getenv(<span class="string">&quot;DB_URL&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (dbURL == <span class="literal">null</span>) &#123;</span><br><span class="line">            dbURL = <span class="string">&quot;not set&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª HttpServer å®ä¾‹ï¼Œç›‘å¬ç«¯å£ 3000</span></span><br><span class="line">        <span class="type">HttpServer</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">3000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šä¹‰å¤„ç†å‡½æ•°ï¼Œå½“è®¿é—®æ ¹è·¯å¾„æ—¶è¿”å›å“åº”</span></span><br><span class="line">        server.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> String.format(<span class="string">&quot;[v4] Hello, Kubernetes! From host: %s, Get Database Connect URL: %s&quot;</span>, hostname, dbURL);</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">200</span>, response.getBytes().length);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">        server.setExecutor(<span class="literal">null</span>); <span class="comment">// ä½¿ç”¨é»˜è®¤çš„æ‰§è¡Œå™¨</span></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ„å»ºé•œåƒæ—¶ï¼Œä¿æŒ Dockerfile ä¸å˜ï¼Œå°† <code>tag</code> è®¾ç½®ä¸º <code>v4</code>ï¼Œå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚å¦‚æœé‡åˆ°é•œåƒæ‹‰å–é—®é¢˜ï¼Œè¯·å‚è€ƒ Pod å°èŠ‚ä¸­çš„â€œè§£å†³ Pod å¯åŠ¨å¤±è´¥â€éƒ¨åˆ†ã€‚åŒæ—¶ï¼Œåˆ é™¤ä¹‹å‰æ‰€æœ‰çš„èµ„æºã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ„å»ºé•œåƒ</span></span><br><span class="line">docker build . -t tangrl177/hellok8s:v4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> push åˆ°è¿œç¨‹ä»“åº“</span></span><br><span class="line">docker push tangrl177/hellok8s:v4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤ä¹‹å‰æ‰€æœ‰èµ„æº</span></span><br><span class="line">kubectl delete pod,deployment,service,ingress --all</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ä¸åŒçš„ namespace ä¸­åˆ›å»º ConfigMap æ¥å­˜æ”¾ <code>DB_URL</code>ã€‚</p>
<p>é¦–å…ˆï¼Œåˆ›å»º <code>hellok8s-config-dev.yaml</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s-config-dev.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">DB_URL:</span> <span class="string">&quot;http://DB_ADDRESS_DEV&quot;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œåˆ›å»º <code>hellok8s-config-test.yaml</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s-config-test.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">DB_URL:</span> <span class="string">&quot;http://DB_ADDRESS_TEST&quot;</span></span><br></pre></td></tr></table></figure>

<p>åˆ†åˆ«åœ¨ä¸Šä¸€èŠ‚åˆ›å»ºçš„ <code>dev</code> å’Œ <code>test</code> ä¸¤ä¸ª namespace ä¸­åˆ›å»ºç›¸åŒåç§°çš„ ConfigMapï¼Œåç§°éƒ½å« <code>hellok8s-config</code>ï¼Œä½†å­˜æ”¾çš„é”®å€¼å¯¹ä¸­çš„å€¼ä¸åŒã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ dev namespace ä¸­åˆ›å»º ConfigMap</span></span><br><span class="line">kubectl apply -f hellok8s-config-dev.yaml -n dev</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨ <span class="built_in">test</span> namespace ä¸­åˆ›å»º ConfigMap</span></span><br><span class="line">kubectl apply -f hellok8s-config-test.yaml -n test </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è·å–æ‰€æœ‰å‘½åç©ºé—´çš„ ConfigMap ä¿¡æ¯</span></span><br><span class="line">kubectl get configmap --all-namespaces</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ Pod éƒ¨ç½² <code>hellok8s:v4</code>ï¼Œå¹¶é€šè¿‡ ConfigMap é…ç½®ç¯å¢ƒå˜é‡ã€‚<code>env.name</code> è¡¨ç¤ºå°† ConfigMap ä¸­çš„å€¼å†™å…¥ç¯å¢ƒå˜é‡ï¼Œä½¿ä»£ç èƒ½å¤Ÿä»ç¯å¢ƒå˜é‡ä¸­è·å– <code>DB_URL</code>ã€‚<code>valueFrom</code> è¡¨ç¤ºä»å“ªé‡Œè¯»å–é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨ <code>configMapKeyRef</code> è¡¨ç¤ºä»åä¸º <code>hellok8s-config</code> çš„ ConfigMap ä¸­è¯»å– <code>DB_URL</code> çš„å€¼ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:v4</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">hellok8s-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">DB_URL</span></span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œåœ¨ <code>dev</code> å’Œ <code>test</code> ä¸¤ä¸ª namespace ä¸­åˆ†åˆ«åˆ›å»º <code>hellok8s:v4</code> Podã€‚ç„¶åï¼Œé€šè¿‡ <code>port-forward</code> çš„æ–¹å¼è®¿é—®ä¸åŒ namespace çš„æœåŠ¡ï¼Œä½ ä¼šå‘ç°è¿”å›çš„ <code>Get Database Connect URL</code> å¯¹åº”ä¸åŒçš„ç¯å¢ƒå€¼ï¼Œä¾‹å¦‚ <code>http://DB_ADDRESS_DEV</code> å’Œ <code>http://DB_ADDRESS_TEST</code>ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f hellok8s.yaml -n dev             </span><br><span class="line">kubectl apply -f hellok8s.yaml -n test</span><br><span class="line">kubectl port-forward hellok8s-pod 3000:3000 -n dev</span><br><span class="line">curl http://localhost:3000</span><br><span class="line">kubectl port-forward hellok8s-pod 3000:3000 -n test</span><br><span class="line">curl http://localhost:3000</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒKubernetes çš„ ConfigMap å¯ä»¥å¸®åŠ©æˆ‘ä»¬è½»æ¾ç®¡ç†ä¸åŒç¯å¢ƒä¸‹çš„é…ç½®ï¼Œç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸­éƒ¨ç½²æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®ä½¿ç”¨ç›¸åº”çš„æ•°æ®åº“åœ°å€æˆ–å…¶ä»–é…ç½®ä¿¡æ¯ã€‚</p>
<h3 id="ä½¿ç”¨-Secret-ç®¡ç†æ•æ„Ÿä¿¡æ¯"><a href="#ä½¿ç”¨-Secret-ç®¡ç†æ•æ„Ÿä¿¡æ¯" class="headerlink" title="ä½¿ç”¨ Secret ç®¡ç†æ•æ„Ÿä¿¡æ¯"></a>ä½¿ç”¨ Secret ç®¡ç†æ•æ„Ÿä¿¡æ¯</h3><p>ä¹‹å‰æˆ‘ä»¬æåˆ°ï¼Œé€šå¸¸ä¼šé€‰æ‹©ä½¿ç”¨ ConfigMap æ¥æŒ‚è½½é…ç½®ä¿¡æ¯ï¼Œä½†å½“æˆ‘ä»¬çš„é…ç½®ä¿¡æ¯éœ€è¦åŠ å¯†æ—¶ï¼ŒConfigMap å°±æ— æ³•æ»¡è¶³è¿™ä¸ªè¦æ±‚ã€‚ä¾‹å¦‚ï¼Œå½“éœ€è¦æŒ‚è½½æ•°æ®åº“å¯†ç æ—¶ï¼ŒConfigMap åªèƒ½ä»¥æ˜æ–‡æ–¹å¼è¿›è¡ŒæŒ‚è½½ï¼Œè¿™å°±å¸¦æ¥äº†å®‰å…¨éšæ‚£ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒKubernetes æä¾›äº† Secret æ¥å­˜å‚¨åŠ å¯†ä¿¡æ¯ã€‚è™½ç„¶ Secret åœ¨èµ„æºæ–‡ä»¶ä¸­ä»…é€šè¿‡ Base64 æ–¹å¼è¿›è¡Œäº†ç®€å•ç¼–ç ï¼Œä½†åœ¨å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç»“åˆ CI&#x2F;CD pipeline æˆ–ä¸“ä¸šçš„å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚ <a target="_blank" rel="noopener" href="https://aws.amazon.com/kms/">AWS KMS</a>ï¼‰æ¥è¿›ä¸€æ­¥ä¿æŠ¤æ•æ„Ÿæ•°æ®ï¼Œä»è€Œå¤§å¤§é™ä½å®‰å…¨é£é™©ã€‚</p>
<p>Secret æ˜¯ä¸€ç§åŒ…å«å°‘é‡æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€ä»¤ç‰Œæˆ–å¯†é’¥ï¼‰çš„å¯¹è±¡ã€‚ç”±äº Secret çš„åˆ›å»ºå¯ä»¥ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„ Podï¼Œå› æ­¤åœ¨åˆ›å»ºã€æŸ¥çœ‹å’Œç¼–è¾‘ Pod çš„è¿‡ç¨‹ä¸­ï¼Œæš´éœ² Secretï¼ˆåŠå…¶æ•°æ®ï¼‰çš„é£é™©è¾ƒå°ã€‚Kubernetes å’Œé›†ç¾¤ä¸­çš„åº”ç”¨ç¨‹åºè¿˜å¯ä»¥é‡‡å–é¢å¤–çš„é¢„é˜²æªæ–½ï¼Œä¾‹å¦‚é¿å…å°†æœºå¯†æ•°æ®å†™å…¥éæ˜“å¤±æ€§å­˜å‚¨ã€‚</p>
<p>ç„¶è€Œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes çš„ Secret æ˜¯æœªåŠ å¯†åœ°å­˜å‚¨åœ¨ API æœåŠ¡å™¨çš„åº•å±‚æ•°æ®å­˜å‚¨ï¼ˆetcdï¼‰ä¸­çš„ã€‚è¿™æ„å‘³ç€ä»»ä½•æ‹¥æœ‰ API è®¿é—®æƒé™çš„äººéƒ½å¯ä»¥æ£€ç´¢æˆ–ä¿®æ”¹ Secretï¼Œä»»ä½•æœ‰æƒè®¿é—® etcd çš„äººä¹Ÿå¯ä»¥å¦‚æ­¤ã€‚æ­¤å¤–ï¼Œä»»ä½•æœ‰æƒé™åœ¨å‘½åç©ºé—´ä¸­åˆ›å»º Pod çš„äººä¹Ÿèƒ½å¤Ÿé—´æ¥è·å–è¯¥å‘½åç©ºé—´ä¸­çš„ Secret å†…å®¹ã€‚å› æ­¤ï¼Œä¸ºäº†å®‰å…¨åœ°ä½¿ç”¨ Secretï¼Œè¯·è‡³å°‘æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>ä¸º Secret <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">å¯ç”¨é™æ€åŠ å¯†</a>ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/">å¯ç”¨æˆ–é…ç½® RBAC è§„åˆ™</a>ä»¥é™åˆ¶è¯»å–å’Œå†™å…¥ Secret æ•°æ®çš„æƒé™ï¼ˆåŒ…æ‹¬é—´æ¥æ–¹å¼ï¼‰ã€‚æ³¨æ„ï¼Œå…·æœ‰åˆ›å»º Pod æƒé™çš„äººä¹Ÿéšå¼è·å¾—äº†è·å– Secret å†…å®¹çš„æƒé™ã€‚</li>
<li>æ ¹æ®éœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨ RBAC ç­‰æœºåˆ¶é™åˆ¶å“ªäº›ä¸»ä½“èƒ½å¤Ÿåˆ›å»ºæ–° Secret æˆ–æ›¿æ¢ç°æœ‰ Secretã€‚</li>
</ol>
<p>Secret çš„èµ„æºå®šä¹‰ä¸ ConfigMap ç»“æ„åŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äº <code>kind</code> æ˜¯ <code>Secret</code>ï¼Œä¸” Value éœ€è¦ä½¿ç”¨ Base64 ç¼–ç ã€‚ä¸è¿‡ï¼ŒSecret ä¹Ÿæä¾›äº† <code>stringData</code> å­—æ®µï¼Œå¯ä»¥ç›´æ¥å­˜å‚¨æœªç¼–ç çš„å€¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç† Base64 ç¼–ç ã€‚</p>
<p>ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ Base64 è¿›è¡Œç¼–ç å’Œè§£ç çš„å‘½ä»¤ç¤ºä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;password&quot; | base64</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cGFzc3dvcmQK</span></span><br><span class="line">echo &quot;cGFzc3dvcmQK&quot; | base64 -d</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">password</span></span><br></pre></td></tr></table></figure>

<p>å°† Base64 ç¼–ç åçš„å€¼å¡«å…¥å¯¹åº”çš„ key-value å¯¹ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s-secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">DB_PASSWORD:</span> <span class="string">&quot;cGFzc3dvcmQK&quot;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œåœ¨ Pod çš„å®šä¹‰ä¸­ï¼Œä½¿ç”¨ Secret æ¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:v5</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">hellok8s-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">DB_PASSWORD</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ä»£ç ä¸­ï¼Œå¯ä»¥é€šè¿‡è¯»å– <code>DB_PASSWORD</code> ç¯å¢ƒå˜é‡æ¥è·å–å¹¶è¿”å›å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚Secret çš„ä½¿ç”¨æ–¹æ³•ä¸ ConfigMap åŸºæœ¬ä¸€è‡´ï¼Œå› æ­¤åœ¨æ­¤ä¸å†èµ˜è¿°ã€‚</p>
<p>æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œå³å¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ„å»ºé•œåƒå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“</span></span><br><span class="line">docker build . -t tangrl177/hellok8s:v5</span><br><span class="line">docker push tangrl177/hellok8s:v5</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤ä¹‹å‰æ‰€æœ‰èµ„æº</span></span><br><span class="line">kubectl delete pod,deployment,service,ingress --all</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»º Secret å’Œ Pod</span></span><br><span class="line">kubectl apply -f hellok8s-secret.yaml</span><br><span class="line">kubectl apply -f hellok8s.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é€šè¿‡ port-forward è®¿é—®æœåŠ¡</span></span><br><span class="line">kubectl port-forward hellok8s-pod 3000:3000</span><br><span class="line">curl http://localhost:3000</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒKubernetes Secret å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®‰å…¨åœ°ç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚æ•°æ®åº“å¯†ç ï¼Œä»è€Œé¿å…å°†è¿™äº›ä¿¡æ¯ä»¥æ˜æ–‡å½¢å¼æš´éœ²åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚</p>
<h3 id="ä½¿ç”¨-Job-å’Œ-CronJob-å¤„ç†ä¸€æ¬¡æ€§ä»»åŠ¡"><a href="#ä½¿ç”¨-Job-å’Œ-CronJob-å¤„ç†ä¸€æ¬¡æ€§ä»»åŠ¡" class="headerlink" title="ä½¿ç”¨ Job å’Œ CronJob å¤„ç†ä¸€æ¬¡æ€§ä»»åŠ¡"></a>ä½¿ç”¨ Job å’Œ CronJob å¤„ç†ä¸€æ¬¡æ€§ä»»åŠ¡</h3><p>åœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ç±»ä»»åŠ¡å¹¶ä¸éœ€è¦é•¿æœŸè¿è¡Œï¼Œå®ƒä»¬åªéœ€è¦æ‰§è¡Œä¸€æ¬¡å³å¯å®Œæˆï¼Œä¾‹å¦‚ä¸€äº›è®¡ç®—ä»»åŠ¡ã€‚è¿™ç±»ä»»åŠ¡ä¸é€‚åˆç”¨ Deployment æˆ– Pod æ¥ç®¡ç†ï¼Œè€Œæ˜¯åº”è¯¥ä½¿ç”¨ Job æ¥å¤„ç†ã€‚</p>
<p>Job ä¼šåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª Podï¼Œå¹¶ä¸”åœ¨æŒ‡å®šæ•°é‡çš„ Pod æˆåŠŸç»ˆæ­¢ä¹‹å‰ä¼šç»§ç»­é‡è¯• Pod çš„æ‰§è¡Œã€‚Job ä¼šè·Ÿè¸ªæˆåŠŸå®Œæˆçš„ Pod æ•°é‡ï¼Œå½“è¿™ä¸ªæ•°é‡è¾¾åˆ°æŒ‡å®šçš„é˜ˆå€¼æ—¶ï¼ŒJob å°±ä¼šæ ‡è®°ä¸ºå®Œæˆã€‚åˆ é™¤ Job ä¼šæ¸…é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ Podï¼Œè€ŒæŒ‚èµ· Job ä¼šåˆ é™¤å…¶æ‰€æœ‰æ´»è·ƒçš„ Podï¼Œç›´åˆ° Job æ¢å¤æ‰§è¡Œã€‚</p>
<p>ä¸€ç§å¸¸è§çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª Job å¯¹è±¡æ¥ç¡®ä¿ Pod å¯é åœ°æ‰§è¡Œä»»åŠ¡ç›´åˆ°å®Œæˆã€‚å¦‚æœç¬¬ä¸€ä¸ª Pod å¤±è´¥æˆ–è¢«åˆ é™¤ï¼ˆä¾‹å¦‚å› ä¸ºèŠ‚ç‚¹ç¡¬ä»¶æ•…éšœæˆ–é‡å¯ï¼‰ï¼ŒJob å¯¹è±¡ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ Pod æ¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ª Job çš„èµ„æºå®šä¹‰ç¤ºä¾‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hello-job.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-job</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">completions:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">echo</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;for i in 9 8 7 6 5 4 3 2 1 ; do echo $i ; done&quot;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>parallelism</code> æŒ‡å®šäº†æœ€å¤§å¹¶å‘æ‰§è¡Œçš„ Pod æ•°é‡ä¸º 3ï¼Œ<code>completions</code> æŒ‡å®šäº†æ€»å…±éœ€è¦æˆåŠŸæ‰§è¡Œçš„ Pod æ•°é‡ä¸º 5ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šåŒæ—¶å¯åŠ¨ 3 ä¸ª Pod æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¸€æ—¦æŸä¸ª Pod æ‰§è¡Œå®Œæˆï¼Œä¼šåˆ›å»ºæ–°çš„ Pod ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°æˆåŠŸæ‰§è¡Œçš„ Pod æ•°é‡è¾¾åˆ° 5 ä¸ºæ­¢ã€‚<code>restartPolicy: OnFailure</code> è¡¨ç¤ºå¦‚æœ Pod æ‰§è¡Œå¤±è´¥ï¼Œä¼šåœ¨åŒä¸€èŠ‚ç‚¹é‡æ–°å¯åŠ¨è¯¥ Podã€‚</p>
<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥åˆ›å»º Jobï¼Œå¹¶ä½¿ç”¨ <code>kubectl get pods -w</code> æ¥è§‚å¯Ÿ Job åˆ›å»º Pod çš„è¿‡ç¨‹å’Œç»“æœã€‚æœ€åï¼Œå¯ä»¥é€šè¿‡ <code>kubectl logs</code> å‘½ä»¤æŸ¥çœ‹ Pod çš„æ—¥å¿—è¾“å‡ºã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod,deployment,service,ingress --all</span><br><span class="line">kubectl apply -f hello-job.yaml</span><br><span class="line">kubectl get jobs</span><br><span class="line">kubectl get pods               </span><br><span class="line">kubectl logs -f hello-job--xxx</span><br></pre></td></tr></table></figure>

<p>Job å®Œæˆæ—¶ï¼Œä¸ä¼šå†åˆ›å»ºæ–°çš„ Podï¼Œä½†å·²æœ‰çš„ Pod é€šå¸¸ä¹Ÿä¸ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚ä¿ç•™è¿™äº› Pod å¯ä»¥å¸®åŠ©ä½ æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼Œä»¥ä¾¿æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ã€è­¦å‘Šæˆ–å…¶ä»–è¯Šæ–­æ€§ä¿¡æ¯ã€‚å¦‚æœä½ éœ€è¦åˆ é™¤ Jobï¼Œå¯ä»¥ä½¿ç”¨ <code>kubectl delete -f hello-job.yaml</code>ï¼Œè¿™æ ·ä¼šè¿åŒå®ƒåˆ›å»ºçš„æ‰€æœ‰ Pod ä¸€å¹¶åˆ é™¤ã€‚</p>
<h4 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h4><p><em>CronJob</em> æ˜¯å¦ä¸€ç§ Kubernetes èµ„æºï¼Œé€‚ç”¨äºå®šæ—¶ä»»åŠ¡ï¼Œå®ƒèƒ½å¤ŸåŸºäº Cron è¡¨è¾¾å¼è°ƒåº¦å‘¨æœŸæ€§ <a target="_blank" rel="noopener" href="https://kubernetes.ion/docs/concepts/workloads/controllers/job/">Jobs</a>ã€‚</p>
<p>CronJob é€‚åˆæ‰§è¡Œå‘¨æœŸæ€§ä»»åŠ¡ï¼Œä¾‹å¦‚å¤‡ä»½æˆ–æŠ¥å‘Šç”Ÿæˆã€‚è¿™äº›ä»»åŠ¡åº”è¯¥é…ç½®ä¸ºå®šæœŸé‡å¤æ‰§è¡Œï¼ˆä¾‹å¦‚æ¯å¤©ã€æ¯å‘¨æˆ–æ¯æœˆä¸€æ¬¡ï¼‰ã€‚æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼ŒPod ä¼šè¢«åˆ é™¤ï¼Œæ–°çš„ Pod ä¼šåœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸåˆ›å»ºå¹¶æ‰§è¡Œä»»åŠ¡ã€‚</p>
<p>Cron æ—¶é—´è¡¨çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0 - 59)</span><br><span class="line"># â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0 - 23)</span><br><span class="line"># â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆçš„æŸå¤© (1 - 31)</span><br><span class="line"># â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆä»½ (1 - 12)</span><br><span class="line"># â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‘¨çš„æŸå¤© (0 - 6)ï¼ˆå‘¨æ—¥åˆ°å‘¨å…­ï¼›åœ¨æŸäº›ç³»ç»Ÿä¸Šï¼Œ7 ä¹Ÿæ˜¯æ˜ŸæœŸæ—¥ï¼‰</span><br><span class="line"># â”‚ â”‚ â”‚ â”‚ â”‚                          æˆ–è€…æ˜¯ sunï¼Œmonï¼Œtueï¼Œwedï¼Œthuï¼Œfriï¼Œsat</span><br><span class="line"># â”‚ â”‚ â”‚ â”‚ â”‚</span><br><span class="line"># â”‚ â”‚ â”‚ â”‚ â”‚</span><br><span class="line"># * * * * *</span><br></pre></td></tr></table></figure>

<p>é™¤äº†éœ€è¦æŒ‡å®š Cron è¡¨è¾¾å¼å¤–ï¼ŒCronJob çš„ä½¿ç”¨æ–¹å¼ä¸ Job åŸºæœ¬ä¸€è‡´ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hello-cronjob.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-cronjob</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;* * * * *&quot;</span> <span class="comment"># æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">echo</span></span><br><span class="line">              <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;for i in 9 8 7 6 5 4 3 2 1 ; do echo $i ; done&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ CronJob çš„å‘½ä»¤ä¸ Job åŸºæœ¬ç›¸åŒï¼Œä»¥ä¸‹å‘½ä»¤å¯ä»¥ç”¨äºåˆ›å»ºå’Œç®¡ç† CronJobï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete job,pod,deployment,service,ingress --all</span><br><span class="line">kubectl apply -f hello-cronjob.yaml</span><br><span class="line">kubectl get cronjob                </span><br><span class="line">kubectl get pods   </span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™äº›æ–¹æ³•ï¼ŒKubernetes çš„ Job å’Œ CronJob å¯ä»¥å¸®åŠ©ä½ è½»æ¾ç®¡ç†ä¸€æ¬¡æ€§ä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼Œä½¿å¾—ä»»åŠ¡çš„æ‰§è¡Œæ›´åŠ è‡ªåŠ¨åŒ–å’Œå¯é ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡å¸¦å¤§å®¶é€šè¿‡åŠ¨æ‰‹å»æ“ä½œ K8s ä¸­å¸¸ç”¨çš„èµ„æºï¼Œç›¸ä¿¡å·²ç»æ­å¼€äº† K8s ç¥ç§˜çš„é¢çº±ï¼Œå¤§å¤§åŠ æ·±äº†ä½ å¯¹ K8s çš„ç†è§£ã€‚å¦‚æœä½ ä¸æ˜¯è¿ç»´çš„è¯ï¼Œä¸Šé¢ä»‹ç»çš„å†…å®¹ï¼Œåœ¨æ—¥å¸¸å·¥ä½œä¸­å¾€å¾€å°±å¤Ÿç”¨äº†ã€‚K8s è¿˜æœ‰æ›´å¤šçš„èµ„æºå’Œæ¦‚å¿µï¼Œå¦‚æœæƒ³æ›´æ·±å…¥å­¦ä¹ å¯ä»¥å»çœ‹çœ‹å®˜æ–¹æ–‡æ¡£ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a target="_blank" rel="noopener" href="https://k8s-tutorials.pages.dev/">Kubernetes ç»ƒä¹ æ‰‹å†Œ</a></p>
<p><a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/">minikube</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.feisky.xyz/">Kubernetes æŒ‡å—</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/home/">Kubernetes å®˜æ–¹æ–‡æ¡£</a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/08/20/Notebook-%E5%95%86%E4%B8%9A%E5%8C%96%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%A0%94/">Notebook å•†ä¸šåŒ–æœåŠ¡è°ƒç ”</a><a class="next" href="/2024/08/14/K8s-%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0/">K8s åŸç†ç®€è¿°</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/Java-%E5%90%8E%E7%AB%AF/" style="font-size: 15px;">Java åç«¯</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/" style="font-size: 15px;">Jupyter äºŒæ¬¡å¼€å‘</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 15px;">æ•™ç¨‹</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">å·¥å…·</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> è”ç³»æˆ‘</i></div><ul></ul><a href="mailto:trl2025@163.com" title="Mail" target="_blank">Mail</a><ul></ul><a href="https://github.com/rongliangtang" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://space.bilibili.com/28159312" title="Bilibili" target="_blank">Bilibili</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2024 Tom</div></div></div><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>