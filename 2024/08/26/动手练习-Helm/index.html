<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="这是RongLiang的博客,用来分享技术知识和一些感悟。"><title>动手练习 Helm | Tom's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">动手练习 Helm</h1><a id="logo" href="/.">Tom's Blog</a><p class="description">野蛮生长</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 文章</i></a><a href="/archives/"><i class="fa undefined"> 总览</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">动手练习 Helm</h1><div class="post-meta">2024-08-26</div><div class="post-content"><p>在上一篇文章中，介绍了 K8s 的基本使用。本文中会介绍 Helm 的作用和基本使用。</p>
<span id="more"></span>

<p>在使用 Kubernetes 时，通常需要通过 <code>kubectl apply -f</code> 命令逐个创建资源。如果切换到另一个 namespace，或者部署到另一套 Kubernetes 集群时，往往需要重复这些操作。</p>
<p>Helm 的出现正是为了解决这个问题。它帮助我们在 Kubernetes 中部署服务时，只需一个命令即可完成整个过程。Helm 是管理 Kubernetes 应用的最佳工具，能够查找、分享和使用软件构建 Kubernetes 应用。其主要特点包括：</p>
<ul>
<li><strong>复杂性管理</strong>：即使是最复杂的应用，Helm Chart 也可以完整描述，并提供可重复安装的单点授权应用程序。</li>
<li><strong>易于升级</strong>：随时随地的升级和自定义钩子使得升级变得简单而高效。</li>
<li><strong>简单分发</strong>：Helm Chart 可以轻松发布在公共或私有服务器上，便于分发和部署。</li>
<li><strong>轻松回滚</strong>：使用 <code>helm rollback</code> 命令，可以轻松回滚到之前的发布版本。</li>
</ul>
<p>有关安装方法，可以参考<a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/intro/install/">官网教程</a>。</p>
<h2 id="创建-Helm-Chart"><a href="#创建-Helm-Chart" class="headerlink" title="创建 Helm Chart"></a>创建 Helm Chart</h2><h3 id="本地创建-Chart"><a href="#本地创建-Chart" class="headerlink" title="本地创建 Chart"></a>本地创建 Chart</h3><p>下面介绍如何创建自己的 Helm Chart，我们将通过创建一个 <code>hello-helm</code> Chart 来部署 Kubernetes 资源。</p>
<p>首先，建议使用 <code>helm create</code> 命令来生成一个初始的 Chart，这个命令会自动生成一些 Kubernetes 资源定义的初始文件，并按照官方推荐的目录结构组织文件，如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create hello-helm</span><br></pre></td></tr></table></figure>

<p>生成的目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">└── hello-helm</span><br><span class="line">    ├── Chart.yaml</span><br><span class="line">    ├── charts</span><br><span class="line">    ├── templates</span><br><span class="line">    │   ├── NOTES.txt</span><br><span class="line">    │   ├── _helpers.tpl</span><br><span class="line">    │   ├── deployment.yaml</span><br><span class="line">    │   ├── hpa.yaml</span><br><span class="line">    │   ├── ingress.yaml</span><br><span class="line">    │   ├── service.yaml</span><br><span class="line">    │   ├── serviceaccount.yaml</span><br><span class="line">    │   └── tests</span><br><span class="line">    │       └── test-connection.yaml</span><br><span class="line">    └── values.yaml</span><br></pre></td></tr></table></figure>

<p>我们将 <code>templates</code> 目录下默认生成的 <code>yaml</code> 文件删除，并替换为之前教程中创建的 <code>yaml</code> 文件。最终的结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── hello-helm</span><br><span class="line">│   ├── Chart.yaml</span><br><span class="line">│   ├── charts</span><br><span class="line">│   ├── templates</span><br><span class="line">│   │   ├── hellok8s-configmaps.yaml</span><br><span class="line">│   │   ├── hellok8s-deployment.yaml</span><br><span class="line">│   │   ├── hellok8s-secret.yaml</span><br><span class="line">│   │   ├── hellok8s-service.yaml</span><br><span class="line">│   │   ├── ingress.yaml</span><br><span class="line">│   │   ├── nginx-deployment.yaml</span><br><span class="line">│   │   └── nginx-service.yaml</span><br><span class="line">│   ├── values-dev.yaml</span><br><span class="line">│   └── values.yaml</span><br><span class="line">└── image</span><br><span class="line">    ├── HelloKubernetes.java</span><br><span class="line">    └── dockerfile</span><br></pre></td></tr></table></figure>

<p><code>image</code> 文件夹中包含用于构建镜像的内容，其中 <code>HelloKubernetes.java</code> 定义了 <code>hellok8s:v6</code> 版本的代码，主要是从系统环境中获取 <code>MESSAGE</code>、<code>NAMESPACE</code>、<code>DB_URL</code>、<code>DB_PASSWORD</code> 这几个环境变量，并将它们拼接成字符串返回。这些环境变量的来源会通过 <code>helm values</code> 和 Kubernetes 配置来设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpServer;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpHandler;</span><br><span class="line"><span class="keyword">import</span> com.sun.net.httpserver.HttpExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloKubernetes</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> String[] hostHolder = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            hostHolder[<span class="number">0</span>] = InetAddress.getLocalHost().getHostName();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            hostHolder[<span class="number">0</span>] = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取环境变量</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;MESSAGE&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;NAMESPACE&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">dbURL</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;DB_URL&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">dbPassword</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;DB_PASSWORD&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个 HttpServer 实例，监听端口 3000</span></span><br><span class="line">        <span class="type">HttpServer</span> <span class="variable">server</span> <span class="operator">=</span> HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">3000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        server.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HttpHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange exchange)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> String.format(</span><br><span class="line">                    <span class="string">&quot;[v6] Hello, Helm! Message from helm values: %s, From namespace: %s, From host: %s, Get Database Connect URL: %s, Database Connect Password: %s&quot;</span>,</span><br><span class="line">                    message, namespace, hostHolder[<span class="number">0</span>], dbURL, dbPassword</span><br><span class="line">                );</span><br><span class="line">                exchange.sendResponseHeaders(<span class="number">200</span>, response.getBytes().length);</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> exchange.getResponseBody();</span><br><span class="line">                os.write(response.getBytes());</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        server.setExecutor(<span class="literal">null</span>); <span class="comment">// 使用默认的执行器</span></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是 Dockerfile 的内容：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 OpenJDK 8 的 Alpine 作为构建阶段的基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建工作目录 /src</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将当前目录下的所有文件复制到容器的 /src 目录中</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 Java 源代码</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> javac HelloKubernetes.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 distroless 作为运行阶段的基础镜像，以提高安全性和减小镜像大小</span></span><br><span class="line"><span class="keyword">FROM</span> gcr.io/distroless/java-debian10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录为根目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从构建阶段复制所有编译好的字节码文件到运行阶段镜像中</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /src/ /app/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置类路径，并运行应用程序</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-cp&quot;</span>, <span class="string">&quot;/app&quot;</span>, <span class="string">&quot;HelloKubernetes&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露应用程序监听的端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>

<p>进入 <code>image</code> 文件夹，进行镜像的构建。<strong>注意，将 <code>tangrl177</code> 替换为你自己的 DockerHub 账号名。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build . -t tangrl177/hellok8s:v6</span><br><span class="line">docker push tangrl177/hellok8s:v6</span><br></pre></td></tr></table></figure>

<p>接下来，我们修改根目录下的 <code>values.yaml</code> 文件，用于定义自定义的配置信息。将 Kubernetes 资源文件中容易变化的参数提取出来，放在 <code>values.yaml</code> 文件中。<strong>注意，将 <code>tangrl177</code> 替换为你自己的 DockerHub 账号名。</strong>完整的 <code>values.yaml</code> 配置信息如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">application:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">hellok8s:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:v6</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&quot;It works with Helm Values[v6]!&quot;</span></span><br><span class="line">    <span class="attr">database:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">&quot;http://DB_ADDRESS_DEFAULT&quot;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;db_password&quot;</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>在 Helm 中，默认使用 <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/howto/charts_tips_and_tricks/">Go template</a> 语法来引用这些值。例如，我们可以将 ConfigMap 资源定义成如下的 <code>hellok8s-configmaps.yaml</code> 文件，其中 <code>metadata.name</code> 的值使用 <code>&#123;&#123; .Values.application.name &#125;&#125;-config</code>，会从 <code>values.yaml</code> 中获取 <code>application.name</code> 的值 <code>hellok8s</code>，并拼接 <code>-config</code>，生成的 ConfigMap 名称就是 <code>hellok8s-config</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s-configmaps.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Values.application.name</span> &#125;&#125;<span class="string">-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">DB_URL:</span> &#123;&#123; <span class="string">.Values.application.hellok8s.database.url</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>同理，可以将 Secret 资源定义成如下的 <code>hellok8s-secret.yaml</code> 文件，并使用 <code>b64enc</code> 方法将值进行 Base64 编码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s-secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Values.application.name</span> &#125;&#125;<span class="string">-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">DB_PASSWORD:</span> &#123;&#123; <span class="string">.Values.application.hellok8s.database.password</span> <span class="string">|</span> <span class="string">b64enc</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>最后，修改 <code>hellok8s-deployment.yaml</code> 文件，将所有变量引用改为从 <code>values.yaml</code> 文件中获取，并添加代码中需要的 <code>NAMESPACE</code> 环境变量，使用 Helm 内置的 <code>.Release.Namespace</code> 对象获取当前命名空间：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Values.application.name</span> &#125;&#125;<span class="string">-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.Values.application.hellok8s.replicas</span> &#125;&#125;</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> &#123;&#123; <span class="string">.Values.application.hellok8s.image</span> &#125;&#125;</span><br><span class="line">          <span class="attr">name:</span> <span class="string">hellok8s-container</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_URL</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> &#123;&#123; <span class="string">.Values.application.name</span> &#125;&#125;<span class="string">-config</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">DB_URL</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">secretKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> &#123;&#123; <span class="string">.Values.application.name</span> &#125;&#125;<span class="string">-secret</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NAMESPACE</span></span><br><span class="line">              <span class="attr">value:</span> &#123;&#123; <span class="string">.Release.Namespace</span> &#125;&#125;</span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MESSAGE</span></span><br><span class="line">              <span class="attr">value:</span> &#123;&#123; <span class="string">.Values.application.hellok8s.message</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>类似地，<code>ingress.yaml</code> 文件的 <code>metadata.name</code> 也可以改为从 <code>values.yaml</code> 中获取：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">.Values.application.name</span> &#125;&#125;<span class="string">-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/hello</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">service-hellok8s-clusterip</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">3000</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">service-nginx-clusterip</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">4000</span></span><br></pre></td></tr></table></figure>

<p><code>nginx-deployment.yaml</code> 文件的内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.Values.application.nginx.replicas</span> &#125;&#125;</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> &#123;&#123; <span class="string">.Values.application.nginx.image</span> &#125;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx-container</span></span><br></pre></td></tr></table></figure>

<p><code>nginx-service.yaml</code> 和 <code>hellok8s-service.yaml</code> 文件的内容没有变化。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hellok8s-service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-hellok8s-clusterip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx-service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-nginx-clusterip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">4000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>在 <code>hello-helm</code> 目录下执行 <code>helm upgrade</code> 命令进行安装。安装成功后，执行 <code>curl</code> 命令可以直接查看结果，并通过 <code>helm</code> 管理所有资源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果使用 minikube，需要开启 ingress 功能</span></span><br><span class="line">minikube addons <span class="built_in">enable</span> ingress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在本地安装 Chart</span></span><br><span class="line">helm upgrade --install hello-helm --values values.yaml .</span><br></pre></td></tr></table></figure>

<p>如果使用 minikube 或 Docker Desktop，则可能需要公开服务。可以使用 <code>minikube</code> 提供的命令来查看服务列表，并通过 <code>curl</code> 进行测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">minikube service list</span><br><span class="line">minikube service ingress-nginx-controller -n ingress-nginx --url</span><br><span class="line"><span class="comment"># 输出示例：</span></span><br><span class="line"><span class="comment"># http://127.0.0.1:55201  http</span></span><br><span class="line"><span class="comment"># http://127.0.0.1:55202  https</span></span><br><span class="line">curl http://127.0.0.1:55201/hello</span><br><span class="line">curl http://127.0.0.1:55201/</span><br></pre></td></tr></table></figure>

<p>这样，你就可以通过 Helm 一键管理和部署所有 Kubernetes 资源了！</p>
<h3 id="Rollback"><a href="#Rollback" class="headerlink" title="Rollback"></a>Rollback</h3><p>Helm 提供了强大的 Rollback 功能，允许你快速回滚到之前的版本。如果一次更新出现了问题，你可以轻松地恢复到之前的状态。</p>
<p>首先，我们先通过修改 <code>values.yaml</code> 文件，将 <code>message</code> 字段更新为 <code>&quot;It works with Helm Values[v2]!&quot;</code>，以表示这是一个新的版本。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values.yaml</span></span><br><span class="line"><span class="attr">application:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hellok8s</span></span><br><span class="line">  <span class="attr">hellok8s:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tangrl177/hellok8s:v6</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&quot;It works with Helm Values[v2]!&quot;</span></span><br><span class="line">    <span class="attr">database:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">&quot;http://DB_ADDRESS_DEFAULT&quot;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;db_password&quot;</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>然后，使用 <code>helm upgrade</code> 命令更新 Kubernetes 资源。你可以通过 <code>curl</code> 命令来验证资源是否已更新成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install hello-helm --values values.yaml .</span><br><span class="line">minikube service list</span><br><span class="line">minikube service ingress-nginx-controller -n ingress-nginx --url</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出如下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://127.0.0.1:55201  http</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://127.0.0.1:55202  https</span></span><br><span class="line">curl http://127.0.0.1:55201/hello</span><br><span class="line">curl http://127.0.0.1:55201/</span><br></pre></td></tr></table></figure>

<p>如果这次更新出现问题，你可以使用 <code>helm rollback</code> 命令快速回滚到之前的版本。需要注意的是，与 Kubernetes 中的 Deployment 回滚类似，Helm 回滚后的 REVISION 版本号会增加。例如，如果你回滚到 REVISION 1，回滚后的 REVISION 版本号将是 3，而不是直接回到 1。回滚后，使用 <code>curl</code> 命令时会看到返回的字符串恢复为 v1 版本。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">helm ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME      	NAMESPACE	REVISION	UPDATED                            	STATUS  	CHART           	APP VERSION</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hello-helm	default  	2       	2024-08-26 17:08:22.20669 +0800 CST	deployed	hello-helm-0.1.0	1.16.0</span></span><br><span class="line"></span><br><span class="line">helm rollback hello-helm 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Rollback was a success! Happy Helming!</span></span><br><span class="line"></span><br><span class="line">helm ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME      	NAMESPACE	REVISION	UPDATED                             	STATUS  	CHART           	APP VERSION</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hello-helm	default  	3       	2024-08-26 17:11:46.380842 +0800 CST	deployed	hello-helm-0.1.0	1.16.0</span></span><br><span class="line"></span><br><span class="line">minikube service list</span><br><span class="line">minikube service ingress-nginx-controller -n ingress-nginx --url</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出如下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://127.0.0.1:55201  http</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://127.0.0.1:55202  https</span></span><br><span class="line">curl http://127.0.0.1:55201/hello</span><br><span class="line">curl http://127.0.0.1:55201/</span><br></pre></td></tr></table></figure>

<p>通过上述步骤，你可以看到 Helm 的 Rollback 功能如何在版本更新出现问题时帮助你迅速恢复到之前的稳定版本。这使得管理 Kubernetes 资源更加灵活和安全。</p>
<h3 id="多环境配置"><a href="#多环境配置" class="headerlink" title="多环境配置"></a>多环境配置</h3><h3 id="多环境配置-1"><a href="#多环境配置-1" class="headerlink" title="多环境配置"></a>多环境配置</h3><p>使用 Helm 进行多环境部署非常方便。首先，你可以为不同的环境创建不同的 <code>values</code> 文件。例如，创建一个 <code>values-dev.yaml</code> 文件，用于自定义 <code>dev</code> 环境的配置信息。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># values-dev.yaml</span></span><br><span class="line"><span class="attr">application:</span></span><br><span class="line">  <span class="attr">hellok8s:</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&quot;It works with Helm Values values-dev.yaml!&quot;</span></span><br><span class="line">    <span class="attr">database:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">&quot;http://DB_ADDRESS_DEV&quot;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;db_password_dev&quot;</span></span><br></pre></td></tr></table></figure>

<p>在部署时，你可以使用多次指定 <code>--values</code> 或 <code>-f</code> 参数的方式来加载不同的 <code>values</code> 文件。最后指定的文件（即最右边的文件）具有最高的优先级，因此 <code>values-dev.yaml</code> 文件中的值会覆盖 <code>values.yaml</code> 中相同的值。同时，使用 <code>-n dev</code> 可以在名为 <code>dev</code> 的 namespace 中创建 Kubernetes 资源。执行命令后，通过 <code>curl</code> 命令可以看到返回的字符串中读取的是 <code>values-dev.yaml</code> 文件中的配置，并且显示 <code>From namespace = dev</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install hello-helm -f values.yaml -f values-dev.yaml -n dev .</span><br><span class="line"></span><br><span class="line">kubectl get pods -n dev</span><br></pre></td></tr></table></figure>

<p>除了使用 <code>values</code> 文件外，你还可以通过 <code>--set</code> 直接在命令行中设置独立的值。例如，使用以下命令可以覆盖 <code>values.yaml</code> 和 <code>values-dev.yaml</code> 文件中的 <code>message</code> 字段：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install hello-helm -f values.yaml -f values-dev.yaml --set application.hellok8s.message=&quot;It works with set helm values&quot; -n dev .</span><br></pre></td></tr></table></figure>

<p>这种方法在 CI&#x2F;CD 中非常常见，因为它允许你在部署过程中灵活地修改配置，而无需更改 <code>values</code> 文件的内容。</p>
<h2 id="打包和发布-Helm-Chart"><a href="#打包和发布-Helm-Chart" class="headerlink" title="打包和发布 Helm Chart"></a>打包和发布 Helm Chart</h2><p>在前面的例子中，我们展示了如何用一行命令在一个新的环境中安装所有需要的 Kubernetes 资源！接下来，我们将讨论如何将 Helm Chart 打包、分发并发布，以便其他人可以下载和使用它。</p>
<p>官方提供了两种教程来实现这一目标：一种是使用 <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/howto/chart_repository_sync_example/">GCS（Google Cloud Storage）</a> 存储，另一种是使用 <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/howto/chart_releaser_action/">GitHub Pages</a> 存储 Chart。本教程将采用第二种方法，并使用 <a target="_blank" rel="noopener" href="https://github.com/helm/chart-releaser-action">chart-releaser-action</a> 进行自动发布。</p>
<p>这个 GitHub Action 会自动将 Helm Chart 发布到 <code>gh-pages</code> 分支上。例如，本教程中的 <code>hellok8s</code> Helm Chart 就发布在 gh-pages 分支的 <code>index.yaml</code> 文件中。</p>
<h3 id="手动打包与发布"><a href="#手动打包与发布" class="headerlink" title="手动打包与发布"></a>手动打包与发布</h3><p>在使用 GitHub Action 自动生成和发布 Chart 之前，我们先了解一下如何手动完成这些操作。</p>
<p>在 <code>hello-helm</code> 目录下，使用 <code>helm package</code> 命令将 Chart 目录打包成一个 <code>.tgz</code> 文件。接着，使用 <code>helm repo index</code> 命令基于包含已打包 Chart 的目录生成仓库的索引文件 <code>index.yaml</code>。</p>
<p>最后，你可以使用 <code>helm upgrade --install</code> 命令来安装该指定包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">helm package hello-helm</span><br><span class="line"></span><br><span class="line">helm repo index .</span><br><span class="line"></span><br><span class="line">helm upgrade --install hello-helm hello-helm-0.1.0.tgz</span><br></pre></td></tr></table></figure>

<p>通过上述步骤，我们可以看到，所谓的 Helm 打包与发布过程，其实就是生成并上传 <code>hello-helm-0.1.0.tgz</code> 和 <code>index.yaml</code> 文件。而 Helm 的下载与安装过程则是将 <code>.tgz</code> 和 <code>index.yaml</code> 文件下载并使用 <code>helm upgrade --install</code> 命令进行安装。</p>
<h3 id="自动发布到-GitHub-Pages"><a href="#自动发布到-GitHub-Pages" class="headerlink" title="自动发布到 GitHub Pages"></a>自动发布到 GitHub Pages</h3><p>为了将生成的 <code>hellok8s</code> Helm Chart 自动发布，我们可以先删除手动生成的 <code>hello-helm-0.1.0.tgz</code> 和 <code>index.yaml</code> 文件，然后使用 GitHub Actions 自动生成和发布这些文件。</p>
<p>以下是 GitHub Action 的配置示例，来自 <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/howto/chart_releaser_action/">官方文档</a> 或本教程的源码仓库 <code>.github/workflows/release.yml</code> 文件。该配置会在每次代码推送到远程仓库时，自动将 <code>helm-charts</code> 目录下的所有 Charts 打包并发布到 <code>gh-pages</code> 分支（确保 <code>gh-pages</code> 分支已存在，否则会报错）。</p>
<p>可以通过下面的命令创建新分支：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git checkout --orphan gh-pages</span><br><span class="line">git rm -rf .</span><br><span class="line">echo &#x27;# helm chart repo&#x27; &gt;&gt; README.md</span><br><span class="line">git add README.md</span><br><span class="line">git commit -m &#x27;new branch&#x27;</span><br><span class="line">git push origin gh-pages</span><br></pre></td></tr></table></figure>

<p>下面是 <code>.github/workflows/release.yml</code> 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/release.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Release</span> <span class="string">Charts</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">release:</span></span><br><span class="line">    <span class="attr">permissions:</span></span><br><span class="line">      <span class="attr">contents:</span> <span class="string">write</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Git</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          git config user.name &quot;$GITHUB_ACTOR&quot;</span></span><br><span class="line"><span class="string">          git config user.email &quot;$GITHUB_ACTOR@users.noreply.github.com&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Helm</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">azure/setup-helm@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">version:</span> <span class="string">v3.8.1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">chart-releaser</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">helm/chart-releaser-action@v1.4.0</span></span><br><span class="line">        <span class="attr">with:</span> </span><br><span class="line">          <span class="attr">charts_dir:</span> <span class="string">helm-charts</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">CR_TOKEN:</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>接着，前往 GitHub 仓库的 <code>Settings -&gt; Pages -&gt; Build and deployment -&gt; Branch</code>，选择 <code>gh-pages</code> 分支，GitHub 会自动在 <code>https://username.github.io/project</code> 上发布 Helm Chart。</p>
<h3 id="使用发布后的-Chart"><a href="#使用发布后的-Chart" class="headerlink" title="使用发布后的 Chart"></a>使用发布后的 Chart</h3><p>将 Chart 发布到 Github Pages 后，可以通过下面的命令进行快速安装。其中 <code>helm repo add</code> 表示将我创建好的 hellok8s chart 添加到自己本地的仓库当中，<code>helm install</code> 表示从仓库中安装 hellok8s&#x2F;hello-helm 到 k8s 集群当中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">helm repo add hellok8s https://rongliangtang.github.io/helm-demo/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;hellok8s&quot;</span> has been added to your repositories</span></span><br><span class="line"></span><br><span class="line">helm install my-hello-helm hellok8s/hello-helm --version 0.1.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAME: my-hello-helm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NAMESPACE: default</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">STATUS: deployed</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">REVISION: 1</span></span><br></pre></td></tr></table></figure>

<h3 id="发布到社区"><a href="#发布到社区" class="headerlink" title="发布到社区"></a>发布到社区</h3><p>最后，你可以将自己的 Helm Charts 发布到社区中，例如 <a target="_blank" rel="noopener" href="https://artifacthub.io/">ArtifactHub</a>，这样更多人可以使用你的 Chart。像本教程中的 <code>hellok8s</code> Helm Chart 就已经发布在 <a target="_blank" rel="noopener" href="https://artifacthub.io/packages/helm/hellok8s/hello-helm">ArtifactHub</a> 上。通过这些步骤，你就可以将自己的 Helm Chart 打包、发布并共享给全球的开发者使用了。</p>
<h2 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h2><p><a target="_blank" rel="noopener" href="https://github.com/rongliangtang/helm-demo">https://github.com/rongliangtang/helm-demo</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/">Helm 官方文档</a></p>
<p><a target="_blank" rel="noopener" href="https://k8s-tutorials.pages.dev/helm.html">Kubernetes 练习手册</a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/K8s/" rel="tag">K8s</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/08/27/Java-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%8C%87%E5%8D%97/">Java 单元测试指南</a><a class="next" href="/2024/08/23/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/">Jupyter 二次开发方式总结</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Java-%E5%90%8E%E7%AB%AF/" style="font-size: 15px;">Java 后端</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/" style="font-size: 15px;">Jupyter 二次开发</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 15px;">教程</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 联系我</i></div><ul></ul><a href="mailto:trl2025@163.com" title="Mail" target="_blank">Mail</a><ul></ul><a href="https://github.com/rongliangtang" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://space.bilibili.com/28159312" title="Bilibili" target="_blank">Bilibili</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 Tom</div></div></div><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>