<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="这是RongLiang的博客,用来分享技术知识和一些感悟。"><title>Jupyter 二次开发思路（1） | Tom's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Jupyter 二次开发思路（1）</h1><a id="logo" href="/.">Tom's Blog</a><p class="description">野蛮生长</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 文章</i></a><a href="/archives/"><i class="fa undefined"> 总览</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Jupyter 二次开发思路（1）</h1><div class="post-meta">2024-08-13</div><div class="post-content"><p>上篇文章介绍了 Jupyter 生态及重要组件的原理。基于之前的内容，本文介绍 Jupyter 二次开发的思路。首先介绍项目的需求，接着进一步介绍架构设计，进行demo的实现，最后进行总结。</p>
<span id="more"></span>

<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>实现图数据管理分析 BI 平台的 Notebook Service，具备数据的探索、执行分析任务、sql 操作、spark 操作等功能。这个平台目前是单租户的架构，是 to b 的。一般是公司的数据分析团队使用，一个团队一般是十几个人，写代码用到 Notebook 的可能也就那么几个人。所以对性能和可用性没有像 to c 的产品要求那么高。</p>
<p>总结下来，我们的 Notebook Service 应该具备下面的功能：</p>
<ul>
<li>提供给用户开箱即用的环境</li>
<li>隔离用户的环境，避免互相污染</li>
<li>接入 spark、adb、oss 等平台资源供用户进行探查、分析</li>
</ul>
<p>目前打算先快速把架构搭起来，先使用自带的 IPython 内核，后面再接入平台的对象存储、数据库和 spark 集群等资源。</p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p>经过调研，决定采用下面组件来组合实现：</p>
<ul>
<li><strong>前端</strong> 使用经典的 Jupyter Notebook 组件，因为项目不需要太多的功能，只需要实现简单的 Notebook 功能就行。</li>
<li><strong>服务端</strong> 使用 Jupyter Server 来转发前端的请求给内核执行。</li>
<li><strong>内核</strong> 负责执行代码，将结果返回服务端。暂时使用 IPython Kernel，后面再接入平台的对象存储、数据库和 spark 集群等资源。</li>
<li><strong>部署</strong> 使用 Jupyter Hub 组件，用于为实现多用户提供 Notebook，即不同用户使用不同的 Jupyter Server 和 Kernel。<ul>
<li><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/authenticators.html">Authenticators</a>：实现自定义登录鉴权，可以通过自定义 Authenticator 类并在配置文件中指定来实现。</li>
<li><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/spawners.html">Spawners</a>：用户登录时，Jupyter Hub 会用用户启动一个新实例（Jupyter Server + Kernel）。启动实例是通过 Spawner 实现的。官方提供了多种 Spawner 的实现，包括：本机新的Notebook Server进程、本机启动Docker实例、K8s系统中启动新的Pod、YARN中启动新的实例等等。这些实现本身是可配置的。如果不符合需求，也可以自己开发全新的 Spawner。后续我们需要接入 spark 和 数据库等资源，可以基于官方提供的 Spawner 进行定制，来接入资源。</li>
</ul>
</li>
</ul>
<p>整个架构如下图所示。不同的客户端通过 JupyterHub 进行登录验证后，可以通过 Jupyter Notebook 前端，访问对应的实例。每个实例即 K8s 的 pod，不同 pod 之间的资源是隔离的。</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/notebook-architecture.png" alt="notebook-architecture" style="zoom:20%;" />

<h2 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h2><p>下面在本地部署一个 Jupyter Hub，从各个组件的源码进行编译。虽然各个组件都可以通过扩展的方式去开发，但是后期如果有复杂的架构的话，可能需要修改相关的源码，所以通过在本地去编译各个组件的源码，去部署 Jupyter Hub。在本地完成开发后，可以打包成镜像，然后参考 <a target="_blank" rel="noopener" href="https://z2jh.jupyter.org/en/stable/jupyterhub/customizing/user-environment.html">社区的教程</a> 部署到 K8s 上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 IPyKernel</span></span><br><span class="line">pip install ipykernel -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 Jupyter Server</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/jupyter-server/jupyter_server.git</span><br><span class="line"><span class="built_in">cd</span> jupyter_server</span><br><span class="line">pip install -v -e .</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 Jupyter Lab 前端</span></span><br><span class="line"><span class="comment"># 需要注意的是，直接编译 Jupyter Lab，会自动安装 IPyKernel 和 Jupyter Server 等依赖</span></span><br><span class="line"><span class="comment"># 我们将这些步骤放在前面先编译安装了，方便理解</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/jupyterlab/jupyterlab.git</span><br><span class="line"><span class="built_in">cd</span> jupyterlab</span><br><span class="line"><span class="comment"># 如果执行 pip install -v -e . 报错，就先尝试执行 yarn install 安装前端的依赖</span></span><br><span class="line">yarn install</span><br><span class="line">pip install -v -e .</span><br><span class="line"><span class="comment"># build 前端资源</span></span><br><span class="line">jupyter lab build</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Jupyter Hub 的 proxy，它的作用是将用户的请求路由给对应的 Jupyter Server</span></span><br><span class="line">npm install -g configurable-http-proxy --registry=https://registry.npmmirror.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 Jupyter Hub</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/jupyterhub/jupyterhub.git</span><br><span class="line"><span class="built_in">cd</span> jupyterhub</span><br><span class="line">pip install -v -e .</span><br><span class="line"><span class="built_in">cd</span> ../</span><br></pre></td></tr></table></figure>

<p>回顾一下之前的简化架构图，会发现上述命令将需要用到的重要组件都安装到了。 JupyterHub 管理多个用户，每个用户都有独立的单用户服务器实例，包括 Jupyter Lab 界面、Jupyter Server 和 IPython 内核。用户通过 JupyterLab 交互界面编写和执行代码，Jupyter Server 处理请求并与内核通信执行代码，最终将结果返回给用户，实现了多用户的交互式计算环境。</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/7189fdd91099e1a8ba7e792ce592da9529878.png" alt="Jupyter 架构简化图" style="zoom:50%;" />

<p>上面安装好了 Jupyter 的本地环境后，接下来介绍如何跑起来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个文件夹用来存放配置文件</span></span><br><span class="line"><span class="built_in">mkdir</span> jupyterhub-config &amp;&amp; <span class="built_in">cd</span> jupyterhub-config</span><br><span class="line"><span class="comment"># 生成配置文件</span></span><br><span class="line">jupyterhub --generate-config</span><br></pre></td></tr></table></figure>

<p> 按下面的配置进行修改，各个配置注释都有解释，也可以参考<a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/config-reference.html">这里</a>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 PAM 进行用户身份验证，用户通过操作系统中的有效用户名和密码进行验证</span></span><br><span class="line">c.JupyterHub.authenticator_class = <span class="string">&#x27;jupyterhub.auth.PAMAuthenticator&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 让能通过验证的用户成功访问 Hub</span></span><br><span class="line">c.Authenticator.allow_all = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>然后执行下面命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以 jupyterhub_config.py 中的配置运行jupyterhub</span></span><br><span class="line">jupyterhub -f jupyterhub_config.py</span><br></pre></td></tr></table></figure>

<p>控制台会类似输出下面的内容。</p>
<p>需要注意的是 8081 端口是 <strong>Hub API</strong> 的监听端口，用于与其他组件（如 Proxy 和 Spawner）进行通信的接口，只对 JupyterHub 的内部通信开放，不直接对外提供服务。</p>
<p>8000 端口是 JupyterHub <strong>Proxy</strong> 的监听端口，负责将用户的请求从这个端口转发到对应的 Jupyter Server 服务，这个端口通常对外开放，用户通过这个端口访问 JupyterHub 的 Web 界面。所以我们在浏览器打开 <code>http://127.0.0.1:8000</code>，输入电脑的登录账号和密码就可以登录成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[I 2024-08-15 18:25:27.339 JupyterHub app:3307] Running JupyterHub version 5.2.0.dev</span><br><span class="line">[I 2024-08-15 18:25:27.339 JupyterHub app:3337] Using Authenticator: jupyterhub.auth.PAMAuthenticator-5.2.0.dev</span><br><span class="line">[I 2024-08-15 18:25:27.339 JupyterHub app:3337] Using Spawner: jupyterhub.spawner.LocalProcessSpawner-5.2.0.dev</span><br><span class="line">[I 2024-08-15 18:25:27.339 JupyterHub app:3337] Using Proxy: jupyterhub.proxy.ConfigurableHTTPProxy-5.2.0.dev</span><br><span class="line">[I 2024-08-15 18:25:27.342 JupyterHub app:1882] Writing cookie_secret to /jupyterhub_cookie_secret</span><br><span class="line">[I 2024-08-15 18:25:27.764 alembic.runtime.migration migration:215] Context impl SQLiteImpl.</span><br><span class="line">[I 2024-08-15 18:25:27.764 alembic.runtime.migration migration:218] Will assume non-transactional DDL.</span><br><span class="line">[I 2024-08-15 18:25:27.768 alembic.runtime.migration migration:623] Running stamp_revision  -&gt; 4621fec11365</span><br><span class="line">[I 2024-08-15 18:25:27.827 JupyterHub proxy:556] Generating new CONFIGPROXY_AUTH_TOKEN</span><br><span class="line">[I 2024-08-15 18:25:27.844 JupyterHub app:3376] Initialized 0 spawners <span class="keyword">in</span> 0.003 seconds</span><br><span class="line">[I 2024-08-15 18:25:27.846 JupyterHub metrics:373] Found 0 active <span class="built_in">users</span> <span class="keyword">in</span> the last ActiveUserPeriods.twenty_four_hours</span><br><span class="line">[I 2024-08-15 18:25:27.846 JupyterHub metrics:373] Found 0 active <span class="built_in">users</span> <span class="keyword">in</span> the last ActiveUserPeriods.seven_days</span><br><span class="line">[I 2024-08-15 18:25:27.846 JupyterHub metrics:373] Found 0 active <span class="built_in">users</span> <span class="keyword">in</span> the last ActiveUserPeriods.thirty_days</span><br><span class="line">[W 2024-08-15 18:25:27.846 JupyterHub proxy:748] Running JupyterHub without SSL.  I hope there is SSL termination happening somewhere <span class="keyword">else</span>...</span><br><span class="line">[I 2024-08-15 18:25:27.846 JupyterHub proxy:752] Starting proxy @ http://:8000</span><br><span class="line">18:25:28.383 [ConfigProxy] info: Proxying http://*:8000 to (no default)</span><br><span class="line">18:25:28.384 [ConfigProxy] info: Proxy API at http://127.0.0.1:8001/api/routes</span><br><span class="line">18:25:28.763 [ConfigProxy] info: 200 GET /api/routes</span><br><span class="line">[I 2024-08-15 18:25:28.763 JupyterHub app:3690] Hub API listening on http://127.0.0.1:8081/hub/</span><br><span class="line">18:25:28.765 [ConfigProxy] info: 200 GET /api/routes</span><br><span class="line">[I 2024-08-15 18:25:28.765 JupyterHub proxy:477] Adding route <span class="keyword">for</span> Hub: / =&gt; http://127.0.0.1:8081</span><br><span class="line">18:25:28.767 [ConfigProxy] info: Adding route / -&gt; http://127.0.0.1:8081</span><br><span class="line">18:25:28.768 [ConfigProxy] info: Route added / -&gt; http://127.0.0.1:8081</span><br><span class="line">18:25:28.768 [ConfigProxy] info: 201 POST /api/routes/</span><br><span class="line">[I 2024-08-15 18:25:28.768 JupyterHub app:3731] JupyterHub is now running at http://:8000</span><br></pre></td></tr></table></figure>

<p>如果运行的时候发现没有 Kernel，那么可以通过如下命令来安装 Kernel，然后重启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看有没有安装内核</span></span><br><span class="line">jupyter kernelspec list</span><br><span class="line"><span class="comment"># 如果没有的话，添加 IPyKernel</span></span><br><span class="line"><span class="comment"># 这条命令将当前 Python 环境作为一个新的内核安装到 Jupyter 中，安装在用户级别目录</span></span><br><span class="line">python -m ipykernel install --user --name 内核名称 --display-name <span class="string">&quot;内核显示名称&quot;</span></span><br><span class="line"><span class="comment"># 注意，这条命令是用来删除已经安装的内核。如果需要删除内核的话，执行下面命令。</span></span><br><span class="line">jupyter kernelspec remove 内核名称</span><br></pre></td></tr></table></figure>

<h2 id="自定义认证"><a href="#自定义认证" class="headerlink" title="自定义认证"></a>自定义认证</h2><h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>首先介绍如何在 Pycharm 中将 Jupyter 跑起来，方便进行开发调试（如果你不是 Python 开发的话，相信对你会有帮助😄）。</p>
<p>添加如下面图片中的运行配置，需要注意的需要是以 module 的方式去运行项目的入口 jupyter&#x2F;app.py 文件，然后设置以下命令参数 -f xx，最后设置项目的工作目录为 jupyterhub 项目的根目录。然后就可以愉快的运行调试了👍。</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/image-20240816110455495.png" alt="Pycharm run/debug configuration" style="zoom:50%;" />

<p>下面解释一下为什么需要以 module 的方式去运行入口文件。</p>
<ul>
<li><p>以 scripy 方式运行文件相当于直接使用 <code>python xxx</code>。</p>
</li>
<li><p>以 module 方式运行文件相当于使用<code>python -m xxx</code>。</p>
</li>
<li><p><strong>路径处理</strong>: 运行 script 时，Python 会根据文件的物理路径直接执行，而运行 module 时，Python 会处理模块路径并将模块的顶级目录添加到 <code>sys.path</code>。</p>
</li>
<li><p><strong>导入方式</strong>: 在 module 运行时，Python 可以处理相对导入，而 script 运行时则不能直接处理相对导入（因为脚本是作为独立的 <code>__main__</code> 执行的，没有包的上下文）。</p>
</li>
<li><p><strong>适用场景</strong>: script 方式适合单文件或测试文件的简单执行，而 module 方式则适合复杂的包结构，尤其是涉及包内相对导入或模块内部的命名空间管理时。</p>
</li>
</ul>
<p>这两种方式的选择取决于你的项目结构和需要执行的代码位置。在大型项目或需要调试模块化代码时，使用模块方式通常更合适。如果喜欢通过命令行进行调试的话，也可以使用 pdb （类似 gdb）来调试项目。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>由于我们对 Jupyter Notebook 进行了二次开发，需要将其作为一个服务集成到我们的图数据分析平台中。因此，我们需要自定义JupyterHub 的认证机制，使其与平台中的认证机制一致。目前，我们的图数据分析平台采用基于 JWT 的令牌认证方式。因此，我们需要在 JupyterHub 中实现基于 JWT 的自定义认证机制。</p>
<p>下面是认证过程的时序图，过程如下所述：</p>
<ul>
<li><p><strong>用户访问入口</strong>: 用户通过浏览器访问 Jupyter Hub，最初的请求到达 <code>Proxy</code>。</p>
</li>
<li><p><strong>跳转 SSO</strong>: 如果验证 token 失败，<code>Proxy</code> 会将请求重定向到 SSO 系统进行认证。</p>
</li>
<li><p><strong>SSO 登录</strong>: 用户完成 SSO 登录，SSO 系统将结果回调到 <code>Hub</code>。</p>
</li>
<li><p><strong>实例申请和创建</strong>: <code>Hub</code> 接收回调后，为用户请求在 本地创建一个新的 Jupyter Server 实例。</p>
</li>
<li><p><strong>实例创建</strong>: 创建实例后，返回相关信息给 <code>Hub</code>。</p>
</li>
<li><p><strong>配置和跳转</strong>: <code>Hub</code> 设置转发规则，然后将用户的请求重定向到 <code>&lt;username&gt;</code> 路径。</p>
</li>
<li><p><strong>访问 JupyterLab</strong>: 用户浏览器访问 <code>&lt;username&gt;</code> 路径，加载 Jupyter Lab 界面。</p>
</li>
<li><p><strong>代码执行和结果返回</strong>: 用户在 Jupyter Lab 中请求执行代码，转发给 Jupyter Server 执行，最终返回执行结果给用户浏览器。</p>
</li>
</ul>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/notebook-login-sequence-chart.png" alt="notebook-login-sequence-chart" style="zoom:20%;" />

<p>下面将介绍如何实现 Jupyter Hub 的自定义认证。</p>
<p>我们使用 <a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner/tree/main/examples">DockerSpawner</a> 来创建新的 Jupyter Server 实例，会为每个用户创建一个容器来运行 Jupyter Server。所以，Jupyter Hub 会和用户容器里的 Server 通信。如果 Jupyter Hub 部署在本地的话，和容器通信是不方便的，所以我们将 Jupyter Hub 放在容器里面部署，将 Jupyter Hub 容器 和 用户实例容器放在一个 network 里面，这样这些容器就可以相互通信。也许你会有疑问，Jupyter Hub 容器里面没有安装 docker，DockerSpawner 如何创建容器呢？我们可以将本地主机的 Docker 守护进程的 Unix 套接字文件（<code>/var/run/docker.sock</code>）挂载到 Jupyter Hub 容器中的相同位置，这样容器内的应用可以像主机上的任何 Docker 客户端一样，与 Docker 守护进程通信，执行 Docker 命令。</p>
<p>首先，我们通过编写一个 Dockerfile 来安装 Jupyter Hub，我们希望能在本地连接这个容器进行开发调试，所以我们像之前一样，自己编译这些组件。下面是 Dockerfile 的内容。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Python 3.12 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装必要的系统依赖，包括 curl、git、vim 和 SSH 服务器</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    git \</span></span><br><span class="line"><span class="language-bash">    vim \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    openssh-server \</span></span><br><span class="line"><span class="language-bash">    apt-transport-https \</span></span><br><span class="line"><span class="language-bash">    ca-certificates \</span></span><br><span class="line"><span class="language-bash">    gnupg-agent \</span></span><br><span class="line"><span class="language-bash">    software-properties-common \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /srv/jupyterhub</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置SSH服务器</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /var/run/sshd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置root用户的密码（注意：这是不安全的，仅用于开发环境）</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;root:password&#x27;</span> | chpasswd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许root用户通过SSH登录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/#PermitRootLogin prohibit-password/PermitRootLogin yes/&#x27;</span> /etc/ssh/sshd_config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用PAM限制</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s@session    required   pam_loginuid.so@session    optional   pam_loginuid.so@g&#x27;</span> /etc/pam.d/sshd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露必要的端口，包括SSH端口22</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22</span> <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动SSH服务并进入交互式 shell</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> service ssh start &amp;&amp; bash</span></span><br></pre></td></tr></table></figure>

<p>执行下面的命令构建镜像。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t jupyterhub-dev .</span><br></pre></td></tr></table></figure>

<p>执行下面的命令创建 network。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create jupyterhub</span><br></pre></td></tr></table></figure>

<p>执行下面的命令运行容器，映射本地存储和端口。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name jupyterhub-dev \</span><br><span class="line">	-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">	--net jupyterhub \</span><br><span class="line">  -v /Users/tom/notebook-service-demo/docker-image/source-code:/srv/jupyterhub \</span><br><span class="line">  -p 8000:8000 \</span><br><span class="line">  -p 16022:22 \</span><br><span class="line">  jupyterhub-dev</span><br></pre></td></tr></table></figure>

<p>然后在本地的 <code>/Users/docker-image/source-code</code> 目录下，clone Jupyter Server、Jupyter lab 和 Jupyter Hub 的源码。执行 <code>docker attach jupyterhub-dev</code> 进入容器的命令行，按照“安装部署”小节中的内容进行编译刚刚 clone 下来的源码。注意编译 Jupyter Lab 的时候，如果报错，先尝试运行下 <code>yarn install</code> 。</p>
<p>接下来，在本地的 Pycharm 中打开映射的文件夹里的 JupyterHub 源码，然后通过 SSH 使用容器内的编译器。这样就可以愉快的使用容器内的环境进行开发了，本地更新的代码也会同步到容器内。按照上面“调试”小节中的内容去操作就行。</p>
<p>下面是实现自定义认证的代码。</p>
<p>我们先编写一个自定义认证器，用于实现 JWT 的验证逻辑。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> jupyterhub.auth <span class="keyword">import</span> Authenticator</span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</span><br><span class="line"><span class="keyword">from</span> jwt.exceptions <span class="keyword">import</span> ExpiredSignatureError, InvalidTokenError</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JWTAuthenticator</span>(<span class="title class_ inherited__">Authenticator</span>):</span><br><span class="line">  secret = <span class="string">&quot;your_secret&quot;</span></span><br><span class="line">  authKeyFormat=<span class="string">&quot;auth_token_key:&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 初始化 Redis 连接</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">    <span class="built_in">super</span>().__init__(**kwargs)</span><br><span class="line">    <span class="comment"># 根据 Redis 配置进行修改，host 为运行 redis 的容器名</span></span><br><span class="line">    <span class="comment"># 如果 Redis 在容器中启动，则需要加入和 Jupyter Hub 容器所在的 network 内</span></span><br><span class="line">    <span class="variable language_">self</span>.redis_client = redis.StrictRedis(host=<span class="string">&#x27;redis&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_user_id_from_token</span>(<span class="params">self, token</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      <span class="comment"># Debug log for the token being decoded</span></span><br><span class="line">      <span class="variable language_">self</span>.log.info(<span class="string">f&quot;Decoding token: <span class="subst">&#123;token&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">      payload = jwt.decode(token, <span class="variable language_">self</span>.secret, algorithms=[<span class="string">&#x27;HS384&#x27;</span>])</span><br><span class="line">      <span class="variable language_">self</span>.log.info(<span class="string">f&quot;Decoded payload: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">      user_id = payload.get(<span class="string">&quot;sub&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span> user_id:</span><br><span class="line">        <span class="keyword">return</span> user_id</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="variable language_">self</span>.log.warning(<span class="string">&quot;No user ID found in token&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> ExpiredSignatureError:</span><br><span class="line">      <span class="variable language_">self</span>.log.warning(<span class="string">&quot;Token has expired&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> InvalidTokenError <span class="keyword">as</span> e:</span><br><span class="line">      <span class="variable language_">self</span>.log.warning(<span class="string">f&quot;Invalid token: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">      <span class="variable language_">self</span>.log.warning(<span class="string">f&quot;Error decoding token: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  @gen.coroutine</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, handler, data=<span class="literal">None</span></span>):</span><br><span class="line">    token = handler.request.headers.get(<span class="string">&#x27;Authorization&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">      <span class="variable language_">self</span>.log.warning(<span class="string">&quot;No Authorization header provided&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    user_id = <span class="variable language_">self</span>.get_user_id_from_token(token)</span><br><span class="line">    authKey = <span class="variable language_">self</span>.authKeyFormat.<span class="built_in">format</span>(user_id)</span><br><span class="line">    <span class="keyword">if</span> user_id:</span><br><span class="line">      <span class="comment"># 从 Redis 中获取 user_id 的值</span></span><br><span class="line">      user_exists = <span class="variable language_">self</span>.redis_client.exists(authKey)</span><br><span class="line">      <span class="keyword">if</span> user_exists:</span><br><span class="line">        <span class="keyword">return</span> user_id</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="variable language_">self</span>.log.warning(<span class="string">f&quot;User ID <span class="subst">&#123;user_id&#125;</span> not found in Redis&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后编写配置文件使用上述自定义认证器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyterhub.auth <span class="keyword">import</span> LocalAuthenticator</span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取配置文件所在目录的绝对路径</span></span><br><span class="line">current_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"><span class="built_in">print</span>(current_dir)</span><br><span class="line"><span class="comment"># 添加当前目录到 Python 路径</span></span><br><span class="line">sys.path.insert(<span class="number">0</span>, current_dir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jwt_authenticator <span class="keyword">import</span> JWTAuthenticator</span><br><span class="line"><span class="keyword">from</span> dockerspawner <span class="keyword">import</span> DockerSpawner</span><br><span class="line"></span><br><span class="line"><span class="comment"># Jupyter Hub 的配置文件</span></span><br><span class="line"></span><br><span class="line">c = get_config()  <span class="comment"># noqa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置所有用户都可以登录</span></span><br><span class="line">c.Authenticator.allow_all = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 SimpleAuthenticator 进行基于操作系统用户的认证</span></span><br><span class="line">c.JupyterHub.authenticator_class = JWTAuthenticator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认启动 JupyterLab，而不是经典的 Jupyter Notebook 界面</span></span><br><span class="line">c.Spawner.default_url = <span class="string">&#x27;/lab&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 DockerSpawner</span></span><br><span class="line">c.JupyterHub.spawner_class = DockerSpawner</span><br><span class="line"></span><br><span class="line"><span class="comment"># DockerSpawner 的配置</span></span><br><span class="line"><span class="comment"># 设置每次创建实例使用的镜像</span></span><br><span class="line">c.DockerSpawner.image = <span class="string">&#x27;jupyter/minimal-notebook&#x27;</span></span><br><span class="line"><span class="comment"># 设置使用 docker 的自定义网络</span></span><br><span class="line">c.DockerSpawner.network_name = <span class="string">&#x27;jupyterhub&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们需要 hub 在容器中监听所有 IP</span></span><br><span class="line">c.JupyterHub.hub_ip = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line"><span class="comment"># 用于连接 hub 的主机名/IP</span></span><br><span class="line"><span class="comment"># 这通常是 hub 容器的名称</span></span><br><span class="line">c.JupyterHub.hub_connect_ip = <span class="string">&#x27;jupyterhub-dev&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用 XSRF 跨域保护，运行跨域请求</span></span><br><span class="line">c.JupyterHub.tornado_settings = &#123;</span><br><span class="line">  <span class="string">&#x27;xsrf_cookies&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后使用上面的配置文件启动 Jupyter Hub 。通过 apifox 发送下面的请求，将获取的 cookie 存入到浏览器上的 <a target="_blank" rel="noopener" href="http://localhost:8000/">http://localhost:8000</a> 上，打开 <a target="_blank" rel="noopener" href="http://localhost:8000/hub/%E3%80%82%E5%A6%82%E6%9E%9C%E5%8F%AF%E4%BB%A5%E6%88%90%E5%8A%9F%E6%89%93%E5%BC%80%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%88%90%E5%8A%9F%E5%95%A6%F0%9F%98%84%E3%80%82">http://localhost:8000/hub/。如果可以成功打开，就是成功啦😄。</a></p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/image-20240818135051043.png" alt="apifox-1" style="zoom:33%;" />


<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这篇文章介绍了 Jupyter 二次开发的初步思路。首先介绍项目的需求。接着我们的进一步介绍架构设计，使用了哪些组件。然后介绍了如何编译安装部署 Jupyter Hub 及相关组件。最后在 docker 上实现了 Jupyter Hub 的自定义的 JWT 认证。</p>
<p>需要注意的是，目前的我们的架构会存在下面这些问题，这些问题也是之后需要优化。</p>
<ol>
<li>hub 单点故障会导致全部实例使用不了</li>
<li>文件存在实例本地，hub 挂掉就找不到了</li>
<li>升级比较复杂，需要给挨个实例升级</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://z2jh.jupyter.org/en/stable/index.html">Zero to JupyterHub with Kubernetes</a></p>
<p><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/authenticators.html">Jupyter Hub Authenticators</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wLp-ZJaXvZO85FiFXdJafw">字节博客</a></p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2019/11/21/application-practice-jupyter.html">美团博客</a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/" rel="tag">Jupyter 二次开发</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/08/14/K8s-%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0/">K8s 原理简述</a><a class="next" href="/2024/08/08/Jupyter-%E9%A1%B9%E7%9B%AE%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D/">Jupyter 项目工作原理介绍</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Java-%E5%90%8E%E7%AB%AF/" style="font-size: 15px;">Java 后端</a> <a href="/tags/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/" style="font-size: 15px;">Jupyter 二次开发</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 15px;">教程</a> <a href="/tags/%E6%84%9F%E6%82%9F/" style="font-size: 15px;">感悟</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 联系我</i></div><ul></ul><a href="mailto:trl2025@163.com" title="Mail" target="_blank">Mail</a><ul></ul><a href="https://github.com/rongliangtang" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://space.bilibili.com/28159312" title="Bilibili" target="_blank">Bilibili</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 Tom</div></div></div><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>