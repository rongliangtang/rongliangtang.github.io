<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="è¿™æ˜¯RongLiangçš„åšå®¢,ç”¨æ¥åˆ†äº«æŠ€æœ¯çŸ¥è¯†å’Œä¸€äº›æ„Ÿæ‚Ÿã€‚"><title>Jupyter äºŒæ¬¡å¼€å‘æ€è·¯ï¼ˆ1ï¼‰ | Tom's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Jupyter äºŒæ¬¡å¼€å‘æ€è·¯ï¼ˆ1ï¼‰</h1><a id="logo" href="/.">Tom's Blog</a><p class="description">é‡è›®ç”Ÿé•¿</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> æ–‡ç« </i></a><a href="/archives/"><i class="fa undefined"> æ€»è§ˆ</i></a><a href="/about/"><i class="fa undefined"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Jupyter äºŒæ¬¡å¼€å‘æ€è·¯ï¼ˆ1ï¼‰</h1><div class="post-meta">2024-08-13</div><div class="post-content"><p>ä¸Šç¯‡æ–‡ç« ä»‹ç»äº† Jupyter ç”Ÿæ€åŠé‡è¦ç»„ä»¶çš„åŸç†ã€‚åŸºäºä¹‹å‰çš„å†…å®¹ï¼Œæœ¬æ–‡ä»‹ç» Jupyter äºŒæ¬¡å¼€å‘çš„æ€è·¯ã€‚é¦–å…ˆä»‹ç»é¡¹ç›®çš„éœ€æ±‚ï¼Œæ¥ç€è¿›ä¸€æ­¥ä»‹ç»æ¶æ„è®¾è®¡ï¼Œè¿›è¡Œdemoçš„å®ç°ï¼Œæœ€åè¿›è¡Œæ€»ç»“ã€‚</p>
<span id="more"></span>

<h2 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h2><p>å®ç°å›¾æ•°æ®ç®¡ç†åˆ†æ BI å¹³å°çš„ Notebook Serviceï¼Œå…·å¤‡æ•°æ®çš„æ¢ç´¢ã€æ‰§è¡Œåˆ†æä»»åŠ¡ã€sql æ“ä½œã€spark æ“ä½œç­‰åŠŸèƒ½ã€‚è¿™ä¸ªå¹³å°ç›®å‰æ˜¯å•ç§Ÿæˆ·çš„æ¶æ„ï¼Œæ˜¯ to b çš„ã€‚ä¸€èˆ¬æ˜¯å…¬å¸çš„æ•°æ®åˆ†æå›¢é˜Ÿä½¿ç”¨ï¼Œä¸€ä¸ªå›¢é˜Ÿä¸€èˆ¬æ˜¯åå‡ ä¸ªäººï¼Œå†™ä»£ç ç”¨åˆ° Notebook çš„å¯èƒ½ä¹Ÿå°±é‚£ä¹ˆå‡ ä¸ªäººã€‚æ‰€ä»¥å¯¹æ€§èƒ½å’Œå¯ç”¨æ€§æ²¡æœ‰åƒ to c çš„äº§å“è¦æ±‚é‚£ä¹ˆé«˜ã€‚</p>
<p>æ€»ç»“ä¸‹æ¥ï¼Œæˆ‘ä»¬çš„ Notebook Service åº”è¯¥å…·å¤‡ä¸‹é¢çš„åŠŸèƒ½ï¼š</p>
<ul>
<li>æä¾›ç»™ç”¨æˆ·å¼€ç®±å³ç”¨çš„ç¯å¢ƒ</li>
<li>éš”ç¦»ç”¨æˆ·çš„ç¯å¢ƒï¼Œé¿å…äº’ç›¸æ±¡æŸ“</li>
<li>æ¥å…¥ sparkã€adbã€oss ç­‰å¹³å°èµ„æºä¾›ç”¨æˆ·è¿›è¡Œæ¢æŸ¥ã€åˆ†æ</li>
</ul>
<p>ç›®å‰æ‰“ç®—å…ˆå¿«é€ŸæŠŠæ¶æ„æ­èµ·æ¥ï¼Œå…ˆä½¿ç”¨è‡ªå¸¦çš„ IPython å†…æ ¸ï¼Œåé¢å†æ¥å…¥å¹³å°çš„å¯¹è±¡å­˜å‚¨ã€æ•°æ®åº“å’Œ spark é›†ç¾¤ç­‰èµ„æºã€‚</p>
<h2 id="æ¶æ„è®¾è®¡"><a href="#æ¶æ„è®¾è®¡" class="headerlink" title="æ¶æ„è®¾è®¡"></a>æ¶æ„è®¾è®¡</h2><p>ç»è¿‡è°ƒç ”ï¼Œå†³å®šé‡‡ç”¨ä¸‹é¢ç»„ä»¶æ¥ç»„åˆå®ç°ï¼š</p>
<ul>
<li><strong>å‰ç«¯</strong> ä½¿ç”¨ç»å…¸çš„ Jupyter Notebook ç»„ä»¶ï¼Œå› ä¸ºé¡¹ç›®ä¸éœ€è¦å¤ªå¤šçš„åŠŸèƒ½ï¼Œåªéœ€è¦å®ç°ç®€å•çš„ Notebook åŠŸèƒ½å°±è¡Œã€‚</li>
<li><strong>æœåŠ¡ç«¯</strong> ä½¿ç”¨ Jupyter Server æ¥è½¬å‘å‰ç«¯çš„è¯·æ±‚ç»™å†…æ ¸æ‰§è¡Œã€‚</li>
<li><strong>å†…æ ¸</strong> è´Ÿè´£æ‰§è¡Œä»£ç ï¼Œå°†ç»“æœè¿”å›æœåŠ¡ç«¯ã€‚æš‚æ—¶ä½¿ç”¨ IPython Kernelï¼Œåé¢å†æ¥å…¥å¹³å°çš„å¯¹è±¡å­˜å‚¨ã€æ•°æ®åº“å’Œ spark é›†ç¾¤ç­‰èµ„æºã€‚</li>
<li><strong>éƒ¨ç½²</strong> ä½¿ç”¨ Jupyter Hub ç»„ä»¶ï¼Œç”¨äºä¸ºå®ç°å¤šç”¨æˆ·æä¾› Notebookï¼Œå³ä¸åŒç”¨æˆ·ä½¿ç”¨ä¸åŒçš„ Jupyter Server å’Œ Kernelã€‚<ul>
<li><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/authenticators.html">Authenticators</a>ï¼šå®ç°è‡ªå®šä¹‰ç™»å½•é‰´æƒï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ Authenticator ç±»å¹¶åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šæ¥å®ç°ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/spawners.html">Spawners</a>ï¼šç”¨æˆ·ç™»å½•æ—¶ï¼ŒJupyter Hub ä¼šç”¨ç”¨æˆ·å¯åŠ¨ä¸€ä¸ªæ–°å®ä¾‹ï¼ˆJupyter Server + Kernelï¼‰ã€‚å¯åŠ¨å®ä¾‹æ˜¯é€šè¿‡ Spawner å®ç°çš„ã€‚å®˜æ–¹æä¾›äº†å¤šç§ Spawner çš„å®ç°ï¼ŒåŒ…æ‹¬ï¼šæœ¬æœºæ–°çš„Notebook Serverè¿›ç¨‹ã€æœ¬æœºå¯åŠ¨Dockerå®ä¾‹ã€K8sç³»ç»Ÿä¸­å¯åŠ¨æ–°çš„Podã€YARNä¸­å¯åŠ¨æ–°çš„å®ä¾‹ç­‰ç­‰ã€‚è¿™äº›å®ç°æœ¬èº«æ˜¯å¯é…ç½®çš„ã€‚å¦‚æœä¸ç¬¦åˆéœ€æ±‚ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å¼€å‘å…¨æ–°çš„ Spawnerã€‚åç»­æˆ‘ä»¬éœ€è¦æ¥å…¥ spark å’Œ æ•°æ®åº“ç­‰èµ„æºï¼Œå¯ä»¥åŸºäºå®˜æ–¹æä¾›çš„ Spawner è¿›è¡Œå®šåˆ¶ï¼Œæ¥æ¥å…¥èµ„æºã€‚</li>
</ul>
</li>
</ul>
<p>æ•´ä¸ªæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ä¸åŒçš„å®¢æˆ·ç«¯é€šè¿‡ JupyterHub è¿›è¡Œç™»å½•éªŒè¯åï¼Œå¯ä»¥é€šè¿‡ Jupyter Notebook å‰ç«¯ï¼Œè®¿é—®å¯¹åº”çš„å®ä¾‹ã€‚æ¯ä¸ªå®ä¾‹å³ K8s çš„ podï¼Œä¸åŒ pod ä¹‹é—´çš„èµ„æºæ˜¯éš”ç¦»çš„ã€‚</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/notebook-architecture.png" alt="notebook-architecture" style="zoom:20%;" />

<h2 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h2><p>ä¸‹é¢åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ª Jupyter Hubï¼Œä»å„ä¸ªç»„ä»¶çš„æºç è¿›è¡Œç¼–è¯‘ã€‚è™½ç„¶å„ä¸ªç»„ä»¶éƒ½å¯ä»¥é€šè¿‡æ‰©å±•çš„æ–¹å¼å»å¼€å‘ï¼Œä½†æ˜¯åæœŸå¦‚æœæœ‰å¤æ‚çš„æ¶æ„çš„è¯ï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹ç›¸å…³çš„æºç ï¼Œæ‰€ä»¥é€šè¿‡åœ¨æœ¬åœ°å»ç¼–è¯‘å„ä¸ªç»„ä»¶çš„æºç ï¼Œå»éƒ¨ç½² Jupyter Hubã€‚åœ¨æœ¬åœ°å®Œæˆå¼€å‘åï¼Œå¯ä»¥æ‰“åŒ…æˆé•œåƒï¼Œç„¶åå‚è€ƒ <a target="_blank" rel="noopener" href="https://z2jh.jupyter.org/en/stable/jupyterhub/customizing/user-environment.html">ç¤¾åŒºçš„æ•™ç¨‹</a> éƒ¨ç½²åˆ° K8s ä¸Šã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… IPyKernel</span></span><br><span class="line">pip install ipykernel -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ Jupyter Server</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/jupyter-server/jupyter_server.git</span><br><span class="line"><span class="built_in">cd</span> jupyter_server</span><br><span class="line">pip install -v -e .</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ Jupyter Lab å‰ç«¯</span></span><br><span class="line"><span class="comment"># éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›´æ¥ç¼–è¯‘ Jupyter Labï¼Œä¼šè‡ªåŠ¨å®‰è£… IPyKernel å’Œ Jupyter Server ç­‰ä¾èµ–</span></span><br><span class="line"><span class="comment"># æˆ‘ä»¬å°†è¿™äº›æ­¥éª¤æ”¾åœ¨å‰é¢å…ˆç¼–è¯‘å®‰è£…äº†ï¼Œæ–¹ä¾¿ç†è§£</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/jupyterlab/jupyterlab.git</span><br><span class="line"><span class="built_in">cd</span> jupyterlab</span><br><span class="line"><span class="comment"># å¦‚æœæ‰§è¡Œ pip install -v -e . æŠ¥é”™ï¼Œå°±å…ˆå°è¯•æ‰§è¡Œ yarn install å®‰è£…å‰ç«¯çš„ä¾èµ–</span></span><br><span class="line">yarn install</span><br><span class="line">pip install -v -e .</span><br><span class="line"><span class="comment"># build å‰ç«¯èµ„æº</span></span><br><span class="line">jupyter lab build</span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Jupyter Hub çš„ proxyï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ç”¨æˆ·çš„è¯·æ±‚è·¯ç”±ç»™å¯¹åº”çš„ Jupyter Server</span></span><br><span class="line">npm install -g configurable-http-proxy --registry=https://registry.npmmirror.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ Jupyter Hub</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/jupyterhub/jupyterhub.git</span><br><span class="line"><span class="built_in">cd</span> jupyterhub</span><br><span class="line">pip install -v -e .</span><br><span class="line"><span class="built_in">cd</span> ../</span><br></pre></td></tr></table></figure>

<p>å›é¡¾ä¸€ä¸‹ä¹‹å‰çš„ç®€åŒ–æ¶æ„å›¾ï¼Œä¼šå‘ç°ä¸Šè¿°å‘½ä»¤å°†éœ€è¦ç”¨åˆ°çš„é‡è¦ç»„ä»¶éƒ½å®‰è£…åˆ°äº†ã€‚ JupyterHub ç®¡ç†å¤šä¸ªç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½æœ‰ç‹¬ç«‹çš„å•ç”¨æˆ·æœåŠ¡å™¨å®ä¾‹ï¼ŒåŒ…æ‹¬ Jupyter Lab ç•Œé¢ã€Jupyter Server å’Œ IPython å†…æ ¸ã€‚ç”¨æˆ·é€šè¿‡ JupyterLab äº¤äº’ç•Œé¢ç¼–å†™å’Œæ‰§è¡Œä»£ç ï¼ŒJupyter Server å¤„ç†è¯·æ±‚å¹¶ä¸å†…æ ¸é€šä¿¡æ‰§è¡Œä»£ç ï¼Œæœ€ç»ˆå°†ç»“æœè¿”å›ç»™ç”¨æˆ·ï¼Œå®ç°äº†å¤šç”¨æˆ·çš„äº¤äº’å¼è®¡ç®—ç¯å¢ƒã€‚</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/7189fdd91099e1a8ba7e792ce592da9529878.png" alt="Jupyter æ¶æ„ç®€åŒ–å›¾" style="zoom:50%;" />

<p>ä¸Šé¢å®‰è£…å¥½äº† Jupyter çš„æœ¬åœ°ç¯å¢ƒåï¼Œæ¥ä¸‹æ¥ä»‹ç»å¦‚ä½•è·‘èµ·æ¥ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ç”¨æ¥å­˜æ”¾é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">mkdir</span> jupyterhub-config &amp;&amp; <span class="built_in">cd</span> jupyterhub-config</span><br><span class="line"><span class="comment"># ç”Ÿæˆé…ç½®æ–‡ä»¶</span></span><br><span class="line">jupyterhub --generate-config</span><br></pre></td></tr></table></figure>

<p> æŒ‰ä¸‹é¢çš„é…ç½®è¿›è¡Œä¿®æ”¹ï¼Œå„ä¸ªé…ç½®æ³¨é‡Šéƒ½æœ‰è§£é‡Šï¼Œä¹Ÿå¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/config-reference.html">è¿™é‡Œ</a>ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ PAM è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯ï¼Œç”¨æˆ·é€šè¿‡æ“ä½œç³»ç»Ÿä¸­çš„æœ‰æ•ˆç”¨æˆ·åå’Œå¯†ç è¿›è¡ŒéªŒè¯</span></span><br><span class="line">c.JupyterHub.authenticator_class = <span class="string">&#x27;jupyterhub.auth.PAMAuthenticator&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®©èƒ½é€šè¿‡éªŒè¯çš„ç”¨æˆ·æˆåŠŸè®¿é—® Hub</span></span><br><span class="line">c.Authenticator.allow_all = <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥ jupyterhub_config.py ä¸­çš„é…ç½®è¿è¡Œjupyterhub</span></span><br><span class="line">jupyterhub -f jupyterhub_config.py</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶å°ä¼šç±»ä¼¼è¾“å‡ºä¸‹é¢çš„å†…å®¹ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ 8081 ç«¯å£æ˜¯ <strong>Hub API</strong> çš„ç›‘å¬ç«¯å£ï¼Œç”¨äºä¸å…¶ä»–ç»„ä»¶ï¼ˆå¦‚ Proxy å’Œ Spawnerï¼‰è¿›è¡Œé€šä¿¡çš„æ¥å£ï¼Œåªå¯¹ JupyterHub çš„å†…éƒ¨é€šä¿¡å¼€æ”¾ï¼Œä¸ç›´æ¥å¯¹å¤–æä¾›æœåŠ¡ã€‚</p>
<p>8000 ç«¯å£æ˜¯ JupyterHub <strong>Proxy</strong> çš„ç›‘å¬ç«¯å£ï¼Œè´Ÿè´£å°†ç”¨æˆ·çš„è¯·æ±‚ä»è¿™ä¸ªç«¯å£è½¬å‘åˆ°å¯¹åº”çš„ Jupyter Server æœåŠ¡ï¼Œè¿™ä¸ªç«¯å£é€šå¸¸å¯¹å¤–å¼€æ”¾ï¼Œç”¨æˆ·é€šè¿‡è¿™ä¸ªç«¯å£è®¿é—® JupyterHub çš„ Web ç•Œé¢ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨æµè§ˆå™¨æ‰“å¼€ <code>http://127.0.0.1:8000</code>ï¼Œè¾“å…¥ç”µè„‘çš„ç™»å½•è´¦å·å’Œå¯†ç å°±å¯ä»¥ç™»å½•æˆåŠŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[I 2024-08-15 18:25:27.339 JupyterHub app:3307] Running JupyterHub version 5.2.0.dev</span><br><span class="line">[I 2024-08-15 18:25:27.339 JupyterHub app:3337] Using Authenticator: jupyterhub.auth.PAMAuthenticator-5.2.0.dev</span><br><span class="line">[I 2024-08-15 18:25:27.339 JupyterHub app:3337] Using Spawner: jupyterhub.spawner.LocalProcessSpawner-5.2.0.dev</span><br><span class="line">[I 2024-08-15 18:25:27.339 JupyterHub app:3337] Using Proxy: jupyterhub.proxy.ConfigurableHTTPProxy-5.2.0.dev</span><br><span class="line">[I 2024-08-15 18:25:27.342 JupyterHub app:1882] Writing cookie_secret to /jupyterhub_cookie_secret</span><br><span class="line">[I 2024-08-15 18:25:27.764 alembic.runtime.migration migration:215] Context impl SQLiteImpl.</span><br><span class="line">[I 2024-08-15 18:25:27.764 alembic.runtime.migration migration:218] Will assume non-transactional DDL.</span><br><span class="line">[I 2024-08-15 18:25:27.768 alembic.runtime.migration migration:623] Running stamp_revision  -&gt; 4621fec11365</span><br><span class="line">[I 2024-08-15 18:25:27.827 JupyterHub proxy:556] Generating new CONFIGPROXY_AUTH_TOKEN</span><br><span class="line">[I 2024-08-15 18:25:27.844 JupyterHub app:3376] Initialized 0 spawners <span class="keyword">in</span> 0.003 seconds</span><br><span class="line">[I 2024-08-15 18:25:27.846 JupyterHub metrics:373] Found 0 active <span class="built_in">users</span> <span class="keyword">in</span> the last ActiveUserPeriods.twenty_four_hours</span><br><span class="line">[I 2024-08-15 18:25:27.846 JupyterHub metrics:373] Found 0 active <span class="built_in">users</span> <span class="keyword">in</span> the last ActiveUserPeriods.seven_days</span><br><span class="line">[I 2024-08-15 18:25:27.846 JupyterHub metrics:373] Found 0 active <span class="built_in">users</span> <span class="keyword">in</span> the last ActiveUserPeriods.thirty_days</span><br><span class="line">[W 2024-08-15 18:25:27.846 JupyterHub proxy:748] Running JupyterHub without SSL.  I hope there is SSL termination happening somewhere <span class="keyword">else</span>...</span><br><span class="line">[I 2024-08-15 18:25:27.846 JupyterHub proxy:752] Starting proxy @ http://:8000</span><br><span class="line">18:25:28.383 [ConfigProxy] info: Proxying http://*:8000 to (no default)</span><br><span class="line">18:25:28.384 [ConfigProxy] info: Proxy API at http://127.0.0.1:8001/api/routes</span><br><span class="line">18:25:28.763 [ConfigProxy] info: 200 GET /api/routes</span><br><span class="line">[I 2024-08-15 18:25:28.763 JupyterHub app:3690] Hub API listening on http://127.0.0.1:8081/hub/</span><br><span class="line">18:25:28.765 [ConfigProxy] info: 200 GET /api/routes</span><br><span class="line">[I 2024-08-15 18:25:28.765 JupyterHub proxy:477] Adding route <span class="keyword">for</span> Hub: / =&gt; http://127.0.0.1:8081</span><br><span class="line">18:25:28.767 [ConfigProxy] info: Adding route / -&gt; http://127.0.0.1:8081</span><br><span class="line">18:25:28.768 [ConfigProxy] info: Route added / -&gt; http://127.0.0.1:8081</span><br><span class="line">18:25:28.768 [ConfigProxy] info: 201 POST /api/routes/</span><br><span class="line">[I 2024-08-15 18:25:28.768 JupyterHub app:3731] JupyterHub is now running at http://:8000</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¿è¡Œçš„æ—¶å€™å‘ç°æ²¡æœ‰ Kernelï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥å®‰è£… Kernelï¼Œç„¶åé‡å¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æœ‰æ²¡æœ‰å®‰è£…å†…æ ¸</span></span><br><span class="line">jupyter kernelspec list</span><br><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰çš„è¯ï¼Œæ·»åŠ  IPyKernel</span></span><br><span class="line"><span class="comment"># è¿™æ¡å‘½ä»¤å°†å½“å‰ Python ç¯å¢ƒä½œä¸ºä¸€ä¸ªæ–°çš„å†…æ ¸å®‰è£…åˆ° Jupyter ä¸­ï¼Œå®‰è£…åœ¨ç”¨æˆ·çº§åˆ«ç›®å½•</span></span><br><span class="line">python -m ipykernel install --user --name å†…æ ¸åç§° --display-name <span class="string">&quot;å†…æ ¸æ˜¾ç¤ºåç§°&quot;</span></span><br><span class="line"><span class="comment"># æ³¨æ„ï¼Œè¿™æ¡å‘½ä»¤æ˜¯ç”¨æ¥åˆ é™¤å·²ç»å®‰è£…çš„å†…æ ¸ã€‚å¦‚æœéœ€è¦åˆ é™¤å†…æ ¸çš„è¯ï¼Œæ‰§è¡Œä¸‹é¢å‘½ä»¤ã€‚</span></span><br><span class="line">jupyter kernelspec remove å†…æ ¸åç§°</span><br></pre></td></tr></table></figure>

<h2 id="è‡ªå®šä¹‰è®¤è¯"><a href="#è‡ªå®šä¹‰è®¤è¯" class="headerlink" title="è‡ªå®šä¹‰è®¤è¯"></a>è‡ªå®šä¹‰è®¤è¯</h2><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>é¦–å…ˆä»‹ç»å¦‚ä½•åœ¨ Pycharm ä¸­å°† Jupyter è·‘èµ·æ¥ï¼Œæ–¹ä¾¿è¿›è¡Œå¼€å‘è°ƒè¯•ï¼ˆå¦‚æœä½ ä¸æ˜¯ Python å¼€å‘çš„è¯ï¼Œç›¸ä¿¡å¯¹ä½ ä¼šæœ‰å¸®åŠ©ğŸ˜„ï¼‰ã€‚</p>
<p>æ·»åŠ å¦‚ä¸‹é¢å›¾ç‰‡ä¸­çš„è¿è¡Œé…ç½®ï¼Œéœ€è¦æ³¨æ„çš„éœ€è¦æ˜¯ä»¥ module çš„æ–¹å¼å»è¿è¡Œé¡¹ç›®çš„å…¥å£ jupyter&#x2F;app.py æ–‡ä»¶ï¼Œç„¶åè®¾ç½®ä»¥ä¸‹å‘½ä»¤å‚æ•° -f xxï¼Œæœ€åè®¾ç½®é¡¹ç›®çš„å·¥ä½œç›®å½•ä¸º jupyterhub é¡¹ç›®çš„æ ¹ç›®å½•ã€‚ç„¶åå°±å¯ä»¥æ„‰å¿«çš„è¿è¡Œè°ƒè¯•äº†ğŸ‘ã€‚</p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/image-20240816110455495.png" alt="Pycharm run/debug configuration" style="zoom:50%;" />

<p>ä¸‹é¢è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆéœ€è¦ä»¥ module çš„æ–¹å¼å»è¿è¡Œå…¥å£æ–‡ä»¶ã€‚</p>
<ul>
<li><p>ä»¥ scripy æ–¹å¼è¿è¡Œæ–‡ä»¶ç›¸å½“äºç›´æ¥ä½¿ç”¨ <code>python xxx</code>ã€‚</p>
</li>
<li><p>ä»¥ module æ–¹å¼è¿è¡Œæ–‡ä»¶ç›¸å½“äºä½¿ç”¨<code>python -m xxx</code>ã€‚</p>
</li>
<li><p><strong>è·¯å¾„å¤„ç†</strong>: è¿è¡Œ script æ—¶ï¼ŒPython ä¼šæ ¹æ®æ–‡ä»¶çš„ç‰©ç†è·¯å¾„ç›´æ¥æ‰§è¡Œï¼Œè€Œè¿è¡Œ module æ—¶ï¼ŒPython ä¼šå¤„ç†æ¨¡å—è·¯å¾„å¹¶å°†æ¨¡å—çš„é¡¶çº§ç›®å½•æ·»åŠ åˆ° <code>sys.path</code>ã€‚</p>
</li>
<li><p><strong>å¯¼å…¥æ–¹å¼</strong>: åœ¨ module è¿è¡Œæ—¶ï¼ŒPython å¯ä»¥å¤„ç†ç›¸å¯¹å¯¼å…¥ï¼Œè€Œ script è¿è¡Œæ—¶åˆ™ä¸èƒ½ç›´æ¥å¤„ç†ç›¸å¯¹å¯¼å…¥ï¼ˆå› ä¸ºè„šæœ¬æ˜¯ä½œä¸ºç‹¬ç«‹çš„ <code>__main__</code> æ‰§è¡Œçš„ï¼Œæ²¡æœ‰åŒ…çš„ä¸Šä¸‹æ–‡ï¼‰ã€‚</p>
</li>
<li><p><strong>é€‚ç”¨åœºæ™¯</strong>: script æ–¹å¼é€‚åˆå•æ–‡ä»¶æˆ–æµ‹è¯•æ–‡ä»¶çš„ç®€å•æ‰§è¡Œï¼Œè€Œ module æ–¹å¼åˆ™é€‚åˆå¤æ‚çš„åŒ…ç»“æ„ï¼Œå°¤å…¶æ˜¯æ¶‰åŠåŒ…å†…ç›¸å¯¹å¯¼å…¥æˆ–æ¨¡å—å†…éƒ¨çš„å‘½åç©ºé—´ç®¡ç†æ—¶ã€‚</p>
</li>
</ul>
<p>è¿™ä¸¤ç§æ–¹å¼çš„é€‰æ‹©å–å†³äºä½ çš„é¡¹ç›®ç»“æ„å’Œéœ€è¦æ‰§è¡Œçš„ä»£ç ä½ç½®ã€‚åœ¨å¤§å‹é¡¹ç›®æˆ–éœ€è¦è°ƒè¯•æ¨¡å—åŒ–ä»£ç æ—¶ï¼Œä½¿ç”¨æ¨¡å—æ–¹å¼é€šå¸¸æ›´åˆé€‚ã€‚å¦‚æœå–œæ¬¢é€šè¿‡å‘½ä»¤è¡Œè¿›è¡Œè°ƒè¯•çš„è¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ pdb ï¼ˆç±»ä¼¼ gdbï¼‰æ¥è°ƒè¯•é¡¹ç›®ã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>ç”±äºæˆ‘ä»¬å¯¹ Jupyter Notebook è¿›è¡Œäº†äºŒæ¬¡å¼€å‘ï¼Œéœ€è¦å°†å…¶ä½œä¸ºä¸€ä¸ªæœåŠ¡é›†æˆåˆ°æˆ‘ä»¬çš„å›¾æ•°æ®åˆ†æå¹³å°ä¸­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰JupyterHub çš„è®¤è¯æœºåˆ¶ï¼Œä½¿å…¶ä¸å¹³å°ä¸­çš„è®¤è¯æœºåˆ¶ä¸€è‡´ã€‚ç›®å‰ï¼Œæˆ‘ä»¬çš„å›¾æ•°æ®åˆ†æå¹³å°é‡‡ç”¨åŸºäº JWT çš„ä»¤ç‰Œè®¤è¯æ–¹å¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ JupyterHub ä¸­å®ç°åŸºäº JWT çš„è‡ªå®šä¹‰è®¤è¯æœºåˆ¶ã€‚</p>
<p>ä¸‹é¢æ˜¯è®¤è¯è¿‡ç¨‹çš„æ—¶åºå›¾ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€è¿°ï¼š</p>
<ul>
<li><p><strong>ç”¨æˆ·è®¿é—®å…¥å£</strong>: ç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—® Jupyter Hubï¼Œæœ€åˆçš„è¯·æ±‚åˆ°è¾¾ <code>Proxy</code>ã€‚</p>
</li>
<li><p><strong>è·³è½¬ SSO</strong>: å¦‚æœéªŒè¯ token å¤±è´¥ï¼Œ<code>Proxy</code> ä¼šå°†è¯·æ±‚é‡å®šå‘åˆ° SSO ç³»ç»Ÿè¿›è¡Œè®¤è¯ã€‚</p>
</li>
<li><p><strong>SSO ç™»å½•</strong>: ç”¨æˆ·å®Œæˆ SSO ç™»å½•ï¼ŒSSO ç³»ç»Ÿå°†ç»“æœå›è°ƒåˆ° <code>Hub</code>ã€‚</p>
</li>
<li><p><strong>å®ä¾‹ç”³è¯·å’Œåˆ›å»º</strong>: <code>Hub</code> æ¥æ”¶å›è°ƒåï¼Œä¸ºç”¨æˆ·è¯·æ±‚åœ¨ æœ¬åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„ Jupyter Server å®ä¾‹ã€‚</p>
</li>
<li><p><strong>å®ä¾‹åˆ›å»º</strong>: åˆ›å»ºå®ä¾‹åï¼Œè¿”å›ç›¸å…³ä¿¡æ¯ç»™ <code>Hub</code>ã€‚</p>
</li>
<li><p><strong>é…ç½®å’Œè·³è½¬</strong>: <code>Hub</code> è®¾ç½®è½¬å‘è§„åˆ™ï¼Œç„¶åå°†ç”¨æˆ·çš„è¯·æ±‚é‡å®šå‘åˆ° <code>&lt;username&gt;</code> è·¯å¾„ã€‚</p>
</li>
<li><p><strong>è®¿é—® JupyterLab</strong>: ç”¨æˆ·æµè§ˆå™¨è®¿é—® <code>&lt;username&gt;</code> è·¯å¾„ï¼ŒåŠ è½½ Jupyter Lab ç•Œé¢ã€‚</p>
</li>
<li><p><strong>ä»£ç æ‰§è¡Œå’Œç»“æœè¿”å›</strong>: ç”¨æˆ·åœ¨ Jupyter Lab ä¸­è¯·æ±‚æ‰§è¡Œä»£ç ï¼Œè½¬å‘ç»™ Jupyter Server æ‰§è¡Œï¼Œæœ€ç»ˆè¿”å›æ‰§è¡Œç»“æœç»™ç”¨æˆ·æµè§ˆå™¨ã€‚</p>
</li>
</ul>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/notebook-login-sequence-chart.png" alt="notebook-login-sequence-chart" style="zoom:20%;" />

<p>ä¸‹é¢å°†ä»‹ç»å¦‚ä½•å®ç° Jupyter Hub çš„è‡ªå®šä¹‰è®¤è¯ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner/tree/main/examples">DockerSpawner</a> æ¥åˆ›å»ºæ–°çš„ Jupyter Server å®ä¾‹ï¼Œä¼šä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€ä¸ªå®¹å™¨æ¥è¿è¡Œ Jupyter Serverã€‚æ‰€ä»¥ï¼ŒJupyter Hub ä¼šå’Œç”¨æˆ·å®¹å™¨é‡Œçš„ Server é€šä¿¡ã€‚å¦‚æœ Jupyter Hub éƒ¨ç½²åœ¨æœ¬åœ°çš„è¯ï¼Œå’Œå®¹å™¨é€šä¿¡æ˜¯ä¸æ–¹ä¾¿çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°† Jupyter Hub æ”¾åœ¨å®¹å™¨é‡Œé¢éƒ¨ç½²ï¼Œå°† Jupyter Hub å®¹å™¨ å’Œ ç”¨æˆ·å®ä¾‹å®¹å™¨æ”¾åœ¨ä¸€ä¸ª network é‡Œé¢ï¼Œè¿™æ ·è¿™äº›å®¹å™¨å°±å¯ä»¥ç›¸äº’é€šä¿¡ã€‚ä¹Ÿè®¸ä½ ä¼šæœ‰ç–‘é—®ï¼ŒJupyter Hub å®¹å™¨é‡Œé¢æ²¡æœ‰å®‰è£… dockerï¼ŒDockerSpawner å¦‚ä½•åˆ›å»ºå®¹å™¨å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å°†æœ¬åœ°ä¸»æœºçš„ Docker å®ˆæŠ¤è¿›ç¨‹çš„ Unix å¥—æ¥å­—æ–‡ä»¶ï¼ˆ<code>/var/run/docker.sock</code>ï¼‰æŒ‚è½½åˆ° Jupyter Hub å®¹å™¨ä¸­çš„ç›¸åŒä½ç½®ï¼Œè¿™æ ·å®¹å™¨å†…çš„åº”ç”¨å¯ä»¥åƒä¸»æœºä¸Šçš„ä»»ä½• Docker å®¢æˆ·ç«¯ä¸€æ ·ï¼Œä¸ Docker å®ˆæŠ¤è¿›ç¨‹é€šä¿¡ï¼Œæ‰§è¡Œ Docker å‘½ä»¤ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ç¼–å†™ä¸€ä¸ª Dockerfile æ¥å®‰è£… Jupyter Hubï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½åœ¨æœ¬åœ°è¿æ¥è¿™ä¸ªå®¹å™¨è¿›è¡Œå¼€å‘è°ƒè¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬åƒä¹‹å‰ä¸€æ ·ï¼Œè‡ªå·±ç¼–è¯‘è¿™äº›ç»„ä»¶ã€‚ä¸‹é¢æ˜¯ Dockerfile çš„å†…å®¹ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ Python 3.12 åŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–ï¼ŒåŒ…æ‹¬ curlã€gitã€vim å’Œ SSH æœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    git \</span></span><br><span class="line"><span class="language-bash">    vim \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    openssh-server \</span></span><br><span class="line"><span class="language-bash">    apt-transport-https \</span></span><br><span class="line"><span class="language-bash">    ca-certificates \</span></span><br><span class="line"><span class="language-bash">    gnupg-agent \</span></span><br><span class="line"><span class="language-bash">    software-properties-common \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå·¥ä½œç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /srv/jupyterhub</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®SSHæœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /var/run/sshd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®rootç”¨æˆ·çš„å¯†ç ï¼ˆæ³¨æ„ï¼šè¿™æ˜¯ä¸å®‰å…¨çš„ï¼Œä»…ç”¨äºå¼€å‘ç¯å¢ƒï¼‰</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;root:password&#x27;</span> | chpasswd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸rootç”¨æˆ·é€šè¿‡SSHç™»å½•</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/#PermitRootLogin prohibit-password/PermitRootLogin yes/&#x27;</span> /etc/ssh/sshd_config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦ç”¨PAMé™åˆ¶</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s@session    required   pam_loginuid.so@session    optional   pam_loginuid.so@g&#x27;</span> /etc/pam.d/sshd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²å¿…è¦çš„ç«¯å£ï¼ŒåŒ…æ‹¬SSHç«¯å£22</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22</span> <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨SSHæœåŠ¡å¹¶è¿›å…¥äº¤äº’å¼ shell</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> service ssh start &amp;&amp; bash</span></span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ„å»ºé•œåƒã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t jupyterhub-dev .</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤åˆ›å»º networkã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create jupyterhub</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿è¡Œå®¹å™¨ï¼Œæ˜ å°„æœ¬åœ°å­˜å‚¨å’Œç«¯å£ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name jupyterhub-dev \</span><br><span class="line">	-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">	--net jupyterhub \</span><br><span class="line">  -v /Users/tom/notebook-service-demo/docker-image/source-code:/srv/jupyterhub \</span><br><span class="line">  -p 8000:8000 \</span><br><span class="line">  -p 16022:22 \</span><br><span class="line">  jupyterhub-dev</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨æœ¬åœ°çš„ <code>/Users/docker-image/source-code</code> ç›®å½•ä¸‹ï¼Œclone Jupyter Serverã€Jupyter lab å’Œ Jupyter Hub çš„æºç ã€‚æ‰§è¡Œ <code>docker attach jupyterhub-dev</code> è¿›å…¥å®¹å™¨çš„å‘½ä»¤è¡Œï¼ŒæŒ‰ç…§â€œå®‰è£…éƒ¨ç½²â€å°èŠ‚ä¸­çš„å†…å®¹è¿›è¡Œç¼–è¯‘åˆšåˆš clone ä¸‹æ¥çš„æºç ã€‚æ³¨æ„ç¼–è¯‘ Jupyter Lab çš„æ—¶å€™ï¼Œå¦‚æœæŠ¥é”™ï¼Œå…ˆå°è¯•è¿è¡Œä¸‹ <code>yarn install</code> ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œåœ¨æœ¬åœ°çš„ Pycharm ä¸­æ‰“å¼€æ˜ å°„çš„æ–‡ä»¶å¤¹é‡Œçš„ JupyterHub æºç ï¼Œç„¶åé€šè¿‡ SSH ä½¿ç”¨å®¹å™¨å†…çš„ç¼–è¯‘å™¨ã€‚è¿™æ ·å°±å¯ä»¥æ„‰å¿«çš„ä½¿ç”¨å®¹å™¨å†…çš„ç¯å¢ƒè¿›è¡Œå¼€å‘äº†ï¼Œæœ¬åœ°æ›´æ–°çš„ä»£ç ä¹Ÿä¼šåŒæ­¥åˆ°å®¹å™¨å†…ã€‚æŒ‰ç…§ä¸Šé¢â€œè°ƒè¯•â€å°èŠ‚ä¸­çš„å†…å®¹å»æ“ä½œå°±è¡Œã€‚</p>
<p>ä¸‹é¢æ˜¯å®ç°è‡ªå®šä¹‰è®¤è¯çš„ä»£ç ã€‚</p>
<p>æˆ‘ä»¬å…ˆç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰è®¤è¯å™¨ï¼Œç”¨äºå®ç° JWT çš„éªŒè¯é€»è¾‘ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">from</span> jupyterhub.auth <span class="keyword">import</span> Authenticator</span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</span><br><span class="line"><span class="keyword">from</span> jwt.exceptions <span class="keyword">import</span> ExpiredSignatureError, InvalidTokenError</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JWTAuthenticator</span>(<span class="title class_ inherited__">Authenticator</span>):</span><br><span class="line">  secret = <span class="string">&quot;your_secret&quot;</span></span><br><span class="line">  authKeyFormat=<span class="string">&quot;auth_token_key:&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># åˆå§‹åŒ– Redis è¿æ¥</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">    <span class="built_in">super</span>().__init__(**kwargs)</span><br><span class="line">    <span class="comment"># æ ¹æ® Redis é…ç½®è¿›è¡Œä¿®æ”¹ï¼Œhost ä¸ºè¿è¡Œ redis çš„å®¹å™¨å</span></span><br><span class="line">    <span class="comment"># å¦‚æœ Redis åœ¨å®¹å™¨ä¸­å¯åŠ¨ï¼Œåˆ™éœ€è¦åŠ å…¥å’Œ Jupyter Hub å®¹å™¨æ‰€åœ¨çš„ network å†…</span></span><br><span class="line">    <span class="variable language_">self</span>.redis_client = redis.StrictRedis(host=<span class="string">&#x27;redis&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_user_id_from_token</span>(<span class="params">self, token</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      <span class="comment"># Debug log for the token being decoded</span></span><br><span class="line">      <span class="variable language_">self</span>.log.info(<span class="string">f&quot;Decoding token: <span class="subst">&#123;token&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">      payload = jwt.decode(token, <span class="variable language_">self</span>.secret, algorithms=[<span class="string">&#x27;HS384&#x27;</span>])</span><br><span class="line">      <span class="variable language_">self</span>.log.info(<span class="string">f&quot;Decoded payload: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">      user_id = payload.get(<span class="string">&quot;sub&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span> user_id:</span><br><span class="line">        <span class="keyword">return</span> user_id</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="variable language_">self</span>.log.warning(<span class="string">&quot;No user ID found in token&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> ExpiredSignatureError:</span><br><span class="line">      <span class="variable language_">self</span>.log.warning(<span class="string">&quot;Token has expired&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> InvalidTokenError <span class="keyword">as</span> e:</span><br><span class="line">      <span class="variable language_">self</span>.log.warning(<span class="string">f&quot;Invalid token: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">      <span class="variable language_">self</span>.log.warning(<span class="string">f&quot;Error decoding token: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  @gen.coroutine</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, handler, data=<span class="literal">None</span></span>):</span><br><span class="line">    token = handler.request.headers.get(<span class="string">&#x27;Authorization&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">      <span class="variable language_">self</span>.log.warning(<span class="string">&quot;No Authorization header provided&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    user_id = <span class="variable language_">self</span>.get_user_id_from_token(token)</span><br><span class="line">    authKey = <span class="variable language_">self</span>.authKeyFormat.<span class="built_in">format</span>(user_id)</span><br><span class="line">    <span class="keyword">if</span> user_id:</span><br><span class="line">      <span class="comment"># ä» Redis ä¸­è·å– user_id çš„å€¼</span></span><br><span class="line">      user_exists = <span class="variable language_">self</span>.redis_client.exists(authKey)</span><br><span class="line">      <span class="keyword">if</span> user_exists:</span><br><span class="line">        <span class="keyword">return</span> user_id</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="variable language_">self</span>.log.warning(<span class="string">f&quot;User ID <span class="subst">&#123;user_id&#125;</span> not found in Redis&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åç¼–å†™é…ç½®æ–‡ä»¶ä½¿ç”¨ä¸Šè¿°è‡ªå®šä¹‰è®¤è¯å™¨ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyterhub.auth <span class="keyword">import</span> LocalAuthenticator</span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">current_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"><span class="built_in">print</span>(current_dir)</span><br><span class="line"><span class="comment"># æ·»åŠ å½“å‰ç›®å½•åˆ° Python è·¯å¾„</span></span><br><span class="line">sys.path.insert(<span class="number">0</span>, current_dir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jwt_authenticator <span class="keyword">import</span> JWTAuthenticator</span><br><span class="line"><span class="keyword">from</span> dockerspawner <span class="keyword">import</span> DockerSpawner</span><br><span class="line"></span><br><span class="line"><span class="comment"># Jupyter Hub çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">c = get_config()  <span class="comment"># noqa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ç™»å½•</span></span><br><span class="line">c.Authenticator.allow_all = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ SimpleAuthenticator è¿›è¡ŒåŸºäºæ“ä½œç³»ç»Ÿç”¨æˆ·çš„è®¤è¯</span></span><br><span class="line">c.JupyterHub.authenticator_class = JWTAuthenticator</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤å¯åŠ¨ JupyterLabï¼Œè€Œä¸æ˜¯ç»å…¸çš„ Jupyter Notebook ç•Œé¢</span></span><br><span class="line">c.Spawner.default_url = <span class="string">&#x27;/lab&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ DockerSpawner</span></span><br><span class="line">c.JupyterHub.spawner_class = DockerSpawner</span><br><span class="line"></span><br><span class="line"><span class="comment"># DockerSpawner çš„é…ç½®</span></span><br><span class="line"><span class="comment"># è®¾ç½®æ¯æ¬¡åˆ›å»ºå®ä¾‹ä½¿ç”¨çš„é•œåƒ</span></span><br><span class="line">c.DockerSpawner.image = <span class="string">&#x27;jupyter/minimal-notebook&#x27;</span></span><br><span class="line"><span class="comment"># è®¾ç½®ä½¿ç”¨ docker çš„è‡ªå®šä¹‰ç½‘ç»œ</span></span><br><span class="line">c.DockerSpawner.network_name = <span class="string">&#x27;jupyterhub&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬éœ€è¦ hub åœ¨å®¹å™¨ä¸­ç›‘å¬æ‰€æœ‰ IP</span></span><br><span class="line">c.JupyterHub.hub_ip = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line"><span class="comment"># ç”¨äºè¿æ¥ hub çš„ä¸»æœºå/IP</span></span><br><span class="line"><span class="comment"># è¿™é€šå¸¸æ˜¯ hub å®¹å™¨çš„åç§°</span></span><br><span class="line">c.JupyterHub.hub_connect_ip = <span class="string">&#x27;jupyterhub-dev&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦ç”¨ XSRF è·¨åŸŸä¿æŠ¤ï¼Œè¿è¡Œè·¨åŸŸè¯·æ±‚</span></span><br><span class="line">c.JupyterHub.tornado_settings = &#123;</span><br><span class="line">  <span class="string">&#x27;xsrf_cookies&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä½¿ç”¨ä¸Šé¢çš„é…ç½®æ–‡ä»¶å¯åŠ¨ Jupyter Hub ã€‚é€šè¿‡ apifox å‘é€ä¸‹é¢çš„è¯·æ±‚ï¼Œå°†è·å–çš„ cookie å­˜å…¥åˆ°æµè§ˆå™¨ä¸Šçš„ <a target="_blank" rel="noopener" href="http://localhost:8000/">http://localhost:8000</a> ä¸Šï¼Œæ‰“å¼€ <a target="_blank" rel="noopener" href="http://localhost:8000/hub/%E3%80%82%E5%A6%82%E6%9E%9C%E5%8F%AF%E4%BB%A5%E6%88%90%E5%8A%9F%E6%89%93%E5%BC%80%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%88%90%E5%8A%9F%E5%95%A6%F0%9F%98%84%E3%80%82">http://localhost:8000/hub/ã€‚å¦‚æœå¯ä»¥æˆåŠŸæ‰“å¼€ï¼Œå°±æ˜¯æˆåŠŸå•¦ğŸ˜„ã€‚</a></p>
<img src="https://blog-1259405505.cos.ap-guangzhou.myqcloud.com/image-20240818135051043.png" alt="apifox-1" style="zoom:33%;" />


<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« ä»‹ç»äº† Jupyter äºŒæ¬¡å¼€å‘çš„åˆæ­¥æ€è·¯ã€‚é¦–å…ˆä»‹ç»é¡¹ç›®çš„éœ€æ±‚ã€‚æ¥ç€æˆ‘ä»¬çš„è¿›ä¸€æ­¥ä»‹ç»æ¶æ„è®¾è®¡ï¼Œä½¿ç”¨äº†å“ªäº›ç»„ä»¶ã€‚ç„¶åä»‹ç»äº†å¦‚ä½•ç¼–è¯‘å®‰è£…éƒ¨ç½² Jupyter Hub åŠç›¸å…³ç»„ä»¶ã€‚æœ€ååœ¨ docker ä¸Šå®ç°äº† Jupyter Hub çš„è‡ªå®šä¹‰çš„ JWT è®¤è¯ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰çš„æˆ‘ä»¬çš„æ¶æ„ä¼šå­˜åœ¨ä¸‹é¢è¿™äº›é—®é¢˜ï¼Œè¿™äº›é—®é¢˜ä¹Ÿæ˜¯ä¹‹åéœ€è¦ä¼˜åŒ–ã€‚</p>
<ol>
<li>hub å•ç‚¹æ•…éšœä¼šå¯¼è‡´å…¨éƒ¨å®ä¾‹ä½¿ç”¨ä¸äº†</li>
<li>æ–‡ä»¶å­˜åœ¨å®ä¾‹æœ¬åœ°ï¼Œhub æŒ‚æ‰å°±æ‰¾ä¸åˆ°äº†</li>
<li>å‡çº§æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦ç»™æŒ¨ä¸ªå®ä¾‹å‡çº§</li>
</ol>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a target="_blank" rel="noopener" href="https://z2jh.jupyter.org/en/stable/index.html">Zero to JupyterHub with Kubernetes</a></p>
<p><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/authenticators.html">Jupyter Hub Authenticators</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wLp-ZJaXvZO85FiFXdJafw">å­—èŠ‚åšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2019/11/21/application-practice-jupyter.html">ç¾å›¢åšå®¢</a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/" rel="tag">Jupyter äºŒæ¬¡å¼€å‘</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/08/14/K8s-%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0/">K8s åŸç†ç®€è¿°</a><a class="next" href="/2024/08/08/Jupyter-%E9%A1%B9%E7%9B%AE%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D/">Jupyter é¡¹ç›®å·¥ä½œåŸç†ä»‹ç»</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/Java-%E5%90%8E%E7%AB%AF/" style="font-size: 15px;">Java åç«¯</a> <a href="/tags/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/" style="font-size: 15px;">Jupyter äºŒæ¬¡å¼€å‘</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">å·¥å…·</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 15px;">æ•™ç¨‹</a> <a href="/tags/%E6%84%9F%E6%82%9F/" style="font-size: 15px;">æ„Ÿæ‚Ÿ</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> è”ç³»æˆ‘</i></div><ul></ul><a href="mailto:trl2025@163.com" title="Mail" target="_blank">Mail</a><ul></ul><a href="https://github.com/rongliangtang" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://space.bilibili.com/28159312" title="Bilibili" target="_blank">Bilibili</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2024 Tom</div></div></div><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>