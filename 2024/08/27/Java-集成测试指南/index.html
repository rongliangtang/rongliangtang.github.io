<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="这是RongLiang的博客,用来分享技术知识和一些感悟。"><title>Java 集成测试指南 | Tom's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java 集成测试指南</h1><a id="logo" href="/.">Tom's Blog</a><p class="description">野蛮生长</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 文章</i></a><a href="/archives/"><i class="fa undefined"> 总览</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java 集成测试指南</h1><div class="post-meta">2024-08-27</div><div class="post-content"><p>在上一篇文章中，我们介绍了如何编写单元测试。这篇文章将更进一步，讲解如何编写集成测试。我们将首先讨论单元测试和集成测试之间的区别，接着介绍集成测试的目录结构，最后展示集成测试的具体实现。</p>
<p>编写集成测试时，主要使用 <a target="_blank" rel="noopener" href="https://testcontainers.com/">Testcontainers</a> 和 <a target="_blank" rel="noopener" href="https://maven.apache.org/surefire/maven-failsafe-plugin/">Failsafe</a> 这两个工具。Testcontainers 允许在测试过程中启动容器，从而实现端到端的测试，而 Failsafe 则负责在构建阶段控制集成测试的执行。</p>
<span id="more"></span>

<h2 id="单元测试和集成测试的区别"><a href="#单元测试和集成测试的区别" class="headerlink" title="单元测试和集成测试的区别"></a>单元测试和集成测试的区别</h2><p><strong>单元测试</strong> 是针对代码中的最小功能单元（通常是单个方法或类）进行的测试，目的是验证这些单元是否按预期工作。单元测试通常通过模拟外部依赖来隔离测试环境。</p>
<p><strong>集成测试</strong> 则验证多个组件或模块之间的交互是否正确，确保它们能够协同工作。集成测试通常涉及实际的数据库、网络等外部系统，目的是检查模块之间的接口和数据流是否正确。</p>
<p>如果对以上概念仍有些模糊，别担心，接下来我们将通过实际案例来详细说明如何实现集成测试。<strong>本文的集成测试是基于上一篇单元测试教程中的代码进行的。如果你还没有看过上一篇，可以先去了解一下。</strong></p>
<h2 id="集成测试规范"><a href="#集成测试规范" class="headerlink" title="集成测试规范"></a>集成测试规范</h2><p>在 Java 集成测试中，遵循以下规范可以帮助确保测试的有效性和可靠性：</p>
<ol>
<li><p><strong>真实环境配置</strong>：尽量在与生产环境相似的环境中进行测试，使用真实的数据库、消息队列等，以捕捉集成中的潜在问题。</p>
</li>
<li><p><strong>使用 <code>@SpringBootTest</code> 注解</strong>：通过 <code>@SpringBootTest</code> 注解启动整个 Spring 应用上下文，确保各个组件之间的依赖关系能够得到正确测试。</p>
</li>
<li><p><strong>事务管理</strong>：使用 <code>@Transactional</code> 注解保证测试的数据隔离，测试完成后自动回滚事务，避免对数据库造成污染。</p>
</li>
<li><p><strong>测试覆盖</strong>：覆盖关键的业务流程和模块交互，确保在模块组合后仍然能够满足业务需求。</p>
</li>
<li><p><strong>依赖注入的使用</strong>：通过依赖注入的方式加载真实组件，而不是使用模拟对象（如 Mockito），以确保组件之间的真实交互能够正确工作。</p>
</li>
<li><p><strong>日志和监控</strong>：在测试中开启详细日志和监控，帮助快速定位问题。</p>
</li>
<li><p><strong>数据准备与清理</strong>：使用合适的工具或框架（如 Testcontainers 或 Flyway）进行数据的准备和清理，确保每次测试的数据状态一致。</p>
</li>
</ol>
<p>这些规范有助于在集成测试中确保系统模块之间的正确性和稳定性。</p>
<h2 id="集成测试实践"><a href="#集成测试实践" class="headerlink" title="集成测试实践"></a>集成测试实践</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p>如下所示的目录结构展示了整个项目的组成。项目主要包括两个模块：<code>server</code> 模块和 <code>integration-test</code> 模块。</p>
<ul>
<li><code>server</code> 模块包含了上一篇文章中的代码，为了使项目结构更为规范，我们将这些代码放在了 <code>server</code> 模块中。</li>
<li><code>integration-test</code> 模块则专门用于存放 <code>server</code> 模块中代码的集成测试。</li>
</ul>
<p>目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── integration-test</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src</span><br><span class="line">│      └── test</span><br><span class="line">│          └── java</span><br><span class="line">│              └── cn</span><br><span class="line">│                  └── tangrl</span><br><span class="line">│                      └── server</span><br><span class="line">│                          ├── controller</span><br><span class="line">│                          │   └── UserControllerIT.java</span><br><span class="line">│                          ├── repository</span><br><span class="line">│                          │   └── UserRepositoryIT.java</span><br><span class="line">│                          └── service</span><br><span class="line">│                              └── UserServiceIT.java</span><br><span class="line">│		</span><br><span class="line">└── server</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── src</span><br><span class="line">│      ├── main</span><br><span class="line">│      │   ├── java</span><br><span class="line">│      │   │   └── cn</span><br><span class="line">│      │   │       └── tangrl</span><br><span class="line">│      │   │           └── server</span><br><span class="line">│      │   │               ├── ItApplication.java</span><br><span class="line">│      │   │               ├── controller</span><br><span class="line">│      │   │               │   └── UserController.java</span><br><span class="line">│      │   │               ├── model</span><br><span class="line">│      │   │               │   └── User.java</span><br><span class="line">│      │   │               ├── repository</span><br><span class="line">│      │   │               │   └── UserRepository.java</span><br><span class="line">│      │   │               └── service</span><br><span class="line">│      │   │                   └── UserService.java</span><br><span class="line">│      │   └── resources</span><br><span class="line">│      │       └── application.properties</span><br><span class="line">│      └── test</span><br><span class="line">│          ├── java</span><br><span class="line">│          │   └── cn</span><br><span class="line">│          │       └── tangrl</span><br><span class="line">│          │           └── server</span><br><span class="line">│          │               ├── controller</span><br><span class="line">│          │               │   └── UserControllerTest.java</span><br><span class="line">│          │               ├── model</span><br><span class="line">│          │               │   └── UserTest.java</span><br><span class="line">│          │               ├── repository</span><br><span class="line">│          │               │   └── UserRepositoryTest.java</span><br><span class="line">│          │               └── service</span><br><span class="line">│          │                   └── UserServiceTest.java</span><br><span class="line">│          └── resources</span><br><span class="line">├── pom.xml</span><br></pre></td></tr></table></figure>

<p><strong>将集成测试代码放在独立的一个模块是 Apache 项目的常见做法（例如 flink），这样的好处是：</strong></p>
<ol>
<li><strong>模块化管理</strong>：集成测试与单元测试、业务逻辑代码分离，模块化管理使项目结构更加清晰，方便维护和理解。</li>
<li><strong>依赖隔离</strong>：集成测试模块可以独立配置自己的依赖，如测试数据库、测试工具等，不会影响其他模块，避免了不必要的冲突。</li>
<li><strong>提高构建效率</strong>：在 CI&#x2F;CD 流程中，可以选择性地运行集成测试模块，而不影响单元测试或业务逻辑的构建流程，这样可以加快开发反馈周期。</li>
<li><strong>测试环境独立性</strong>：可以为集成测试配置专属的测试环境配置文件，确保测试与生产配置隔离，降低误操作风险。</li>
<li><strong>更好的代码组织</strong>：有助于清晰地组织和管理测试代码，特别是在大型项目中，独立模块的管理使得测试代码易于扩展和维护。</li>
</ol>
<h3 id="编写集成测试"><a href="#编写集成测试" class="headerlink" title="编写集成测试"></a>编写集成测试</h3><p>下面是 <code>Server</code> 模块中 <code>pom.xml</code> 文件的 <code>build</code> 部分。为了使 <code>integration-test</code> 模块能够引用 <code>server</code> 模块的业务代码并进行集成测试，我们需要通过 <code>repackage</code> 生成一个可执行的 JAR 文件。默认情况下，Spring Boot 会生成一个包含嵌入式 Tomcat 的可部署 JAR 包，这个包只能用于部署，无法作为依赖引用。因此，我们在 <code>build</code> 配置中进行了特殊设置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 构建配置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Spring Boot Maven 插件: 提供 Spring Boot 应用打包支持 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置 repackage 目标和 classifier 后缀，生成一个可执行的 JAR 文件，使集成测试模块能够引用 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">classifier</span>&gt;</span>exec<span class="tag">&lt;/<span class="name">classifier</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">&lt;!-- Maven Surefire 插件: 用于运行单元测试 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>integration-test</code> 模块的 <code>pom.xml</code> 文件内容如下。该模块使用了 <code>Testcontainers</code> 和 <code>Failsafe</code> 这两个工具。<code>Testcontainers</code> 可以在测试运行时启动容器，实现端到端的测试。而 <code>Failsafe</code> 插件则用于控制集成测试的执行，确保在构建阶段运行集成测试。</p>
<p><strong>注意</strong>：使用 <code>Testcontainers</code> 时，需要确保本地已安装 <a target="_blank" rel="noopener" href="https://www.docker.com/get-started/">Docker</a>。</p>
<p>在 <code>build</code> 配置中，<code>Failsafe</code> 插件会在 Maven 的 <code>verify</code> 阶段执行集成测试并检查测试结果。如果集成测试失败，构建过程将终止，从而保证代码质量。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.tangrl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>it<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>integration-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.tangrl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot Test --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Data JPA and MySQL dependencies --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Testcontainers dependencies --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testcontainers<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>testcontainers<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testcontainers<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.testcontainers<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Maven Failsafe 插件: 用于运行集成测试 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-failsafe-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>integration-test<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">goal</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过这种配置，<code>integration-test</code> 模块可以引用 <code>server</code> 模块中的代码，并使用 <code>Testcontainers</code> 和 <code>Failsafe</code> 进行集成测试，确保各模块的功能能够在一起顺利工作。</p>
<ol>
<li><strong>测试 repository 代码</strong></li>
</ol>
<p>在进行集成测试时，通常不会单独测试 <code>model</code> 实体类。实体类的验证通常依赖于上层 <code>repository</code> 的集成测试，主要测试实体类的 CRUD 操作。</p>
<p>对于 <code>repository</code> 层的测试，重点是测试自定义的方法。</p>
<p>下面的代码展示了 <code>UserRepository</code> 类的集成测试。测试中使用 Testcontainers 来模拟真实的 MySQL 数据库环境。通过 <code>@Container</code> 注解启动 MySQL 容器，并使用 <code>@DynamicPropertySource</code> 动态注入容器的连接信息到 Spring 环境中。测试运行在完整的 Spring Boot 上下文中，<code>@SpringBootTest</code> 注解确保加载所有必要的 Bean。在测试方法中，首先将一些测试数据保存到数据库中，然后使用 <code>findByName</code> 方法查询用户，并验证查询结果是否正确。这一系列步骤确保了 <code>UserRepository</code> 在真实数据库环境中的功能表现是正确的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Testcontainers</span>  <span class="comment">// 启用 Testcontainers 支持，用于在测试中使用容器化的数据库</span></span><br><span class="line"><span class="meta">@SpringBootTest</span>  <span class="comment">// 运行 Spring Boot 上下文，用于集成测试</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserRepositoryIT</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Container</span>  <span class="comment">// 定义一个 MySQL 容器，用于在测试过程中模拟真实的 MySQL 数据库</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MySQLContainer&lt;?&gt; mysqlContainer = <span class="keyword">new</span> <span class="title class_">MySQLContainer</span>&lt;&gt;(</span><br><span class="line">        <span class="string">&quot;mysql:8.0.33&quot;</span>).withDatabaseName(<span class="string">&quot;testdb&quot;</span>).withUsername(<span class="string">&quot;testuser&quot;</span>)</span><br><span class="line">        .withPassword(<span class="string">&quot;testpass&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;  <span class="comment">// 注入 UserRepository 用于测试</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamicPropertySource</span>  <span class="comment">// 动态配置测试数据库属性，将容器中的数据库连接信息注入 Spring 的环境配置中</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configureTestDatabase</span><span class="params">(DynamicPropertyRegistry registry)</span> &#123;</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.url&quot;</span>, mysqlContainer::getJdbcUrl);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.username&quot;</span>, mysqlContainer::getUsername);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.password&quot;</span>, mysqlContainer::getPassword);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.driver-class-name&quot;</span>, () -&gt; <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 可选：在每个测试之前准备测试数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 清理数据库中的测试数据，保证测试环境的独立性</span></span><br><span class="line">        userRepository.deleteAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFindByName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Arrange - 设置测试数据</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;Jane Doe&quot;</span>, <span class="string">&quot;jane.doe@example.com&quot;</span>);</span><br><span class="line">        userRepository.save(user1);</span><br><span class="line">        userRepository.save(user2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act - 执行查询操作</span></span><br><span class="line">        List&lt;User&gt; johns = userRepository.findByName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line">        List&lt;User&gt; janes = userRepository.findByName(<span class="string">&quot;Jane Doe&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assert - 验证查询结果是否符合预期</span></span><br><span class="line">        assertEquals(<span class="number">1</span>, johns.size(), <span class="string">&quot;Should find one John Doe&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;John Doe&quot;</span>, johns.get(<span class="number">0</span>).getName());</span><br><span class="line"></span><br><span class="line">        assertEquals(<span class="number">1</span>, janes.size(), <span class="string">&quot;Should find one Jane Doe&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Jane Doe&quot;</span>, janes.get(<span class="number">0</span>).getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>测试 service 服务类代码</strong></li>
</ol>
<p>下述代码是 <code>UserService</code> 类的集成测试，使用 Testcontainers 通过容器化的 MySQL 数据库来模拟真实的数据库环境。测试运行在完整的 Spring Boot 上下文中，通过 <code>@SpringBootTest</code> 注解加载所有必要的 Bean。在每次测试之前，通过 <code>@BeforeEach</code> 准备数据，在测试完成后通过 <code>@AfterEach</code> 清理数据库。测试用例 <code>testFindUsersByName</code> 验证了 <code>UserService</code> 的 <code>findUsersByName</code> 方法，确保它能够正确地根据用户名查询到用户。这种集成测试方式确保了 <code>UserService</code> 在实际运行环境中的功能是正确的，并且与数据库的交互正常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Testcontainers</span>  <span class="comment">// 启用 Testcontainers 支持，用于在测试中使用容器化的数据库</span></span><br><span class="line"><span class="meta">@SpringBootTest</span>  <span class="comment">// 运行 Spring Boot 上下文，用于集成测试</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceIT</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Container</span>  <span class="comment">// 定义一个 MySQL 容器，用于在测试过程中模拟真实的 MySQL 数据库</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MySQLContainer&lt;?&gt; mysqlContainer = <span class="keyword">new</span> <span class="title class_">MySQLContainer</span>&lt;&gt;(</span><br><span class="line">        <span class="string">&quot;mysql:8.0.33&quot;</span>).withDatabaseName(<span class="string">&quot;testdb&quot;</span>).withUsername(<span class="string">&quot;testuser&quot;</span>)</span><br><span class="line">        .withPassword(<span class="string">&quot;testpass&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;  <span class="comment">// 注入 UserService 用于测试</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;  <span class="comment">// 注入 UserRepository 用于操作数据库</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamicPropertySource</span>  <span class="comment">// 动态配置测试数据库属性，将容器中的数据库连接信息注入 Spring 的环境配置中</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configureTestDatabase</span><span class="params">(DynamicPropertyRegistry registry)</span> &#123;</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.url&quot;</span>, mysqlContainer::getJdbcUrl);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.username&quot;</span>, mysqlContainer::getUsername);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.password&quot;</span>, mysqlContainer::getPassword);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.driver-class-name&quot;</span>, () -&gt; <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 在每个测试之前准备数据</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tearDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 清理数据库中的数据，确保测试环境的独立性</span></span><br><span class="line">        userRepository.deleteAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFindUsersByName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Arrange - 设置测试数据</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;Jane Doe&quot;</span>, <span class="string">&quot;jane.doe@example.com&quot;</span>);</span><br><span class="line">        userRepository.save(user1);</span><br><span class="line">        userRepository.save(user2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act - 调用 UserService 方法进行查询</span></span><br><span class="line">        List&lt;User&gt; foundUsers = userService.findUsersByName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assert - 验证查询结果是否正确</span></span><br><span class="line">        assertEquals(<span class="number">1</span>, foundUsers.size());</span><br><span class="line">        assertEquals(<span class="string">&quot;John Doe&quot;</span>, foundUsers.get(<span class="number">0</span>).getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>测试 controller 接口类代码</strong></li>
</ol>
<p>下述代码是对 <code>UserController</code> 类的集成测试，使用 <code>TestRestTemplate</code> 来模拟实际的 HTTP 请求和响应。测试运行在完整的 Spring Boot 应用上下文中，并通过 <code>Testcontainers</code> 提供的 MySQL 容器模拟真实的数据库环境。测试用例验证了 API 在查询存在和不存在的用户时的行为，确保 <code>UserController</code> 的 REST API 能够正确返回预期的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Testcontainers</span>  <span class="comment">// 启用 Testcontainers 支持，用于在测试中使用容器化的数据库</span></span><br><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span> <span class="comment">// 启动带有随机端口的 Spring Boot 应用，用于集成测试</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerIT</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Container</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MySQLContainer&lt;?&gt; mysqlContainer = <span class="keyword">new</span> <span class="title class_">MySQLContainer</span>&lt;&gt;(</span><br><span class="line">        <span class="string">&quot;mysql:8.0.33&quot;</span>).withDatabaseName(<span class="string">&quot;testdb&quot;</span>).withUsername(<span class="string">&quot;testuser&quot;</span>)</span><br><span class="line">        .withPassword(<span class="string">&quot;testpass&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;  <span class="comment">// 使用 TestRestTemplate 进行 REST 调用</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;  <span class="comment">// 注入 UserRepository，用于操作数据库</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;  <span class="comment">// 注入 UserService</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamicPropertySource</span>  <span class="comment">// 动态配置测试数据库属性，将容器中的数据库连接信息注入 Spring 的环境配置中</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">configureTestDatabase</span><span class="params">(DynamicPropertyRegistry registry)</span> &#123;</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.url&quot;</span>, mysqlContainer::getJdbcUrl);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.username&quot;</span>, mysqlContainer::getUsername);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.password&quot;</span>, mysqlContainer::getPassword);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.driver-class-name&quot;</span>, () -&gt; <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">        <span class="comment">// 每个测试方法执行前的初始化操作</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        userRepository.deleteAll();  <span class="comment">// 清理数据库中的数据，确保测试环境的独立性</span></span><br><span class="line">        userRepository.save(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>));  <span class="comment">// 添加测试数据</span></span><br><span class="line">        userRepository.save(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;Jane Doe&quot;</span>, <span class="string">&quot;jane.doe@example.com&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGetUsersByName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 使用 TestRestTemplate 调用 API 并获取响应</span></span><br><span class="line">        ResponseEntity&lt;User[]&gt; response = restTemplate.getForEntity(<span class="string">&quot;/api/users/name/John Doe&quot;</span>,</span><br><span class="line">            User[].class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证响应状态码</span></span><br><span class="line">        assertEquals(HttpStatus.OK, response.getStatusCode());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证响应内容</span></span><br><span class="line">        User[] users = response.getBody();</span><br><span class="line">        assertNotNull(users);</span><br><span class="line">        assertEquals(<span class="number">1</span>, users.length);</span><br><span class="line">        assertEquals(<span class="string">&quot;John Doe&quot;</span>, users[<span class="number">0</span>].getName());</span><br><span class="line">        assertEquals(<span class="string">&quot;john.doe@example.com&quot;</span>, users[<span class="number">0</span>].getEmail());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGetUsersByName_NotFound</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 使用 TestRestTemplate 调用 API 并获取响应</span></span><br><span class="line">        ResponseEntity&lt;User[]&gt; response = restTemplate.getForEntity(</span><br><span class="line">            <span class="string">&quot;/api/users/name/Nonexistent User&quot;</span>, User[].class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证响应状态码</span></span><br><span class="line">        assertEquals(HttpStatus.OK, response.getStatusCode());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证响应内容为空</span></span><br><span class="line">        User[] users = response.getBody();</span><br><span class="line">        assertNotNull(users);</span><br><span class="line">        assertEquals(<span class="number">0</span>, users.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行集成测试"><a href="#运行集成测试" class="headerlink" title="运行集成测试"></a>运行集成测试</h3><p>运行集成测试的方法有下面几种：</p>
<ol>
<li><strong>通过 IDE 运行</strong>：右键点击测试类或方法，然后选择 “Run” 或 “Debug” 选项来执行测试。IDE 通常会提供一个测试结果窗口，显示测试通过、失败或被忽略的详细信息。</li>
<li><strong>通过构建工具运行</strong>：例如 <code>mvn verify</code>。</li>
<li><strong>在 CI&#x2F;CD 环境中自动运行</strong>：在持续集成&#x2F;持续交付（CI&#x2F;CD）管道中，测试通常会在每次代码提交后自动运行。CI&#x2F;CD 工具（如 Jenkins、GitLab CI、Travis CI）会在构建过程中执行测试，并根据测试结果决定是否继续后续步骤。</li>
</ol>
<h2 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h2><p><a target="_blank" rel="noopener" href="https://github.com/rongliangtang/Spring-Boot-Demo/tree/main/demo-it">https://github.com/rongliangtang/Spring-Boot-Demo/tree/main/demo-it</a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java-%E5%90%8E%E7%AB%AF/" rel="tag">Java 后端</a></li></ul></div><div class="post-nav"><a class="next" href="/2024/08/27/Java-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%8C%87%E5%8D%97/">Java 单元测试指南</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Java-%E5%90%8E%E7%AB%AF/" style="font-size: 15px;">Java 后端</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/" style="font-size: 15px;">Jupyter 二次开发</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 15px;">教程</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 联系我</i></div><ul></ul><a href="mailto:trl2025@163.com" title="Mail" target="_blank">Mail</a><ul></ul><a href="https://github.com/rongliangtang" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://space.bilibili.com/28159312" title="Bilibili" target="_blank">Bilibili</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 Tom</div></div></div><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>