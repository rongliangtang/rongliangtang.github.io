<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="这是RongLiang的博客,用来分享技术知识和一些感悟。"><title>Java 单元测试指南 | Tom's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java 单元测试指南</h1><a id="logo" href="/.">Tom's Blog</a><p class="description">野蛮生长</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 文章</i></a><a href="/archives/"><i class="fa undefined"> 总览</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java 单元测试指南</h1><div class="post-meta">2024-08-27</div><div class="post-content"><p>在实习的前两周，我主要在熟悉项目并编写单元测试。虽然编写单元测试的工作相对枯燥，但它帮助我养成了良好的编码习惯。高质量、可维护的测试代码对于保障项目的稳定性和可靠性至关重要。</p>
<p>本文不仅介绍了单元测试的规范，还结合实际开发案例，演示了如何编写单元测试。我们使用了 JUnit、H2、Surefire 等常用的单元测试工具。如果你希望深入了解这些工具，可以查阅相关资料。本文基于企业内部实际应用的工作流程，通过教程指导你编写符合规范的单元测试，从而提升代码质量和项目的可靠性。</p>
<span id="more"></span>

<h2 id="单元测试的规范"><a href="#单元测试的规范" class="headerlink" title="单元测试的规范"></a>单元测试的规范</h2><p>下面是从 <a target="_blank" rel="noopener" href="https://github.com/alibaba/p3c">Alibaba Java 开发手册</a> 中总结出来的单元测试规范：</p>
<ol>
<li><strong>AIR 原则</strong></li>
</ol>
<p>  好的单元测试必须遵守 AIR 原则：</p>
<ul>
<li>Automatic（自动化）：单元测试应全自动执行，不需要手动干预。</li>
<li>Independent（独立性）：每个测试用例都是独立的，不依赖其他测试的结果。</li>
<li>Repeatable（可重复）：测试结果应始终如一，无论在什么环境下运行。</li>
</ul>
<ol start="2">
<li><strong>测试粒度要小</strong><br> 单元测试的粒度要足够小，通常测试到类或方法级别，这样可以精确定位问题。跨类或系统的交互逻辑应该在集成测试中处理。</li>
<li><strong>核心代码必须测试</strong><br> 对于关键的业务逻辑和模块，必须编写单元测试，确保其代码在新增或修改后通过所有相关测试。</li>
<li><strong>单元测试代码位置</strong><br> 单元测试代码应放在 src&#x2F;test&#x2F;java 目录下，而不是和业务代码混在一起，以便源码编译时可以跳过这些测试代码。</li>
<li><strong>代码覆盖率要求</strong><br> 单元测试的覆盖率应达到 70% 以上，对于核心模块，语句覆盖率和分支覆盖率应达到 100%。</li>
<li><strong>BCDE 原则</strong><br> 编写测试时应遵循 BCDE 原则：</li>
</ol>
<ul>
<li>Border（边界）：测试边界情况，如循环边界、特殊值等。</li>
<li>Correct（正确）：测试正确的输入和期望的输出。</li>
<li>Design（设计）：根据设计文档编写测试，确保实现与设计一致。</li>
<li>Error（错误）：测试错误输入或异常情况，确保系统能够正确处理。</li>
</ul>
<ol start="7">
<li><p><strong>数据库操作的测试</strong><br>不要假设数据库中存在特定数据，测试时要通过代码准备测试数据。手动插入的数据可能导致测试不可靠。</p>
</li>
<li><p><strong>数据库测试的清理机制</strong><br>数据库相关的测试应设定自动回滚机制，避免测试数据污染数据库，或者使用有特殊前缀的标识来区分测试数据。</p>
</li>
<li><p><strong>代码可测试性</strong><br>对于难以测试的代码，考虑进行重构，使代码更容易进行单元测试，避免为了测试而写出不规范的代码。</p>
</li>
<li><p><strong>确定测试范围</strong><br>在设计评审阶段，开发人员应与测试人员一起确定单元测试的覆盖范围，确保所有重要的用例都被覆盖。</p>
</li>
<li><p><strong>单元测试应在项目发布前完成</strong><br>单元测试作为质量保障的手段，应在项目提测前完成，而不是项目发布后再补充。</p>
</li>
<li><p><strong>编写可测代码</strong><br>为了便于测试，业务代码中应避免构造方法过于复杂、全局变量过多、外部依赖过多、条件语句过多等问题。条件语句可以通过重构来简化。</p>
</li>
<li><p><strong>认识单元测试的重要性</strong><br>单元测试不是测试人员的职责，而是开发人员的责任。单元测试代码也是需要维护的，好的单元测试可以有效减少线上故障的发生。</p>
</li>
</ol>
<p>通过以上总结，你可以更好地理解和应用单元测试的规范，从而编写出高质量的、可维护的测试代码，确保项目的稳定性和可靠性。<strong>特别是单元测试往往会与 CI&#x2F;CD 结合，例如每次在 Githu 申请 PR 后，都会通过 Github Action 执行单元测试，确保合并代码的质量。</strong></p>
<h2 id="单元测试实践"><a href="#单元测试实践" class="headerlink" title="单元测试实践"></a>单元测试实践</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p>下面是目录结构，在 test 文件夹中编写单元测试代码，每个单元测试以 Test 结尾。你会发现单元测试文件和代码文件一一对应。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">demo-ut</span><br><span class="line">├── src</span><br><span class="line">│   ├── main</span><br><span class="line">│   │   ├── java</span><br><span class="line">│   │   │   └── cn</span><br><span class="line">│   │   │       └── tangrl</span><br><span class="line">│   │   │           └── ut</span><br><span class="line">│   │   │               ├── UtApplication.java</span><br><span class="line">│   │   │               ├── controller</span><br><span class="line">│   │   │               │   └── UserController.java</span><br><span class="line">│   │   │               ├── model</span><br><span class="line">│   │   │               │   └── User.java</span><br><span class="line">│   │   │               ├── repository</span><br><span class="line">│   │   │               │   └── UserRepository.java</span><br><span class="line">│   │   │               └── service</span><br><span class="line">│   │   │                   └── UserService.java</span><br><span class="line">│   │   └── resources</span><br><span class="line">│   │       └── application.properties</span><br><span class="line">│   └── test</span><br><span class="line">│       ├── java</span><br><span class="line">│       │   └── cn</span><br><span class="line">│       │       └── tangrl</span><br><span class="line">│       │           └── ut</span><br><span class="line">│       │               ├── controller</span><br><span class="line">│       │               │   └── UserControllerTest.java</span><br><span class="line">│       │               ├── model</span><br><span class="line">│       │               │   └── UserTest.java</span><br><span class="line">│       │               ├── repository</span><br><span class="line">│       │               │   └── UserRepositoryTest.java</span><br><span class="line">│       │               └── service</span><br><span class="line">│       │                   └── UserServiceTest.java</span><br><span class="line">│       └── resources</span><br><span class="line">├── pom.xml</span><br></pre></td></tr></table></figure>

<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>下面是 pom.xml 文件的内容。</p>
<p><strong>我们使用的是 SpringBoot 3.1.12 和 JDK 21。我们使用 MySQL 作为数据库，使用 Spring JPA 作为 ORM。</strong></p>
<p><strong>在 maven 编译的 test 阶段，会使用 h2 内存数据库来代替 MySQL。</strong></p>
<p><strong>在 maven 编译的 build 阶段，会使用 maven-surefire-plugin 来控制单元测试的执行并在 target 文件夹中生成报告。</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 模型版本 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 父项目配置，继承 Spring Boot 的父项目 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- 从仓库中查找父项目 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 项目基础信息 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.tangrl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> <span class="comment">&lt;!-- 项目的组 ID --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ut<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> <span class="comment">&lt;!-- 项目的 artifact ID --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span> <span class="comment">&lt;!-- 项目的版本号 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span> <span class="comment">&lt;!-- 打包类型 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>demo-ut<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!-- 项目名称 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>demo-ut<span class="tag">&lt;/<span class="name">description</span>&gt;</span> <span class="comment">&lt;!-- 项目描述 --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 项目属性配置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>21<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span> <span class="comment">&lt;!-- 指定使用的 Java 版本 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 项目依赖配置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot Starter Web: 提供构建 Web 应用所需的基本依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot Starter Validation: 提供 Bean Validation 支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot Starter Data JPA: 提供 JPA 持久化支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- MySQL Connector: MySQL 数据库驱动 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- H2 Database: 测试时使用的内存数据库 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot Starter Test: 包含 JUnit 5 和 Mockito，提供测试支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 排除 JUnit 4 的支持 (Vintage 引擎) --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Lombok: 用于减少样板代码 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 构建配置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Spring Boot Maven 插件: 提供 Spring Boot 应用打包支持 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- Maven Surefire 插件: 用于运行单元测试 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面是 application.properties 的内容，用于配置 MySQL 和 JPA。如果想要运行代码，不仅仅是跑测试的话，需要创建对应的 test_db 数据库。如果仅仅跑测试的话，不需要使用的 MySQL，在测试的使用使用 H2 内存数据库。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MySQL 数据库连接配置</span></span><br><span class="line"><span class="comment"># 数据库连接 URL，指向本地的 MySQL 数据库 &#x27;test_db&#x27;</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/test_db</span></span><br><span class="line"><span class="comment"># 数据库用户名</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="comment"># 数据库密码</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="comment"># MySQL 数据库驱动类</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># JPA 相关配置</span></span><br><span class="line"><span class="comment"># 自动更新数据库模式，选择 &#x27;update&#x27; 会在应用启动时自动更新数据库结构</span></span><br><span class="line"><span class="attr">spring.jpa.hibernate.ddl-auto</span>=<span class="string">update</span></span><br><span class="line"><span class="comment"># 是否在控制台显示 SQL 语句，&#x27;true&#x27; 表示显示执行的 SQL 语句</span></span><br><span class="line"><span class="attr">spring.jpa.show-sql</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<ol>
<li><strong>创建实体类 <code>User</code></strong></li>
</ol>
<p>实现一个自定义函数，为字段添加相应的限制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Table(name = &quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotBlank(message = &quot;Name is mandatory&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Email(message = &quot;Email should be valid&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 简单的业务逻辑：验证电子邮件格式</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isValidEmail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.email != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.email.matches(<span class="string">&quot;^[A-Za-z0-9+_.-]+@(.+)$&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>创建 Repository 接口 <code>UserRepository</code></strong></li>
</ol>
<p>实现一个自定义的数据库操作方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;User, Long&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义查询方法：根据用户名查找用户</span></span><br><span class="line">    <span class="meta">@Query(&quot;SELECT u FROM User u WHERE u.name = :name&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">findByName</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>创建 Service 层 <code>UserService</code></strong></li>
</ol>
<p>实现一个 service 方法，供 controller 接口使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据姓名查找用户</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">findUsersByName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findByName(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建 Controller 层 <code>UserController</code></li>
</ol>
<p>实现一个根据姓名查找用户的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据姓名查找用户</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUsersByName</span><span class="params">(<span class="meta">@PathVariable</span> String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUsersByName(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编写单元测试"><a href="#编写单元测试" class="headerlink" title="编写单元测试"></a>编写单元测试</h3><p>下面着重介绍如何实现每个代码文件的单元测试。</p>
<ol>
<li><strong>测试 <code>User</code> 实体类</strong></li>
</ol>
<p><strong>因为我们实现的实体类，包括自定义方法和相关限制，所以需要对其进行相关的测试。否则一般简单的实体类不需要测试。</strong></p>
<p>下面代码通过 JUnit 5 对 <code>User</code> 类的邮箱格式验证和名称字段进行了单元测试，验证了在不同情况下（如有效或无效邮箱、空白或非空名称）类的方法是否表现正确。这些测试确保了 <code>User</code> 类在处理用户输入时的核心逻辑是可靠的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testValidEmail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 测试有效的邮箱地址</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        assertTrue(user.isValidEmail(), <span class="string">&quot;Email should be valid&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testInvalidEmail</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 测试无效的邮箱地址</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doeexample.com&quot;</span>);</span><br><span class="line">        assertFalse(user.isValidEmail(), <span class="string">&quot;Email should be invalid&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testBlankName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 测试空白名称的情况</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        assertTrue(user.getName().isEmpty(), <span class="string">&quot;Name should be empty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testNotBlankName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 测试非空名称的情况</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        assertFalse(user.getName().isEmpty(), <span class="string">&quot;Name should not be empty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>测试 <code>UserRepository</code></strong></li>
</ol>
<p><strong>因为我们在 repository 中实现了自定义的数据库操作方法，所以需要对其进行测试。否则，repository 不需要进行测试。</strong></p>
<p>下面代码是 <code>UserRepository</code> 的单元测试，使用 JPA 测试环境在内存数据库（H2）中验证 <code>findByName</code> 方法的功能。通过设置动态数据库配置，代码首先保存了两个用户对象，然后分别查找名为 “John Doe” 和 “Jane Doe” 的用户，并验证返回的用户列表是否正确。这种测试确保了 <code>UserRepository</code> 在处理数据库查询时的正确性和一致性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DataJpaTest</span>  <span class="comment">// 使用此注解，进行 JPA 相关的测试，优先加载 h2 内存数据库</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepositoryTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;  <span class="comment">// 注入 UserRepository 进行测试</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@DynamicPropertySource</span>  <span class="comment">// 动态设置测试环境下的数据库相关属性，设置使用 h2 内存数据库</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(DynamicPropertyRegistry registry)</span> &#123;</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.driver-class-name&quot;</span>, () -&gt; <span class="string">&quot;org.h2.Driver&quot;</span>);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.url&quot;</span>,</span><br><span class="line">            () -&gt; <span class="string">&quot;jdbc:h2:mem:testdb;MODE=MySQL;DB_CLOSE_DELAY=-1;DATABASE_TO_LOWER=true&quot;</span>);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.username&quot;</span>, () -&gt; <span class="string">&quot;sa&quot;</span>);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.datasource.password&quot;</span>, () -&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        registry.add(<span class="string">&quot;spring.jpa.hibernate.ddl-auto&quot;</span>, () -&gt; <span class="string">&quot;create-drop&quot;</span>);</span><br><span class="line">        registry.add(<span class="string">&quot;spring.jpa.properties.hibernate.dialect&quot;</span>,</span><br><span class="line">            () -&gt; <span class="string">&quot;org.hibernate.dialect.H2Dialect&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFindByName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Arrange - 设置测试数据</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, <span class="string">&quot;Jane Doe&quot;</span>, <span class="string">&quot;jane.doe@example.com&quot;</span>);</span><br><span class="line">        userRepository.save(user1);</span><br><span class="line">        userRepository.save(user2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act - 执行查询操作</span></span><br><span class="line">        List&lt;User&gt; johns = userRepository.findByName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line">        List&lt;User&gt; janes = userRepository.findByName(<span class="string">&quot;Jane Doe&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assert - 验证查询结果</span></span><br><span class="line">        assertEquals(<span class="number">1</span>, johns.size(), <span class="string">&quot;Should find one John Doe&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;John Doe&quot;</span>, johns.get(<span class="number">0</span>).getName());</span><br><span class="line"></span><br><span class="line">        assertEquals(<span class="number">1</span>, janes.size(), <span class="string">&quot;Should find one Jane Doe&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;Jane Doe&quot;</span>, janes.get(<span class="number">0</span>).getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>测试 <code>UserService</code></strong></li>
</ol>
<p><strong>service 中的方法是必须要测试的。</strong></p>
<p>下面代码是 <code>UserService</code> 类的单元测试，使用了 Mockito 来模拟 <code>UserRepository</code> 的依赖。测试中首先设置了模拟的行为，让 <code>userRepository.findByName(&quot;John Doe&quot;)</code> 返回一个包含 <code>John Doe</code> 用户的列表。然后调用 <code>UserService</code> 的 <code>findUsersByName</code> 方法，并验证返回的用户列表是否正确，确保返回的用户数量和名称符合预期。此外，测试还验证了 <code>findByName</code> 方法在 <code>UserRepository</code> 中是否被正确调用了一次。通过这种方式，测试确保了 <code>UserService</code> 的逻辑在没有真实数据库依赖的情况下也能被验证。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;  <span class="comment">// 注入 UserService 实例用于测试</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;  <span class="comment">// 模拟 UserRepository 依赖</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setUp</span><span class="params">()</span> &#123;</span><br><span class="line">        MockitoAnnotations.openMocks(<span class="built_in">this</span>);  <span class="comment">// 初始化 Mockito 注解</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testFindUsersByName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// Arrange - 设置测试数据和模拟行为</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        when(userRepository.findByName(<span class="string">&quot;John Doe&quot;</span>)).thenReturn(List.of(user));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act - 调用被测试的方法</span></span><br><span class="line">        List&lt;User&gt; users = userService.findUsersByName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assert - 验证结果和方法调用次数</span></span><br><span class="line">        assertEquals(<span class="number">1</span>, users.size(), <span class="string">&quot;Should return one user&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;John Doe&quot;</span>, users.get(<span class="number">0</span>).getName());</span><br><span class="line">        verify(userRepository, times(<span class="number">1</span>)).findByName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>测试 <code>UserController</code></strong></li>
</ol>
<p><strong>controller 中的接口也是必须要测试的。</strong></p>
<p>下述代码是对 <code>UserController</code> 类的单元测试，使用了 Spring 的 <code>@WebMvcTest</code> 注解来测试 Web 层的行为。通过 <code>MockMvc</code> 模拟 HTTP 请求，并使用 <code>@MockBean</code> 来模拟 <code>UserService</code> 的依赖。测试中设置了模拟行为，使得当请求 <code>UserService.findUsersByName(&quot;John Doe&quot;)</code> 时返回一个包含 “John Doe” 的用户列表。然后，通过 <code>MockMvc</code> 模拟发送 GET 请求到 <code>/api/users/name/John Doe</code>，并验证返回的状态码为 200 OK，同时检查响应的 JSON 数据中是否正确包含用户的名称和邮箱地址。这种测试方式确保了 <code>UserController</code> 在处理 HTTP 请求时的行为正确性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebMvcTest(UserController.class)</span>  <span class="comment">// 仅加载与 UserController 相关的 Web 层组件进行测试</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControllerTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;  <span class="comment">// 注入 MockMvc 用于模拟 HTTP 请求</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;  <span class="comment">// 模拟 UserService 依赖</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGetUsersByName</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Arrange - 设置测试数据和模拟行为</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;john.doe@example.com&quot;</span>);</span><br><span class="line">        when(userService.findUsersByName(<span class="string">&quot;John Doe&quot;</span>)).thenReturn(List.of(user));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Act &amp; Assert - 模拟 GET 请求并验证响应</span></span><br><span class="line">        mockMvc.perform(get(<span class="string">&quot;/api/users/name/John Doe&quot;</span>))</span><br><span class="line">            .andExpect(status().isOk())  <span class="comment">// 期望状态码为 200 OK</span></span><br><span class="line">            .andExpect(jsonPath(<span class="string">&quot;$[0].name&quot;</span>).value(<span class="string">&quot;John Doe&quot;</span>))  <span class="comment">// 验证 JSON 响应中的 name 字段</span></span><br><span class="line">            .andExpect(</span><br><span class="line">                jsonPath(<span class="string">&quot;$[0].email&quot;</span>).value(<span class="string">&quot;john.doe@example.com&quot;</span>));  <span class="comment">// 验证 JSON 响应中的 email 字段</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行单元测试"><a href="#运行单元测试" class="headerlink" title="运行单元测试"></a>运行单元测试</h3><p>运行单元测试的方法有下面几种：</p>
<ol>
<li><strong>通过 IDE 运行</strong>：右键点击测试类或方法，然后选择 “Run” 或 “Debug” 选项来执行测试。IDE 通常会提供一个测试结果窗口，显示测试通过、失败或被忽略的详细信息。</li>
<li><strong>通过构建工具运行</strong>：例如 <code>mvn test</code>。</li>
<li><strong>在 CI&#x2F;CD 环境中自动运行</strong>：在持续集成&#x2F;持续交付（CI&#x2F;CD）管道中，测试通常会在每次代码提交后自动运行。CI&#x2F;CD 工具（如 Jenkins、GitLab CI、Travis CI）会在构建过程中执行测试，并根据测试结果决定是否继续后续步骤。</li>
</ol>
<h2 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h2><p><a target="_blank" rel="noopener" href="https://github.com/rongliangtang/Spring-Boot-Demo/tree/main/demo-ut">https://github.com/rongliangtang/Spring-Boot-Demo/tree/main/demo-ut</a></p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java-%E5%90%8E%E7%AB%AF/" rel="tag">Java 后端</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/08/27/Java-%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%E6%8C%87%E5%8D%97/">Java 集成测试指南</a><a class="next" href="/2024/08/26/%E5%8A%A8%E6%89%8B%E7%BB%83%E4%B9%A0-Helm/">动手练习 Helm</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/K8s/" style="font-size: 15px;">K8s</a> <a href="/tags/Java-%E5%90%8E%E7%AB%AF/" style="font-size: 15px;">Java 后端</a> <a href="/tags/Jupyter-%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91/" style="font-size: 15px;">Jupyter 二次开发</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a> <a href="/tags/%E6%95%99%E7%A8%8B/" style="font-size: 15px;">教程</a> <a href="/tags/%E6%84%9F%E6%82%9F/" style="font-size: 15px;">感悟</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 联系我</i></div><ul></ul><a href="mailto:trl2025@163.com" title="Mail" target="_blank">Mail</a><ul></ul><a href="https://github.com/rongliangtang" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://space.bilibili.com/28159312" title="Bilibili" target="_blank">Bilibili</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 Tom</div></div></div><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>